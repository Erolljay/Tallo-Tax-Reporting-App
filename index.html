<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tallo Tax Reporting</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* gray-100 */
        }
        /* Style for active main tab */
        .main-tab-active {
            border-bottom-color: #1d4ed8; /* blue-700 */
            color: #1d4ed8;
            font-weight: 600;
        }
        /* Styling for main tab content areas */
        .main-tab-content {
            margin-top: 1.5rem;
            padding: 1.5rem;
            background-color: #ffffff;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        /* Helper class to hide elements */
        .hidden {
            display: none;
        }
        /* Styling for input fields */
        label {
             display: block;
             margin-bottom: 0.25rem;
             font-size: 0.875rem; /* text-sm */
             font-weight: 500; /* font-medium */
             color: #374151; /* gray-700 */
        }
        /* Specific label styling for checkboxes/radios */
        label.option-label {
            display: inline-flex; /* Align checkbox/radio and text */
            align-items: center;
            margin-bottom: 0; /* Remove bottom margin for these labels */
            margin-left: 0.5rem; /* Add space between control and label text */
            font-weight: 400; /* Normal weight */
            cursor: pointer; /* Indicate clickable */
        }
         /* Style for disabled labels */
        input[type="radio"]:disabled + label.option-label,
        input[type="checkbox"]:disabled + label.option-label {
            cursor: not-allowed;
            color: #9ca3af; /* gray-400 */
        }
        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            box-shadow: inset 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
         input[type="checkbox"], input[type="radio"] {
             height: 1rem; /* h-4 */
             width: 1rem; /* w-4 */
             border-color: #9ca3af; /* gray-400 */
             text-indigo-600; /* Focus color */
             focus:ring-indigo-500;
             cursor: pointer;
         }
          input[type="radio"] {
              border-radius: 50%;
          }
          input[type="checkbox"] {
              border-radius: 0.25rem; /* rounded */
          }
         input[type="checkbox"]:disabled, input[type="radio"]:disabled {
             background-color: #e5e7eb; /* gray-200 */
             border-color: #d1d5db; /* gray-300 */
             cursor: not-allowed;
         }
        input[type="text"]:focus, input[type="number"]:focus, select:focus, textarea:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #2563eb;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        textarea {
             min-height: 120px;
             white-space: pre; /* Preserve spaces/tabs in placeholder */
             overflow-wrap: normal;
             overflow-x: scroll;
             font-family: monospace; /* Use monospace font for better alignment */
             font-size: 0.8rem;
        }
        /* Styling for Filter Section */
        .filter-section {
            display: flex;
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 1rem; /* Space between filter items */
            padding-bottom: 1.5rem; /* Space below filters */
            margin-bottom: 1.5rem; /* Space below filters */
            border-bottom: 1px solid #e5e7eb; /* gray-200 */
        }
        .filter-item {
            flex: 1; /* Allow items to grow */
            min-width: 150px; /* Minimum width for each filter */
        }
        /* Styling for Output Layout (Sidebar + Content) */
        .output-layout {
            display: flex;
            flex-direction: column; /* Stack on small screens */
            gap: 1.5rem; /* Space between sidebar and content */
        }
        @media (min-width: 768px) { /* md breakpoint */
             .output-layout {
                flex-direction: row; /* Side-by-side on medium screens and up */
             }
        }
        /* Sidebar Width */
        .output-sidebar { /* Applied via class in HTML */ }

        .output-sidebar nav button {
            display: block; width: 100%; padding: 0.6rem 1rem; margin-bottom: 0.5rem;
            text-align: left; font-size: 0.875rem; color: #374151; border-radius: 0.375rem;
            background-color: #f9fafb; border: 1px solid #e5e7eb;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out;
        }
         /* Style for hidden sidebar buttons */
         .output-sidebar nav button.hidden {
             display: none;
         }
        .output-sidebar nav button:hover { background-color: #f3f4f6; }
        .output-sidebar nav button.sidebar-active {
            background-color: #e0e7ff; color: #3730a3; font-weight: 600; border-color: #c7d2fe;
        }
        /* Content Area */
        .output-content-area {
            flex-grow: 1; border: 1px solid #e5e7eb; padding: 1.5rem;
            border-radius: 0.5rem; background-color: #f9fafb; min-height: 400px;
        }
         /* Report Header Info */
         .report-header-info {
             margin-bottom: 1rem;
             padding-bottom: 1rem;
             border-bottom: 1px dashed #d1d5db; /* gray-300 */
             font-size: 0.875rem; /* text-sm */
             color: #4b5563; /* gray-600 */
         }
         .report-header-info p { margin-bottom: 0.25rem; }
         .report-header-info strong { color: #1f2937; } /* gray-800 */

         /* Report Action Buttons */
         .report-actions {
             margin-top: 1.5rem; /* Add space above buttons */
             margin-bottom: 1.5rem;
             display: flex;
             gap: 0.75rem; /* space-x-3 */
         }
         .report-actions button {
             padding: 0.5rem 1rem; /* py-2 px-4 */
             font-size: 0.875rem; /* text-sm */
             font-weight: 500; /* font-medium */
             border-radius: 0.375rem; /* rounded-md */
             border: 1px solid transparent;
             cursor: pointer;
             transition: background-color 0.2s ease;
         }
          /* Disable styling for buttons */
         .report-actions button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
         }
         .print-button {
             background-color: #10b981; /* emerald-500 */
             color: white;
             border-color: #059669; /* emerald-600 */
         }
         .print-button:hover:not(:disabled) { background-color: #059669; }
         .copy-button {
             background-color: #3b82f6; /* blue-500 */
             color: white;
             border-color: #2563eb; /* blue-600 */
         }
         .copy-button:hover:not(:disabled) { background-color: #2563eb; }
         /* Recalculate button style */
         .recalculate-button {
             background-color: #f97316; /* orange-500 */
             color: white;
             border-color: #ea580c; /* orange-600 */
         }
         .recalculate-button:hover { background-color: #ea580c; }


        /* Summary Boxes */
        .summary-box {
            margin-top: 0; margin-bottom: 1.5rem; padding: 1rem; border-radius: 0.5rem;
            display: flex; justify-content: space-around; flex-wrap: wrap; gap: 1rem;
        }
        .qap-summary-box { background-color: #eef2ff; border: 1px solid #c7d2fe; }
        .slp-summary-box { background-color: #f0fdf4; border: 1px solid #bbf7d0; }
        .sls-summary-box { background-color: #fffbeb; border: 1px solid #fde68a; }
        .sawt-summary-box { background-color: #fef2f2; border: 1px solid #fecaca; }
        .payroll-summary-box { background-color: #f5f3ff; border: 1px solid #ddd6fe; }

        .summary-item { text-align: center; }
        .summary-item span { display: block; font-size: 0.875rem; margin-bottom: 0.25rem; }
        .qap-summary-item span { color: #4338ca; } .slp-summary-item span { color: #15803d; }
        .sls-summary-item span { color: #b45309; } .sawt-summary-item span { color: #b91c1c; }
        .payroll-summary-item span { color: #6d28d9; }

        .summary-item strong { display: block; font-size: 1.25rem; font-weight: 600; }
        .qap-summary-item strong { color: #312e81; } .slp-summary-item strong { color: #14532d; }
        .sls-summary-item strong { color: #78350f; } .sawt-summary-item strong { color: #7f1d1d; }
        .payroll-summary-item strong { color: #4c1d95; }

        /* Basic Table Styling */
        .results-table-wrapper { overflow-x: auto; margin-top: 1rem; } /* Ensure table scrolls */
        .results-table {
            width: 100%; border-collapse: collapse; font-size: 0.875rem;
        }
        .results-table th, .results-table td {
            border: 1px solid #d1d5db; padding: 0.5rem 0.75rem; text-align: left; white-space: nowrap;
        }
        .results-table th {
            background-color: #f3f4f6; font-weight: 600; position: sticky; top: 0; z-index: 10;
        }
        .results-table tbody tr:nth-child(even) { background-color: #ffffff; }
        .results-table tbody tr:nth-child(odd) { background-color: #f9fafb; }
        .results-table td.number { text-align: right; }
        .results-table tfoot { font-weight: 600; background-color: #e5e7eb; }
        .results-table tfoot td { border-top: 2px solid #9ca3af; }
        /* Payroll Table Specific Styles */
        .payroll-sub-header th {
            background-color: #e5e7eb; font-size: 0.8rem; font-weight: 500;
            padding-top: 0.3rem; padding-bottom: 0.3rem;
        }
        /* Return Computation Styles */
        .return-computation { margin-top: 1.5rem; }
        .return-computation dl { margin-bottom: 1rem; padding: 0.75rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #fff; }
        .return-computation dl dd { /* Reset browser default for dd */
            margin-left: 0;
        }
        .return-computation div.computation-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.35rem; padding: 0.1rem 0; clear: both; flex-wrap: wrap; }

        /* Styles for dt and label within computation rows */
        .return-computation dt.label,
        .return-computation label.label { /* Applied to label elements for input rows */
            font-weight: 500; color: #374151; padding-right: 10px; text-align: left; flex-basis: 60%; margin-bottom: 0.2rem;
        }
        /* Styles for dd and input.value-input within computation rows */
        .return-computation dd.value,
        .return-computation input.value-input,
        .return-computation dd > input.value-input { /* Covers inputs directly in dd */
            text-align: right; font-weight: 500; flex-grow: 1; min-width: 120px;
        }
        .return-computation input.value-input { padding: 0.25rem 0.5rem; max-width: 150px; border: 1px solid #d1d5db; border-radius: 0.25rem; text-align: right; font-size: 0.875rem; font-weight: 500; margin-left: auto; }
        .return-computation dd.value.total { font-weight: bold; border-top: 1px solid #9ca3af; padding-top: 0.25rem; margin-top: 0.25rem; color: #111827; }
        .return-computation div.computation-row.sub-item dt.label,
        .return-computation div.computation-row.sub-item label.label { padding-left: 15px; font-weight: 400; }
        .return-computation div.computation-row.sub-item dd.value,
        .return-computation div.computation-row.sub-item input.value-input,
        .return-computation div.computation-row.sub-item dd > input.value-input { font-weight: 400; }
        .return-computation div.computation-row.input-row { align-items: baseline; margin-bottom: 0.5rem; }
        .return-computation div.computation-row.input-row dt.label,
        .return-computation div.computation-row.input-row label.label { flex-basis: auto; margin-bottom: 0; align-self: center; font-weight: 400; padding-left: 15px; }
        .return-computation div.computation-row.input-row dt.label.carry-over-label,
        .return-computation div.computation-row.input-row label.label.carry-over-label { padding-left: 0; }
        .return-computation div.computation-row.input-row input.value-input,
        .return-computation div.computation-row.input-row dd > input.value-input { margin-left: 1rem; font-weight: 400; }
        .return-computation div.computation-group { margin-bottom: 0rem; margin-top: 0.5rem; }
        .return-computation div.computation-group-title { font-weight: 600; margin-bottom: 0.5rem; font-size: 0.875rem; color: #4b5563; padding-bottom: 0.25rem; border-bottom: 1px dashed #d1d5db; }
        .return-computation .recalculate-button-wrapper { display: flex; justify-content: flex-end; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .return-computation div.computation-row.total-row dt.label,
        .return-computation div.computation-row.total-row dd.value,
        .return-computation div.computation-row.total-row label.label { font-weight: bold; border-top: 1px solid #9ca3af; padding-top: 0.25rem; margin-top: 0.25rem; color: #111827; }
        .return-computation .section-title { font-weight: 600; margin-bottom: 0.5rem; font-size: 1rem; color: #1f2937; }
        .return-computation .sub-section-title { font-weight: 600; margin-top: 1.5rem; margin-bottom: 0.5rem; font-size: 0.9rem; color: #4b5563; padding-bottom: 0.25rem; border-bottom: 1px dashed #d1d5db;} /* Style for supporting details heading */
        /* Table for ATC breakdown / VAT Breakdown */
        .return-atc-table { width: 100%; margin-bottom: 1rem; border: 1px solid #e5e7eb; border-collapse: collapse; font-size: 0.875rem; background-color: #fff;}
        .return-atc-table th, .return-atc-table td { border: 1px solid #d1d5db; padding: 0.4rem 0.6rem; text-align: left; }
        .return-atc-table th { background-color: #f9fafb; font-weight: 600; }
        .return-atc-table td.number { text-align: right; }
         /* Subtotal Row Style */
        .results-table tbody tr.subtotal-row td { font-weight: 600; background-color: #f0f9ff; border-top: 1px solid #9ca3af; }
        /* Manual Input Section Styles */
        .manual-input-section { margin-top: 1rem; padding: 1rem; border: 1px dashed #a5b4fc; border-radius: 0.5rem; background-color: #f5f3ff; }
        .manual-input-section label, .manual-input-section dt.label { font-size: 0.8rem; color: #4338ca; }
        .manual-input-section input[type="number"] { padding: 0.4rem; font-size: 0.875rem; text-align: right; }
        /* Styles for ITR Validation Display */
         .validation-info { font-size: 0.75rem; padding: 0.5rem; margin-top: 0.5rem; border: 1px solid #e5e7eb; border-radius: 0.375rem; background-color: #f9fafb; }
         .validation-info .computation-row { margin-bottom: 0.1rem; padding: 0; }
         .validation-info dt.label,
         .validation-info label.label {
            color: #4b5563; font-weight: 400; flex-basis: 50%; margin-bottom: 0; font-size: inherit;
         }
         .validation-info dd.value,
         .validation-info span.value {
            font-weight: 600; font-size: inherit;
         }
         .validation-balance.ok { color: #059669; }
         .validation-balance.mismatch { color: #f97316; font-weight: bold;}
         .validation-info .pool-title { font-weight: 600; margin-top: 0.75rem; color: #374151; font-size: 0.8rem; }
        /* ITR Exception Item Section Styles */
         .exception-items-section { margin-top: 1.5rem; margin-bottom: 1rem; padding: 1rem; border: 1px dashed #fdba74; border-radius: 0.5rem; background-color: #fffbeb; }
         .exception-items-section .computation-group-title { color: #b45309; border-color: #fed7aa;}
         .exception-items-section .exception-item-row { display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
         .exception-items-section .exception-item-row .label { flex-basis: 100px; flex-shrink: 0; text-align: right; font-weight: 500; font-size: 0.8rem; color: #92400e; padding-right: 0; margin-bottom: 0; }
         .exception-items-section .exception-item-row input[type="text"] { flex-grow: 1; max-width: none; min-width: 200px; font-size: 0.8rem; padding: 0.3rem 0.5rem; }
         .exception-items-section .exception-item-row input[type="number"] { max-width: 150px; /* Keep amount field size consistent */ }

        /* Data Management Section Styles */
        .data-management-section { margin-bottom: 2rem; padding: 1rem; border: 1px solid #d1d5db; background-color: #f9fafb; border-radius: 0.5rem; }
        .data-management-section h3 { font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; }
        .data-management-grid { display: grid; grid-template-columns: repeat(1, minmax(0, 1fr)); gap: 1.5rem; }
        @media (min-width: 768px) { .data-management-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); } }
         @media (min-width: 1024px) { .data-management-grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
        .data-control-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .data-control-group label { margin-bottom: 0.1rem; }
        .data-control-group input[type="number"], .data-control-group select { max-width: 150px; }
        .data-control-group button, .data-control-group label.button-like { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem; border: 1px solid #d1d5db; cursor: pointer; transition: background-color 0.2s ease; background-color: #ffffff; color: #374151; text-align: center; display: inline-block; width: auto; }
        .data-control-group button:hover, .data-control-group label.button-like:hover { background-color: #f3f4f6; }
        .save-button { background-color: #10b981; color: white; border-color: #059669; } .save-button:hover { background-color: #059669; }
        .load-button { background-color: #3b82f6; color: white; border-color: #2563eb; } .load-button:hover { background-color: #2563eb; }
        .clear-button { background-color: #ef4444; color: white; border-color: #dc2626; } .clear-button:hover { background-color: #dc2626; }
        #load-status { font-size: 0.8rem; color: #4b5563; margin-top: 0.5rem; min-height: 1.2em; }
        /* Placeholder styles for future DAT file generation area */
        #dat-file-generation-area {
            margin-top: 1.5rem;
            padding: 1rem;
            border: 1px dashed #d1d5db; /* gray-300 */
            border-radius: 0.5rem;
            background-color: #f9fafb; /* gray-50 */
        }
        #dat-file-generation-area h4 {
            font-size: 1rem;
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.75rem;
        }
        #dat-file-generation-area button {
            background-color: #6b7280; /* gray-500 */
            color: white;
            border-color: #4b5563; /* gray-600 */
            opacity: 0.7;
            cursor: not-allowed;
        }

        /* Settings Action Buttons */
        .settings-actions { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #e5e7eb; display: flex; gap: 0.75rem; justify-content: flex-end; }
        .settings-actions button, .settings-actions label { padding: 0.5rem 1rem; font-size: 0.875rem; font-weight: 500; border-radius: 0.375rem; border: 1px solid #d1d5db; cursor: pointer; transition: background-color 0.2s ease; background-color: #ffffff; color: #374151; }
        .settings-actions button:hover, .settings-actions label:hover { background-color: #f9fafb; }
        .settings-actions .export-button { background-color: #10b981; color: white; border-color: #059669; }
        .settings-actions .export-button:hover { background-color: #059669; }

        /* Benchmark Analysis Styles */
        .benchmark-analysis { margin-top: 1.5rem; padding-top: 1rem; border-top: 1px dashed #d1d5db; }
        .benchmark-analysis h5.computation-group-title { /* Use existing class for consistency */
            font-size: 0.9rem;
            color: #374151; /* Slightly darker for emphasis */
            margin-bottom: 0.75rem;
            padding-bottom: 0.25rem;
            border-bottom: 1px solid #e0e7ff; /* Lighter blue border */
        }
        .benchmark-analysis .computation-row { margin-bottom: 0.2rem; } /* Tighter spacing */
        .benchmark-analysis dt.label { font-weight: normal; color: #4b5563; flex-basis: 70%; } /* Standard label, more space for text */
        .benchmark-analysis dd.value { font-weight: 500; }
        .benchmark-ok { color: #059669 !important; /* emerald-600 */ }
        .benchmark-low { color: #ef4444 !important; /* red-500 */ }
        .benchmark-analysis dd.value.benchmark-ok::before { content: "✓ "; }
        .benchmark-analysis dd.value.benchmark-low::before { content: "✗ "; }


        /* Print Styles */
        @media print {
            body, .printable-area {
                text-size-adjust: none;
                -webkit-text-size-adjust: none;
                -moz-text-size-adjust: none;
                -ms-text-size-adjust: none;
            }
            body * { visibility: hidden; } .printable-area, .printable-area * { visibility: visible; } .printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 0; margin: 0; border: none; background-color: white !important; }
            .main-tab-button, .filter-section, .output-sidebar, .report-actions, .settings-actions, .recalculate-button, .manual-input-section, .validation-info, .data-management-section, #dat-file-generation-area,
            .exception-items-section input[type="text"], .exception-items-section input[type="number"] /* Hide input fields in exceptions */
             { display: none !important; }

            /* Exception Items Print Style */
            .exception-items-section { border: 1px dashed #ccc !important; background: #eee !important; visibility: visible !important; page-break-inside: avoid; margin-top: 1rem; padding: 0.5rem;}
            .exception-items-section * { visibility: visible !important; }
            .exception-items-section .computation-group-title { font-size: 9pt !important; border-bottom: 1px solid #ddd !important; }
            .exception-items-section .exception-item-row { visibility: visible !important; display: block !important; margin-bottom: 0.3rem !important; }
            .exception-items-section .exception-item-row .label { display: inline !important; font-size: 8pt !important; margin-right: 5px;}
            .exception-items-section .exception-item-row::after { content: "Desc: " attr(data-print-desc) " | Amount: " attr(data-print-amount); display: inline !important; font-size: 8pt; visibility: visible !important; margin-left: 5px;}

            .printable-area input[type="number"].value-input { border: none !important; background: none !important; padding: 0.25rem 0.5rem; text-align: right; visibility: visible !important; font-weight: inherit !important; display: inline-block !important; box-shadow: none !important; -webkit-appearance: none; margin: 0; appearance: none; }
            .printable-area input[type="checkbox"] { display: none !important; } .printable-area .computation-row.input-row label { visibility: visible !important; } .printable-area div.computation-group, .printable-area div.computation-row.input-row { border: none; padding: 0; margin-bottom: 0.35rem; } .printable-area .recalculate-button-wrapper { display: none !important; }
            #settings-content.printable-area .grid { display: block !important; } #settings-content.printable-area legend { font-weight: bold; margin-top: 1em; } #settings-content.printable-area input[type="radio"] + label, #settings-content.printable-area input[type="checkbox"] + label { display: inline-block; margin-left: 5px;} #settings-content, #returns-content, #reports-content { margin-top: 0; box-shadow: none; border: none; }
            .results-table th, .return-atc-table th { position: static; background-color: #eee !important; } .results-table, .return-atc-table { font-size: 8pt; } .results-table th, .results-table td, .return-atc-table th, .return-atc-table td { padding: 0.2rem 0.4rem; } .results-table-wrapper { overflow: visible; }
            .summary-box { border: 1px solid #ccc; background-color: #eee !important; page-break-inside: avoid; }
            .report-header-info { border-bottom: none; margin-bottom: 0.5rem; page-break-before: avoid; } .payroll-sub-header th { background-color: #f0f0f0 !important; } .results-table tbody tr:nth-child(even), .results-table tbody tr:nth-child(odd) { background-color: white !important; } .results-table tfoot { background-color: #eee !important; }
            .return-computation dl { border: none; padding: 0; font-size: 9pt; } .return-computation div.computation-row { display: flex !important; }
            .return-computation dt.label, .return-computation label.label { float: none; width: auto; flex-basis: auto !important; }
            .return-computation dd.value { margin-left: 0; }
            .return-computation dd.value.total { border-top: 1px solid #000; }
            .return-atc-table { margin-bottom: 0.5rem; } .results-table tbody tr.subtotal-row td { background-color: #f0f0f0 !important; } .validation-message { display: none; }
             .return-computation .sub-section-title { visibility: visible; font-size: 10pt; border-bottom: 1px solid #ccc; }
             .supporting-details { page-break-before: auto; visibility: visible !important;}
             .supporting-details > * { visibility: visible !important; }
             .supporting-details .summary-box { margin-top: 0.5rem;}
             .supporting-details .results-table-wrapper { margin-top: 0.5rem; }
             .supporting-details h5 { font-weight: bold; margin-top: 1em; font-size: 9pt; visibility: visible !important;}
            /* Benchmark Print Styles */
            .benchmark-analysis { border-top: 1px dashed #ccc !important; padding-top: 0.5rem !important; margin-top: 1rem !important; visibility: visible !important; page-break-inside: avoid;}
            .benchmark-analysis * { visibility: visible !important; }
            .benchmark-analysis h5.computation-group-title { font-size: 9pt !important; border-bottom: 1px solid #ddd !important; }
            .benchmark-analysis .computation-row { margin-bottom: 0.1rem !important; }
            .benchmark-analysis dt.label { font-size: 8pt !important; }
            .benchmark-analysis dd.value { font-size: 8pt !important; }
            .benchmark-ok { color: green !important; }
            .benchmark-low { color: red !important; }
            .benchmark-analysis dd.value.benchmark-ok::before,
            .benchmark-analysis dd.value.benchmark-low::before { display: inline !important; } /* Ensure symbols print */
        }

    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">

        <header class="mb-6 pb-4 bg-white p-6 rounded-lg shadow-md">
            <h1 class="text-2xl font-bold text-gray-800">Tax Reporting Application</h1>
            <p class="text-sm text-gray-600">Configure settings, input data, and generate Philippine tax reports and returns.</p>
        </header>

        <div class="border-b border-gray-300 bg-white p-4 rounded-t-lg shadow-md">
            <nav class="-mb-px flex flex-wrap space-x-8" aria-label="Main Tabs">
                 <button class="main-tab-button py-3 px-1 border-b-2 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:border-gray-400" data-target="settings-content">1. Settings</button>
                 <button class="main-tab-button py-3 px-1 border-b-2 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:border-gray-400" data-target="input-data-content">2. Input Data</button>
                 <button class="main-tab-button py-3 px-1 border-b-2 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:border-gray-400" data-target="returns-content">3. Generated Returns</button>
                 <button class="main-tab-button py-3 px-1 border-b-2 border-transparent text-base font-medium text-gray-600 hover:text-gray-800 hover:border-gray-400" data-target="reports-content">4. Generated Reports</button>
            </nav>
        </div>

        <div id="main-content-container">

            <!-- Settings Tab -->
            <div id="settings-content" class="main-tab-content">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Taxpayer Information & Settings</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900">Taxpayer Details</h3>
                        <div><label for="taxpayer-name">Taxpayer Name</label><input type="text" id="taxpayer-name" name="taxpayer-name" placeholder="Juan Dela Cruz or ABC Corporation"></div>
                        <div><label for="taxpayer-tin">Taxpayer Identification Number (TIN)</label><input type="text" id="taxpayer-tin" name="taxpayer-tin" placeholder="000-000-000-000"></div>
                        <div><label for="taxpayer-address">Registered Address</label><textarea id="taxpayer-address" name="taxpayer-address" rows="3" placeholder="Unit/Floor, Building, Street, Barangay"></textarea></div>
                        <div><label for="taxpayer-zip">Zip Code</label><input type="text" id="taxpayer-zip" name="taxpayer-zip" placeholder="e.g., 1000"></div>
                        <div><label for="rdo-code">RDO Code</label><input type="text" id="rdo-code" name="rdo-code" placeholder="e.g., 038"></div>
                    </div>
                    <div class="space-y-4">
                        <h3 class="text-lg font-medium text-gray-900">Filing Information</h3>
                        <div>
                            <label for="taxpayer-classification">Taxpayer Classification</label>
                            <select id="taxpayer-classification" name="taxpayer-classification">
                                <option value="individual">Individual</option>
                                <option value="corporation">Non-Individual (Corporation/Partnership/etc.)</option>
                            </select>
                        </div>
                        <div>
                            <label for="taxpayer-industry">Industry Classification</label>
                            <input type="text" id="taxpayer-industry" name="taxpayer-industry" list="industry-list" placeholder="Type or select industry">
                            <datalist id="industry-list">
                                <!-- Options will be populated by JS -->
                            </datalist>
                        </div>
                        <div class="mt-4 space-y-5">
                            <fieldset id="income-tax-options">
                                <legend class="text-sm font-medium text-gray-900 mb-1">Income Tax Type:</legend>
                                <div id="individual-it-options" class="space-y-1">
                                    <div><input type="radio" id="it-type-8" name="income_tax_type" value="it-8"><label for="it-type-8" class="option-label">8% Flat Rate</label></div>
                                    <div><input type="radio" id="it-type-graduated" name="income_tax_type" value="1701q" checked><label for="it-type-graduated" class="option-label">Graduated Rates (1701Q/1701)</label></div>
                                </div>
                                <div id="non-individual-it-options" class="hidden">
                                    <input type="hidden" id="it-type-corp" name="income_tax_type" value="1702q">
                                    <p class="text-sm text-gray-600">Graduated Rates (1702Q/1702-RT)</p>
                                </div>
                            </fieldset>
                            <fieldset id="sales-tax-options">
                                <legend class="text-sm font-medium text-gray-900 mb-1">Sales Tax Type:</legend>
                                <div class="space-y-1">
                                    <div><input type="radio" id="sales-tax-pt" name="sales_tax_type" value="2551q"><label for="sales-tax-pt" class="option-label">Percentage Tax (2551Q/M)</label></div>
                                    <div><input type="radio" id="sales-tax-vat" name="sales_tax_type" value="2550q"><label for="sales-tax-vat" class="option-label">Value Added Tax (2550Q/M)</label></div>
                                    <div><input type="radio" id="sales-tax-none" name="sales_tax_type" value="none" checked><label for="sales-tax-none" class="option-label">None Applicable</label></div>
                                </div>
                            </fieldset>
                            <fieldset id="withholding-tax-options">
                                <legend class="text-sm font-medium text-gray-900 mb-1">Withholding Tax Types (Select all applicable):</legend>
                                <div class="space-y-1">
                                    <div><input type="checkbox" id="wt-type-comp" name="wt_type" value="1601c"><label for="wt-type-comp" class="option-label">Compensation (1601C)</label></div>
                                    <div><input type="checkbox" id="wt-type-exp" name="wt_type" value="1601eq"><label for="wt-type-exp" class="option-label">Expanded (1601EQ/0619E)</label></div>
                                </div>
                            </fieldset>
                        </div>
                    </div>
                </div>
                 <div class="settings-actions"> <button type="button" id="print-settings-button" class="print-button">Print Settings</button> <input type="file" id="import-settings-input" accept=".json" class="hidden"> <label for="import-settings-input" class="cursor-pointer">Import Settings</label> <button type="button" id="export-settings-button" class="export-button">Export Settings</button> </div>
            </div>

            <!-- Input Data Tab -->
            <div id="input-data-content" class="main-tab-content hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-6">Input Data Management & Pasting Area</h2>

                <!-- Save/Load/Clear Section -->
                <div class="data-management-section">
                    <h3>Manage Input Data (Cumulative Save/Load)</h3>
                    <div class="data-management-grid">
                        <!-- Save Group -->
                        <div class="data-control-group">
                            <label for="save-data-year">Year to Save:</label>
                            <input type="number" id="save-data-year" name="save-data-year" placeholder="YYYY" class="w-24">
                            <label for="save-data-period">Save Cumulative Data As of End of:</label>
                            <select id="save-data-period" name="save-data-period">
                                <option value="M1">January</option>
                                <option value="M2">February (Jan-Feb)</option>
                                <option value="M3">March (Jan-Mar)</option>
                                <option value="M4">April (Jan-Apr)</option>
                                <option value="M5">May (Jan-May)</option>
                                <option value="M6">June (Jan-Jun)</option>
                                <option value="M7">July (Jan-Jul)</option>
                                <option value="M8">August (Jan-Aug)</option>
                                <option value="M9">September (Jan-Sep)</option>
                                <option value="M10">October (Jan-Oct)</option>
                                <option value="M11">November (Jan-Nov)</option>
                                <option value="M12">December (Jan-Dec / Annual)</option>
                            </select>
                            <button type="button" id="save-data-button" class="save-button mt-2">Save Cumulative Data</button>
                            <p class="text-xs text-gray-500">Combines any loaded data with current text area content and saves it as the cumulative data for the selected period.</p>
                        </div>

                        <!-- Load Group -->
                        <div class="data-control-group">
                            <label for="load-data-input" class="button-like load-button">Load Cumulative Data File</label>
                            <input type="file" id="load-data-input" accept=".json" class="hidden">
                            <div id="load-status" class="text-sm text-gray-600 h-6"></div> <!-- Placeholder for status -->
                            <p class="text-xs text-gray-500">Loads data from a saved file. After loading, paste the *next* month's data (without headers) into the text areas below.</p>
                        </div>

                        <!-- Clear Group -->
                        <div class="data-control-group">
                            <label>Clear Data:</label>
                            <button type="button" id="clear-data-button" class="clear-button">Clear All Input Data</button>
                            <p class="text-xs text-gray-500">Clears text areas, internal loaded data, and processed data. Settings remain.</p>
                        </div>
                    </div>
                </div>
                <!-- End Save/Load/Clear Section -->

                <h2 class="text-xl font-semibold text-gray-700 mb-6 mt-8">Paste Current Month Data</h2>
                <p class="text-sm text-gray-600 mb-4">
                    If you have loaded cumulative data (see status above), paste the current month's data here <strong>WITHOUT HEADERS</strong>.
                    <br>If starting fresh (no data loaded), paste your data <strong>WITH HEADERS</strong> as the first line for each data type.
                </p>
                 <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-8">
                    <div>
                        <label for="sales-data">Sales Data</label>
                        <textarea id="sales-data" name="sales-data" rows="10"
                                  placeholder="Paste sales data here. Required Headers (Tab-Separated, First Row IF STARTING FRESH):
Date	Invoice #	TIN	Customer Name	Address	Vatable Receipt	Exempt Receipt	NonReportable Receipt	Gross Receipt	2307 IT	2307 WV	PWD/SC Discount	Retention Receivable	Recoupment Payable	Net Receipt	Net of VAT	Account Title	VAT	Validation	2307 IT Validate	2307 WB Validate"></textarea>
                     </div>
                     <div>
                         <label for="purchases-expenses-data">Purchases & Expenses Data</label>
                         <textarea id="purchases-expenses-data" rows="10" name="purchases-expenses-data"
                                  placeholder="Paste purchases and expenses data here. Required Headers (Tab-Separated, First Row IF STARTING FRESH):
Date	Supplier Invoice #	TIN	Supplier Name	Address	Vatable	Non-Vatable	Non-BIR	Gross Expense	Withholding Tax	Net Expense	Account Title	Net of VAT	VAT	ATC	Validation	Validation on WTax"></textarea>
                      </div>
                     <div class="md:col-span-2">
                          <label for="payroll-data">Payroll Data (Transactions)</label>
                          <textarea id="payroll-data" name="payroll-data" rows="10"
                                   placeholder="Paste payroll transaction data here. Required Headers (Tab-Separated, First Row IF STARTING FRESH):
Pay_Day	Employee Name	Category	Basic Pay	Holiday Pay	Overtime Pay	Nigh Shift Differential	De Minimis	13th Month	Gross Pay	SSS - ER/EC	SSS - EE	PHIC - ER	PHIC - EE	HDMF - ER	HDMF - EE	Taxable Pay	Tax Withheld	Net Pay	SSS,PHIC,HDMF - EE	Account Title	Contribution Expense	SSS Loan	HDMF Loan"></textarea>
                      </div>
                 </div>
                 <div class="mt-8 text-center"> <button id="generate-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-lg shadow focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition duration-150 ease-in-out text-lg">Generate Reports & Returns</button> </div>
            </div>

            <!-- Returns Tab -->
            <div id="returns-content" class="main-tab-content hidden">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Generated BIR Form Computations</h2>
                <div class="filter-section"> <div class="filter-item"><label for="returns-reporting-type">Reporting Type</label><select id="returns-reporting-type" name="returns-reporting-type"><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option></select></div> <div class="filter-item"><label for="returns-period">Period</label><select id="returns-period" name="returns-period"><option value="">Select Type First</option></select></div> <div class="filter-item"><label for="returns-year">Year</label><input type="number" id="returns-year" name="returns-year" placeholder="YYYY" min="2000" max="2099"></div> <div class="filter-item flex items-end"><button id="filter-returns-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm w-full">Apply Filters</button></div> </div>
                <div class="output-layout">
                    <aside class="output-sidebar w-full md:w-52 lg:w-60 flex-shrink-0">
                        <nav id="returns-sidebar-nav">
                            <button class="sidebar-nav-button hidden" data-tax-type="it-8 1701q 1702q" data-target="return-itr">Income Tax (Qtr/Ann)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="2551q" data-target="return-2551q">2551Q/M (Percentage Tax)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="2550q" data-target="return-2550q">2550Q/M (VAT)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="1601c" data-target="return-1601c">1601C (Compensation)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="1601eq" data-target="return-1601eq">1601EQ/0619E (EWT)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="1601c" data-target="return-1604c">1604C (Annual Comp)</button>
                            <button class="sidebar-nav-button hidden" data-tax-type="1601eq" data-target="return-1604e">1604E (Annual EWT)</button>
                        </nav>
                    </aside>
                    <div id="return-display-area" class="output-content-area">
                        <div id="return-display-content-wrapper">
                            <p class="text-gray-600">Select a return from the left sidebar and apply filters to view the computation.</p>
                        </div>
                    </div>
                </div>
            </div>

             <!-- Reports Tab -->
            <div id="reports-content" class="main-tab-content hidden">
                 <h2 class="text-xl font-semibold text-gray-700 mb-4">Generated Summary Reports & Alphalists</h2>
                 <div class="filter-section"> <div class="filter-item"><label for="reports-reporting-type">Reporting Type</label><select id="reports-reporting-type" name="reports-reporting-type"><option value="monthly">Monthly</option><option value="quarterly">Quarterly</option><option value="annual">Annual</option></select></div> <div class="filter-item"><label for="reports-period">Period</label><select id="reports-period" name="reports-period"><option value="">Select Type First</option></select></div> <div class="filter-item"><label for="reports-year">Year</label><input type="number" id="reports-year" name="reports-year" placeholder="YYYY" min="2000" max="2099"></div> <div class="filter-item flex items-end"><button id="filter-reports-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-medium py-2 px-4 rounded-md shadow-sm w-full">Apply Filters</button></div> </div>
                <div class="output-layout">
                    <aside class="output-sidebar w-full md:w-52 lg:w-60 flex-shrink-0">
                        <nav id="reports-sidebar-nav">
                            <button class="sidebar-nav-button" data-target="report-qap">QAP (EWT)</button>
                            <button class="sidebar-nav-button" data-target="report-vat-summary">SAWT (VAT/PT)</button>
                            <button class="sidebar-nav-button" data-target="report-income-tax-summary">SAWT (IT)</button>
                            <button class="sidebar-nav-button" data-target="report-sls">SLS (Sales)</button>
                            <button class="sidebar-nav-button" data-target="report-slp">SLP (Purchases)</button>
                            <button class="sidebar-nav-button" data-target="report-recon-wht">Recon of W/H Taxes</button>
                            <button class="sidebar-nav-button" data-target="report-payroll-summary">Payroll Summary</button>
                            <button class="sidebar-nav-button" data-target="report-sss-phic-hdmf">SSS/PHIC/HDMF Report</button> <!-- NEW -->
                            <button class="sidebar-nav-button" data-target="report-general-ledger">General Ledger Report</button>
                            <button class="sidebar-nav-button" data-target="report-input-tax-sources">Sources of Input Taxes</button>
                        </nav>
                    </aside>
                     <div id="report-display-area" class="output-content-area">
                         <div id="report-display-content-wrapper">
                            <p class="text-gray-600">Select a report from the left sidebar and apply filters to view the summary.</p>
                         </div>
                         <!-- DAT file placeholder area -->
                         <div id="dat-file-generation-area" class="hidden mt-6 pt-4 border-t border-dashed border-gray-300">
                             <h4 class="text-lg font-semibold text-gray-600 mb-3">DAT File Generation (Monthly Reports)</h4>
                             <p class="text-sm text-gray-500 mb-4">Functionality to generate DAT files for BIR submission (e.g., SAWT, Alphalists) will be added here in the future.</p>
                             <div class="flex flex-wrap gap-3">
                                 <button type="button" class="report-actions button bg-gray-500 text-white py-1 px-3 rounded-md opacity-70 cursor-not-allowed" disabled title="Coming Soon">Generate SAWT DAT File</button>
                                 <button type="button" class="report-actions button bg-gray-500 text-white py-1 px-3 rounded-md opacity-70 cursor-not-allowed" disabled title="Coming Soon">Generate Monthly Alphalist DAT</button>
                             </div>
                         </div>
                     </div>
                </div>
            </div>

        </div> <footer class="mt-8 text-center text-sm text-gray-500 pt-4">
            Exclusive use for Tallo Accounting, Audit and Tax Consultancy © 2025
        </footer>

    </div>
    <script>
        // --- Global Data Store ---
        let processedData = { sales: [], purchasesExpenses: [], payroll: [], employeeDb: [] };
        let appSettings = { taxTypes: [], industry: '' };
        let internalLoadedSalesRaw = "";
        let internalLoadedPurchasesRaw = "";
        let internalLoadedPayrollRaw = "";
        let lastLoadedPeriodInfo = "";

        // --- Helper to Standardize Header Keys ---
        function standardizeHeaderKey(header) { if (!header) return ''; let key = header.toUpperCase(); key = key.replace(/#/, ''); key = key.replace(/\s*[-\/(),.]\s*/g, '_'); key = key.replace(/\s+/g, '_'); key = key.replace(/[^A-Z0-9_]/g, ''); key = key.replace(/__+/g, '_'); key = key.replace(/^_+|_+$/g, ''); if (/^[0-9]/.test(key)) { key = '_' + key; } return key; }

        // --- Standardized Keys for Data Processing ---
        // These objects map desired JS property names to the standardized version of expected input file headers.
        // parseTsvData will create row objects using the *keys* of these objects (e.g., row.PAY_DAY).
        const PAYROLL_STD_KEYS = {
            PAY_DAY: standardizeHeaderKey("Pay_Day"),
            EMPLOYEE_NAME: standardizeHeaderKey("Employee Name"),
            CATEGORY: standardizeHeaderKey("Category"),
            BASIC_PAY: standardizeHeaderKey("Basic Pay"),
            HOLIDAY_PAY: standardizeHeaderKey("Holiday Pay"),
            OVERTIME_PAY: standardizeHeaderKey("Overtime Pay"),
            NIGH_SHIFT_DIFFERENTIAL: standardizeHeaderKey("Nigh Shift Differential"),
            DE_MINIMIS: standardizeHeaderKey("De Minimis"),
            THIRTEENTH_MONTH: standardizeHeaderKey("13th Month"),
            GROSS_PAY: standardizeHeaderKey("Gross Pay"),
            SSS_ER_EC: standardizeHeaderKey("SSS - ER/EC"), // For ER share if needed separately
            SSS_EE: standardizeHeaderKey("SSS - EE"),
            PHIC_ER: standardizeHeaderKey("PHIC - ER"), // For ER share if needed separately
            PHIC_EE: standardizeHeaderKey("PHIC - EE"),
            HDMF_ER: standardizeHeaderKey("HDMF - ER"), // For ER share if needed separately
            HDMF_EE: standardizeHeaderKey("HDMF - EE"),
            TAXABLE_PAY: standardizeHeaderKey("Taxable Pay"), // From input, if used as a check
            TAX_WITHHELD: standardizeHeaderKey("Tax Withheld"),
            NET_PAY: standardizeHeaderKey("Net Pay"),
            SSS_PHIC_HDMF_EE: standardizeHeaderKey("SSS,PHIC,HDMF - EE"), // Combined EE contributions
            ACCOUNT_TITLE_PAYROLL: standardizeHeaderKey("Account Title"), // Renamed to avoid clash
            CONTRIBUTION_EXPENSE: standardizeHeaderKey("Contribution Expense"), // ER Share sum
            SSS_LOAN: standardizeHeaderKey("SSS Loan"),      // New
            HDMF_LOAN: standardizeHeaderKey("HDMF Loan")     // New
        };

        const SALES_STD_KEYS = {
            DATE: standardizeHeaderKey("Date"),
            INVOICE_NO: standardizeHeaderKey("Invoice #"),
            TIN: standardizeHeaderKey("TIN"),
            CUSTOMER_NAME: standardizeHeaderKey("Customer Name"),
            ADDRESS: standardizeHeaderKey("Address"),
            VATABLE_RECEIPT: standardizeHeaderKey("Vatable Receipt"),
            EXEMPT_RECEIPT: standardizeHeaderKey("Exempt Receipt"),
            NONREPORTABLE_RECEIPT: standardizeHeaderKey("NonReportable Receipt"),
            GROSS_RECEIPT: standardizeHeaderKey("Gross Receipt"),
            _2307_IT: standardizeHeaderKey("2307 IT"),
            _2307_WV: standardizeHeaderKey("2307 WV"),
            PWD_SC_DISCOUNT: standardizeHeaderKey("PWD/SC Discount"),
            RETENTION_RECEIVABLE: standardizeHeaderKey("Retention Receivable"),
            RECOUPMENT_PAYABLE: standardizeHeaderKey("Recoupment Payable"),
            NET_RECEIPT: standardizeHeaderKey("Net Receipt"),
            NET_OF_VAT_SALES: standardizeHeaderKey("Net of VAT"), // Renamed
            ACCOUNT_TITLE_SALES: standardizeHeaderKey("Account Title"), // Renamed
            VAT_SALES: standardizeHeaderKey("VAT"), // Renamed
            VALIDATION_SALES: standardizeHeaderKey("Validation"), // Renamed
            _2307_IT_VALIDATE: standardizeHeaderKey("2307 IT Validate"),
            _2307_WB_VALIDATE: standardizeHeaderKey("2307 WB Validate")
        };

        const PURCHASES_EXPENSES_STD_KEYS = {
            DATE: standardizeHeaderKey("Date"),
            SUPPLIER_INVOICE_NO: standardizeHeaderKey("Supplier Invoice #"),
            TIN: standardizeHeaderKey("TIN"),
            SUPPLIER_NAME: standardizeHeaderKey("Supplier Name"),
            ADDRESS: standardizeHeaderKey("Address"),
            VATABLE: standardizeHeaderKey("Vatable"),
            NON_VATABLE: standardizeHeaderKey("Non-Vatable"),
            NON_BIR: standardizeHeaderKey("Non-BIR"),
            GROSS_EXPENSE: standardizeHeaderKey("Gross Expense"),
            WITHHOLDING_TAX: standardizeHeaderKey("Withholding Tax"),
            NET_EXPENSE: standardizeHeaderKey("Net Expense"),
            ACCOUNT_TITLE_PURCH: standardizeHeaderKey("Account Title"), // Renamed
            NET_OF_VAT_PURCH: standardizeHeaderKey("Net of VAT"), // Renamed
            VAT_PURCH: standardizeHeaderKey("VAT"), // Renamed
            ATC: standardizeHeaderKey("ATC"),
            VALIDATION_PURCH: standardizeHeaderKey("Validation"), // Renamed
            VALIDATION_ON_WTAX: standardizeHeaderKey("Validation on WTax")
        };


        // --- Benchmark Table Data ---
        const benchmarkTableData = [
            { industry: "ADVERTISING", gpr: 0.5085, itr: 0.0305, vatRate: 0.0610 }, { industry: "ARTS- DRAMATICS, MUSIC, ETC. (IND)", gpr: 0.7138, itr: 0.0871, vatRate: 0.0857 }, { industry: "BAKERY PRODCTS", gpr: 0.4875, itr: 0.0148, vatRate: 0.0585 }, { industry: "BPO/ CALL CENTERS", gpr: 0.2608, itr: 0.0390, vatRate: 0.0313 }, { industry: "BUSINESS & MNGT. CONSULTANCY SERVICES", gpr: 0.8123, itr: 0.1042, vatRate: 0.0975 }, { industry: "CARGO HANDLIING & FREIGHT FORWARDING", gpr: 0.5311, itr: 0.0182, vatRate: 0.0637 }, { industry: "CONSTRUCTION (NON- IND.)", gpr: 0.3094, itr: 0.0172, vatRate: 0.0371 }, { industry: "CONSTRUCTION (IND.)", gpr: 0.3983, itr: 0.0601, vatRate: 0.0478 }, { industry: "CUSTOMS BROKERAGE (NON- IND.)", gpr: 0.2654, itr: 0.0423, vatRate: 0.0526 }, { industry: "CUSTOMS BROKERAGE (IND.)", gpr: 0.8437, itr: 0.0534, vatRate: 0.1012 }, { industry: "FREIGHT & FORWARDING SERVICES", gpr: 0.6269, itr: 0.0141, vatRate: 0.0752 }, { industry: "OPERATION OF FREIGHT TRANSPORT (IND.)", gpr: 0.3406, itr: 0.0133, vatRate: 0.0409 }, { industry: "TRUCKING/ FORWARDING SERVICES", gpr: 0.4711, itr: 0.0228, vatRate: 0.0565 }, { industry: "GASOLINE STATION (FUEL) (IND.)", gpr: 0.0506, itr: 0.0022, vatRate: 0.0061 }, { industry: "FUEL, LPG (IND.)", gpr: 0.0599, itr: 0.0023, vatRate: 0.0072 }, { industry: "GARMENTS- MANUFACTURING (NON- IND.)", gpr: 0.2992, itr: 0.0080, vatRate: 0.0359 }, { industry: "GARMENTS- MANUFACTURING (IND.)", gpr: 0.5787, itr: 0.0134, vatRate: 0.0694 }, { industry: "GARMENTS- RETAIL (NON- IND.)", gpr: 0.4143, itr: 0.0116, vatRate: 0.0497 }, { industry: "GARMENTS- RETAIL (IND.)", gpr: 0.2471, itr: 0.0057, vatRate: 0.0296 }, { industry: "GARMENTS- WHOLESALE (NON- IND.)", gpr: 0.3437, itr: 0.0101, vatRate: 0.0412 }, { industry: "GARMENTS- WHOLESALE (IND.)", gpr: 0.3694, itr: 0.0067, vatRate: 0.0443 }, { industry: "HAIR DRESSING AND OTHER TREATMENT", gpr: 0.4577, itr: 0.0129, vatRate: 0.0549 }, { industry: "HARDWARE (NON-IND)", gpr: 0.3370, itr: 0.0113, vatRate: 0.0404 }, { industry: "HARDWARE (IND)", gpr: 0.3033, itr: 0.0129, vatRate: 0.0364 }, { industry: "HOTELS AND MOTELS", gpr: 0.3720, itr: 0.0156, vatRate: 0.0456 }, { industry: "INVESTIGATION/SECURITY SERVICES (NON-IND)", gpr: 0.7784, itr: 0.0327, vatRate: 0.0934 }, { industry: "INVESTIGATION/SECURITY SERVICES (IND)", gpr: 0.6715, itr: 0.0255, vatRate: 0.0806 }, { industry: "IT/SOFTWARE CONSULTANCY", gpr: 0.5105, itr: 0.0177, vatRate: 0.0613 }, { industry: "LABOR RECRUITMENT (NON-IND)", gpr: 0.3863, itr: 0.0067, vatRate: 0.0661 }, { industry: "LABOR/MANPOWER RECRUITMENT", gpr: 0.4107, itr: 0.0254, vatRate: 0.0572 }, { industry: "LAND TRANSPORT (NON-IND)", gpr: 0.4161, itr: 0.0400, vatRate: 0.1047 }, { industry: "MACHINERY AND EQUIPMENT  (WHOLESALE)", gpr: 0.2669, itr: 0.0134, vatRate: 0.0320 }, { industry: "MANAGEMENT AND ADMINISTRATIVE SERVICES", gpr: 0.7417, itr: 0.0425, vatRate: 0.0890 }, { industry: "MANPOWER SERVICES (NON-IND)", gpr: 0.5025, itr: 0.0125, vatRate: 0.0603 }, { industry: "MANUFACTURING - FABRICATED METALS", gpr: 0.2825, itr: 0.0152, vatRate: 0.0339 }, { industry: "MANUFACTURING - CONCRETE, CEMENT, ETC", gpr: 0.2859, itr: 0.0058, vatRate: 0.0343 }, { industry: "MANUFACTURING - OTHER ARTICLES ( NEC)", gpr: 0.3664, itr: 0.0173, vatRate: 0.0440 }, { industry: "MANUFACTURING - FOOD PRODUCTS (NON-IND)", gpr: 0.2102, itr: 0.0196, vatRate: 0.0367 }, { industry: "MANUFACTURING - FOOD PRODUCTS (IND)", gpr: 0.7563, itr: 0.0182, vatRate: 0.0908 }, { industry: "WHOLESALE OF FOODS (IND)", gpr: 0.1622, itr: 0.0025, vatRate: 0.0195 }, { industry: "MANUFACTURING - LEATHER SHOES ", gpr: 0.2406, itr: 0.0030, vatRate: 0.0289 }, { industry: "MANUFACTURING- PLASTIC (NON-IND)", gpr: 0.2502, itr: 0.0090, vatRate: 0.0327 }, { industry: "MANUFACTURING - PLASTIC (IND)", gpr: 0.4572, itr: 0.0488, vatRate: 0.0549 }, { industry: "METAL PRODUCTS (NON-IND)", gpr: 0.2890, itr: 0.0133, vatRate: 0.0413 }, { industry: "NON-LIFE INSURANCE (NON-IND)", gpr: 0.7263, itr: 0.0532, vatRate: 0.0872 }, { industry: "OTHER BUILDING COMPLETION ACTIVITIES (NON-IND)", gpr: 0.3574, itr: 0.0129, vatRate: 0.0429 }, { industry: "OTHER BUSINESS ACTIVITIES", gpr: 0.2746, itr: 0.0118, vatRate: 0.0330 }, { industry: "OTHER RETAIL IN SPECIALIZED STORE (NON-IND)", gpr: 0.3384, itr: 0.0117, vatRate: 0.0406 }, { industry: "OTHER RETAIL IN SPECIALIZED STORE (IND)", gpr: 0.2125, itr: 0.0091, vatRate: 0.0255 }, { industry: "OTHER SERVICE ACTIVITIES", gpr: 0.4197, itr: 0.0371, vatRate: 0.0504 }, { industry: "OTHER WHOLESALING", gpr: 0.2160, itr: 0.0122, vatRate: 0.0259 }, { industry: "OTHER WHOLESALING - GEN MERCHANDIZE ( NON-IND)", gpr: 0.3164, itr: 0.0127, vatRate: 0.0380 }, { industry: "PHARMACEUTICALS (IND)", gpr: 0.2690, itr: 0.0077, vatRate: 0.0323 }, { industry: "PHARMACEUTICALS (NON-IND)", gpr: 0.3648, itr: 0.0139, vatRate: 0.0438 }, { industry: "PRINTING SERVICES (NON-IND)", gpr: 0.2760, itr: 0.0122, vatRate: 0.0337 }, { industry: "PRINTING SERVICES (IND)", gpr: 0.4032, itr: 0.0147, vatRate: 0.0484 }, { industry: "PRIVATE, MEDICAL, DENTAL AND OTHER HEALTH ACTIVITIES (NON-IND)", gpr: 0.7599, itr: 0.0659, vatRate: 0.0912 }, { industry: "PRIVATE, MEDICAL, DENTAL AND OTHER HEALTH ACTIVITIES (IND)", gpr: 1.0000, itr: 0.1201, vatRate: 0.1200 }, { industry: "PROFESSIONALS- ACCOUNTING/AUDITING", gpr: 1.0000, itr: 0.0000, vatRate: 0.1200 }, { industry: "PROFESSIONALS- LEGAL ACTIVITIES", gpr: 0.8462, itr: 0.0000, vatRate: 0.1015 }, { industry: "REAL ESTATE - LESSOR (NON-IND)", gpr: 0.8674, itr: 0.0833, vatRate: 0.1041 }, { industry: "REAL ESTATE - LESSOR (IND)", gpr: 0.9115, itr: 0.1000, vatRate: 0.1094 }, { industry: "REAL ESTATE - DEVELOPER", gpr: 0.7159, itr: 0.0781, vatRate: 0.0859 }, { industry: "RESTAURANTS (FACES, FASTFOOD)", gpr: 0.3747, itr: 0.0062, vatRate: 0.0648 }, { industry: "RESTAURANTS (FINE- DINING)", gpr: 0.4782, itr: 0.0062, vatRate: 0.0574 }, { industry: "RESTAURANTS (FRANCHISE, FASTFOOD)", gpr: 0.3323, itr: 0.0109, vatRate: 0.0399 }, { industry: "RESTAURANT (IND.)", gpr: 0.3056, itr: 0.0147, vatRate: 0.0456 }, { industry: "RESTAURANTS (BARS, CANTEENS)", gpr: 0.3973, itr: 0.0107, vatRate: 0.0477 }, { industry: "RESTAURANTS (REGULAR)", gpr: 0.3738, itr: 0.0117, vatRate: 0.0449 }, { industry: "RETAIL- ELECTRICAL SUPPLY (NON- IND.)", gpr: 0.2002, itr: 0.0117, vatRate: 0.0240 }, { industry: "RETAIL- OFFICE MACHINES, EQUIPMENT", gpr: 0.3869, itr: 0.0140, vatRate: 0.0464 }, { industry: "RETAIL- OFFICE SUPPLES (NON- IND.)", gpr: 0.3177, itr: 0.0065, vatRate: 0.0381 }, { industry: "RETAIL- OFFICE SUPPLIES (IND.)", gpr: 0.2772, itr: 0.0073, vatRate: 0.0333 }, { industry: "RETAIL SALE VIA STALL & MARKETS", gpr: 0.1909, itr: 0.0058, vatRate: 0.0229 }, { industry: "SALE OF HOUSEHOLD APPLIANCES", gpr: 0.4108, itr: 0.0280, vatRate: 0.0493 }, { industry: "SALE OF MOTOR PARTS (NON- IND.)", gpr: 0.3333, itr: 0.0111, vatRate: 0.0434 }, { industry: "SALE OF MOTOR PARTS (IND.)", gpr: 0.3430, itr: 0.0124, vatRate: 0.0412 }, { industry: "SECURITY DEALING ACTIVITIES", gpr: 0.8189, itr: 0.1184, vatRate: 0.0990 }, { industry: "TOURS & TRAVEL AGENCIES", gpr: 0.7012, itr: 0.0226, vatRate: 0.0841 }
        ];


        // --- Main Tab Functionality ---
        const mainTabButtons = document.querySelectorAll('.main-tab-button');
        const mainTabContents = document.querySelectorAll('#main-content-container > .main-tab-content');
        function showMainTab(targetId) {
            console.log('Showing main tab:', targetId); mainTabContents.forEach(content => { if (!content.classList.contains('hidden')) { content.classList.add('hidden'); } }); mainTabButtons.forEach(button => { button.classList.remove('main-tab-active', 'border-blue-700', 'text-blue-700'); button.classList.add('border-transparent', 'text-gray-600', 'hover:text-gray-800', 'hover:border-gray-400'); }); const targetContent = document.getElementById(targetId); if (targetContent) { targetContent.classList.remove('hidden'); } const activeButton = document.querySelector(`.main-tab-button[data-target="${targetId}"]`); if (activeButton) { activeButton.classList.add('main-tab-active', 'border-blue-700', 'text-blue-700'); activeButton.classList.remove('border-transparent', 'text-gray-600'); }
            if (targetId === 'returns-content') { updateSidebarVisibility('returns'); initializeFilters('returns'); const activeReturnButton = returnsSidebarNav.querySelector('button.sidebar-active:not(.hidden)'); if (activeReturnButton && (processedData?.sales?.length > 0 || processedData?.purchasesExpenses?.length > 0 || processedData?.payroll?.length > 0)) { console.log("Auto-applying filters for Returns tab."); filterReturnsButton.click(); } else if (!activeReturnButton) { returnDisplayContentWrapper.innerHTML = '<p class="text-gray-600">Select a return from the sidebar and apply filters.</p>'; } else { returnDisplayContentWrapper.innerHTML = '<p class="text-gray-600 italic">Loaded data. Click Apply Filters to view.</p>';} }
            else if (targetId === 'reports-content') { updateSidebarVisibility('reports'); initializeFilters('reports'); const activeReportButton = reportsSidebarNav.querySelector('button.sidebar-active:not(.hidden)'); const wrapper = document.getElementById('report-display-area'); if(wrapper) wrapper.querySelector('#dat-file-generation-area')?.classList.add('hidden'); if (activeReportButton && (processedData?.sales?.length > 0 || processedData?.purchasesExpenses?.length > 0 || processedData?.payroll?.length > 0)) { console.log("Auto-applying filters for Reports tab."); filterReportsButton.click(); } else if (!activeReportButton) { reportDisplayContentWrapper.innerHTML = '<p class="text-gray-600">Select a report from the sidebar and apply filters.</p>'; } else { reportDisplayContentWrapper.innerHTML = '<p class="text-gray-600 italic">Loaded data. Click Apply Filters to view.</p>';} }
        }
        mainTabButtons.forEach(button => { button.addEventListener('click', (event) => { event.preventDefault(); const targetId = button.getAttribute('data-target'); showMainTab(targetId); }); });

        // --- Settings & Input Data Elements ---
        const taxpayerNameInput = document.getElementById('taxpayer-name'); const taxpayerTinInput = document.getElementById('taxpayer-tin'); const taxpayerAddressInput = document.getElementById('taxpayer-address'); const taxpayerZipInput = document.getElementById('taxpayer-zip'); const rdoCodeInput = document.getElementById('rdo-code'); const taxpayerClassificationSelect = document.getElementById('taxpayer-classification'); const taxpayerIndustryInput = document.getElementById('taxpayer-industry'); const salesDataText = document.getElementById('sales-data'); const purchasesExpensesDataText = document.getElementById('purchases-expenses-data'); const payrollDataText = document.getElementById('payroll-data'); const generateButton = document.getElementById('generate-button'); const individualItOptionsDiv = document.getElementById('individual-it-options'); const nonIndividualItOptionsDiv = document.getElementById('non-individual-it-options'); const incomeTaxRadios = document.querySelectorAll('input[name="income_tax_type"]'); const salesTaxRadios = document.querySelectorAll('input[name="sales_tax_type"]'); const wtCheckboxes = document.querySelectorAll('input[name="wt_type"]'); const itType8Radio = document.getElementById('it-type-8'); const itTypeGraduatedRadio = document.getElementById('it-type-graduated'); const salesTaxPtRadio = document.getElementById('sales-tax-pt'); const salesTaxVatRadio = document.getElementById('sales-tax-vat'); const salesTaxNoneRadio = document.getElementById('sales-tax-none'); const printSettingsButton = document.getElementById('print-settings-button'); const importSettingsInput = document.getElementById('import-settings-input'); const exportSettingsButton = document.getElementById('export-settings-button'); const returnsReportingType = document.getElementById('returns-reporting-type'); const returnsPeriodSelect = document.getElementById('returns-period'); const returnsYearInput = document.getElementById('returns-year'); const filterReturnsButton = document.getElementById('filter-returns-button'); const reportsReportingType = document.getElementById('reports-reporting-type'); const reportsPeriodSelect = document.getElementById('reports-period'); const reportsYearInput = document.getElementById('reports-year'); const filterReportsButton = document.getElementById('filter-reports-button'); const returnDisplayContentWrapper = document.getElementById('return-display-content-wrapper'); const reportDisplayContentWrapper = document.getElementById('report-display-content-wrapper'); const returnsSidebarNav = document.getElementById('returns-sidebar-nav'); const reportsSidebarNav = document.getElementById('reports-sidebar-nav');
        const saveDataYearInput = document.getElementById('save-data-year'); const saveDataPeriodSelect = document.getElementById('save-data-period'); const saveDataButton = document.getElementById('save-data-button'); const loadDataInput = document.getElementById('load-data-input'); const loadStatusDiv = document.getElementById('load-status'); const clearDataButton = document.getElementById('clear-data-button');
        const datFileGenerationArea = document.getElementById('dat-file-generation-area');


        // --- Settings Logic ---
        function handleTaxSettingsChange() { const isIndividual = taxpayerClassificationSelect.value === 'individual'; const is8PercentSelected = isIndividual && itType8Radio.checked; individualItOptionsDiv.classList.toggle('hidden', !isIndividual); nonIndividualItOptionsDiv.classList.toggle('hidden', isIndividual); const disableSalesTax = isIndividual && is8PercentSelected; [salesTaxPtRadio, salesTaxVatRadio].forEach(radio => { const wasDisabled = radio.disabled; radio.disabled = disableSalesTax; const label = document.querySelector(`label[for="${radio.id}"]`); if (label) { label.classList.toggle('text-gray-400', disableSalesTax); label.classList.toggle('cursor-not-allowed', disableSalesTax); } if (disableSalesTax && !wasDisabled && radio.checked) { radio.checked = false; salesTaxNoneRadio.checked = true; } }); salesTaxNoneRadio.disabled = false; const noneLabel = document.querySelector(`label[for="sales-tax-none"]`); if (noneLabel) { noneLabel.classList.remove('text-gray-400', 'cursor-not-allowed'); } }
        taxpayerClassificationSelect.addEventListener('change', handleTaxSettingsChange); incomeTaxRadios.forEach(radio => radio.addEventListener('change', handleTaxSettingsChange)); handleTaxSettingsChange();

        function populateIndustryDatalist() {
            const datalist = document.getElementById('industry-list');
            if (datalist) {
                datalist.innerHTML = '';
                benchmarkTableData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.industry;
                    datalist.appendChild(option);
                });
            }
        }

        // --- Filter Logic ---
        const periodOptions = { monthly: [{ value: 'M1', text: 'January' }, { value: 'M2', text: 'February' }, { value: 'M3', text: 'March' }, { value: 'M4', text: 'April' }, { value: 'M5', text: 'May' }, { value: 'M6', text: 'June' }, { value: 'M7', text: 'July' }, { value: 'M8', text: 'August' }, { value: 'M9', text: 'September' }, { value: 'M10', text: 'October' }, { value: 'M11', text: 'November' }, { value: 'M12', text: 'December' }], quarterly: [{ value: 'Q1', text: '1st Quarter (Jan-Mar)' }, { value: 'Q2', text: '2nd Quarter (Apr-Jun)' }, { value: 'Q3', text: '3rd Quarter (Jul-Sep)' }, { value: 'Q4', text: '4th Quarter (Oct-Dec)' }], annual: [{ value: 'Annual', text: 'Annual' }] };
        function updatePeriodDropdown(typeSelect, periodSelect) { const selectedType = typeSelect.value; const options = periodOptions[selectedType] || []; periodSelect.innerHTML = ''; if (options.length > 0) { options.forEach(opt => { const optionEl = document.createElement('option'); optionEl.value = opt.value; optionEl.textContent = opt.text; periodSelect.appendChild(optionEl); }); } else { const optionEl = document.createElement('option'); optionEl.value = ''; optionEl.textContent = 'N/A'; periodSelect.appendChild(optionEl); } }
        returnsReportingType.addEventListener('change', () => updatePeriodDropdown(returnsReportingType, returnsPeriodSelect)); reportsReportingType.addEventListener('change', () => updatePeriodDropdown(reportsReportingType, reportsPeriodSelect));
        function initializeFilters(tabType) { const yearInput = document.getElementById(`${tabType}-year`); const typeSelect = document.getElementById(`${tabType}-reporting-type`); const periodSelect = document.getElementById(`${tabType}-period`); if (yearInput && !yearInput.value) { yearInput.value = new Date().getFullYear(); } if (typeSelect && periodSelect) { updatePeriodDropdown(typeSelect, periodSelect); } }

        // --- Sidebar Navigation Logic ---
        function handleSidebarClick(event, sidebarNav, displayContentWrapperEl) { if (event.target.tagName === 'BUTTON' && event.target.closest('nav') === sidebarNav) { const button = event.target; const targetReportId = button.dataset.target; const reportTitle = button.textContent; sidebarNav.querySelectorAll('button').forEach(btn => btn.classList.remove('sidebar-active')); button.classList.add('sidebar-active'); console.log(`Sidebar button clicked: ${targetReportId}. Filter needs to be applied.`); displayContentWrapperEl.innerHTML = `<p class="text-gray-600 italic">Selected '${reportTitle}'. Click 'Apply Filters' to view.</p>`; if(sidebarNav === reportsSidebarNav && datFileGenerationArea) { datFileGenerationArea.classList.add('hidden'); } } }
        returnsSidebarNav.addEventListener('click', (e) => handleSidebarClick(e, returnsSidebarNav, returnDisplayContentWrapper)); reportsSidebarNav.addEventListener('click', (e) => handleSidebarClick(e, reportsSidebarNav, reportDisplayContentWrapper));
        function updateSidebarVisibility(tabType) {
            const sidebarNavId = `${tabType}-sidebar-nav`;
            const sidebarNav = document.getElementById(sidebarNavId);
            if (!sidebarNav) return;

            const buttons = sidebarNav.querySelectorAll('button.sidebar-nav-button');
            const classification = appSettings?.classification;
            const selectedTaxTypes = appSettings?.taxTypes || [];
            const isIndividual = classification === 'individual';
            const is8Percent = isIndividual && selectedTaxTypes.includes('it-8');

            let firstVisibleButton = null;
            let activeWasHidden = false;
            console.log(`Updating sidebar ${tabType}. Class: ${classification}, Types:`, selectedTaxTypes);

            buttons.forEach(button => {
                const requiredTaxTypes = (button.dataset.taxType || '').split(' ').filter(t => t);
                const target = button.dataset.target;
                let showButton = false;

                if (tabType === 'reports') {
                    showButton = true;
                } else if (tabType === 'returns') {
                    if (requiredTaxTypes.length === 0) {
                        showButton = true;
                    } else {
                        showButton = requiredTaxTypes.some(reqType => selectedTaxTypes.includes(reqType));
                    }

                    if (showButton && target === 'return-itr') {
                        const is1701 = selectedTaxTypes.includes('1701q');
                        const is1702 = selectedTaxTypes.includes('1702q');
                        const isIT8 = selectedTaxTypes.includes('it-8');

                        if (isIndividual) {
                            if (!isIT8 && !is1701) showButton = false;
                            if(showButton) button.textContent = isIT8 ? 'ITR 8% (Qtr/Ann)' : '1701Q/1701 (IT Q/A)';
                        } else {
                            if (!is1702) showButton = false;
                            if(showButton) button.textContent = '1702Q/1702-RT (IT Q/A)';
                        }
                    }

                    if (is8Percent && (requiredTaxTypes.includes('2550q') || requiredTaxTypes.includes('2551q'))) {
                        showButton = false;
                    }
                    if (!selectedTaxTypes.includes('1601c') && (target === 'return-1601c' || target === 'return-1604c')) {
                        showButton = false;
                    }
                    if (!selectedTaxTypes.includes('1601eq') && (target === 'return-1601eq' || target === 'return-1604e')) {
                        showButton = false;
                    }
                }

                const wasActive = button.classList.contains('sidebar-active');
                button.classList.toggle('hidden', !showButton);
                if (!showButton && wasActive) {
                    button.classList.remove('sidebar-active');
                    activeWasHidden = true;
                }
                if (showButton && !firstVisibleButton) {
                    firstVisibleButton = button;
                }
            });

            const displayContentWrapperEl = document.getElementById(`${tabType}-display-content-wrapper`);
            const currentlyActiveButton = sidebarNav.querySelector('button.sidebar-nav-button.sidebar-active:not(.hidden)');

            if ((!currentlyActiveButton || activeWasHidden) && firstVisibleButton) {
                buttons.forEach(btn => btn.classList.remove('sidebar-active'));
                firstVisibleButton.classList.add('sidebar-active');
                if (displayContentWrapperEl) {
                    displayContentWrapperEl.innerHTML = `<p class="text-gray-600 italic">Selected '${firstVisibleButton.textContent}'. Click 'Apply Filters' to view.</p>`;
                }
            } else if (!firstVisibleButton) {
                if (displayContentWrapperEl) displayContentWrapperEl.innerHTML = `<p class="text-gray-500">No applicable ${tabType} selected/generated based on current settings.</p>`;
            } else if (currentlyActiveButton && displayContentWrapperEl.innerHTML.includes('Select a')) {
                 displayContentWrapperEl.innerHTML = `<p class="text-gray-600 italic">Selected '${currentlyActiveButton.textContent}'. Click 'Apply Filters' to view.</p>`;
            }
        }

        // --- Data Parsing ---
        function parseTsvData(dataType, rawData, headersArray) { // headersArray is still used for initial mapping
            console.log(`Starting parseTsvData for: ${dataType}. Input length: ${rawData?.length || 0}`);
            if (!rawData || typeof rawData !== 'string') { console.warn(`parseTsvData [${dataType}]: Invalid input data.`); return []; }
            const lines = rawData.trim().split('\n');
            if (lines.length === 0) { console.warn(`parseTsvData [${dataType}]: No lines found.`); return []; }
            if (lines.length === 1 && !lines[0].trim()) { console.warn(`parseTsvData [${dataType}]: Only empty line found.`); return [];}


            const data = [];
            const headerLine = lines[0].trim();
            console.log(`parseTsvData [${dataType}]: Header Line Found:`, headerLine);
            const inputFileHeaders = headerLine.split('\t'); // Headers as they appear in the pasted data

            // Create a map from standardized *input file header* to its index in the input file
            const headerIndexMap = {};
            inputFileHeaders.forEach((header, index) => {
                headerIndexMap[standardizeHeaderKey(header)] = index;
            });
            console.log(`parseTsvData [${dataType}]: Input File Header Index Map (Standardized Input Header -> Index):`, headerIndexMap);

            let keysToUse = {}; // This will be PAYROLL_STD_KEYS, SALES_STD_KEYS, etc.
                               // It maps: { JS_PROPERTY_NAME: STANDARDIZED_HEADER_FROM_FILE_FOR_LOOKUP, ... }
            if (dataType === "Sales") keysToUse = SALES_STD_KEYS;
            else if (dataType === "Purchases/Expenses") keysToUse = PURCHASES_EXPENSES_STD_KEYS;
            else if (dataType === "Payroll") keysToUse = PAYROLL_STD_KEYS;
            else {
                console.warn(`parseTsvData [${dataType}]: No STD_KEYS object defined. Cannot map to JS properties.`);
                // Fallback or error handling if you want to parse based on headersArray directly without predefined JS props
                // For now, this will result in empty objects if keysToUse is empty.
            }

            console.log(`parseTsvData [${dataType}]: Using STD_KEYS object:`, keysToUse);


            for (let i = 1; i < lines.length; i++) { // Start from line 1 (data rows)
                const lineContent = lines[i].trim();
                if (!lineContent) continue; // Skip empty lines

                try {
                    const values = lineContent.split('\t');
                    const rowObject = {};
                    let hasData = false;

                    // Iterate over the defined JS property names in keysToUse (e.g., "PAY_DAY", "VATABLE_RECEIPT")
                    for (const jsPropertyName in keysToUse) {
                        // Get the standardized header string that this JS property corresponds to
                        // (e.g., for jsPropertyName "VATABLE_RECEIPT", standardizedFileHeaderKey might be "VATABLE_RECEIPT")
                        const standardizedFileHeaderKey = keysToUse[jsPropertyName];

                        // Find the index of this standardized header in the *input file's* header map
                        const index = headerIndexMap[standardizedFileHeaderKey];

                        if (index !== undefined && index < values.length) {
                            const value = values[index].trim();
                            rowObject[jsPropertyName] = value; // Assign to the desired JS property name
                            if (value) hasData = true;
                        } else {
                            rowObject[jsPropertyName] = ''; // Ensure property exists even if not found
                            // if (dataType !== "Payroll") console.warn(`parseTsvData [${dataType}]: Standardized key "${standardizedFileHeaderKey}" for JS prop "${jsPropertyName}" not found in input headerIndexMap or data missing. Index: ${index}`);
                        }
                    }


                    if (Object.keys(keysToUse).length === 0 && headersArray) { // Fallback if no STD_KEYS defined for dataType but headersArray passed
                         console.warn(`parseTsvData [${dataType}]: No STD_KEYS, attempting fallback using headersArray.`);
                         headersArray.forEach((expectedHeader, idx) => {
                             const standardizedKey = standardizeHeaderKey(expectedHeader);
                             const fileHeaderIndex = headerIndexMap[standardizedKey];
                             if (fileHeaderIndex !== undefined && fileHeaderIndex < values.length) {
                                 const value = values[fileHeaderIndex].trim();
                                 // Use standardizedKey as property if no explicit JS prop is defined
                                 rowObject[standardizedKey] = value;
                                 if(value) hasData = true;
                             } else {
                                 rowObject[standardizedKey] = '';
                             }
                         });
                     }


                    if (hasData) {
                        data.push(rowObject);
                    }
                    if (i === 1 && data.length > 0) { console.log(`parseTsvData [${dataType}]: First parsed row object (using JS property names):`, data[0]); }

                } catch (error) {
                    console.error(`parseTsvData [${dataType}]: Error processing line ${i + 1}: "${lineContent}"`, error);
                }
            }
            console.log(`parseTsvData [${dataType}]: Finished parsing. ${data.length} valid data rows created.`);
            return data;
        }


        // --- Define Headers Arrays (for user reference in placeholders, STD_KEYS are used for processing) ---
        const salesHeaders = ["Date", "Invoice #", "TIN", "Customer Name", "Address", "Vatable Receipt", "Exempt Receipt", "NonReportable Receipt", "Gross Receipt", "2307 IT", "2307 WV", "PWD/SC Discount", "Retention Receivable", "Recoupment Payable", "Net Receipt", "Net of VAT", "Account Title", "VAT", "Validation", "2307 IT Validate", "2307 WB Validate"];
        const purchasesExpensesHeaders = ["Date", "Supplier Invoice #", "TIN", "Supplier Name", "Address", "Vatable", "Non-Vatable", "Non-BIR", "Gross Expense", "Withholding Tax", "Net Expense", "Account Title", "Net of VAT", "VAT", "ATC", "Validation", "Validation on WTax"];
        const payrollHeaders = ["Pay_Day", "Employee Name", "Category", "Basic Pay", "Holiday Pay", "Overtime Pay", "Nigh Shift Differential", "De Minimis", "13th Month", "Gross Pay", "SSS - ER/EC", "SSS - EE", "PHIC - ER", "PHIC - EE", "HDMF - ER", "HDMF - EE", "Taxable Pay", "Tax Withheld", "Net Pay", "SSS,PHIC,HDMF - EE", "Account Title", "Contribution Expense", "SSS Loan", "HDMF Loan"];

        // --- Safe Float Parser ---
        const safeParseFloat = (valueString) => {
            if (valueString === undefined || valueString === null || typeof valueString !== 'string') {
                return 0;
            }
            const num = parseFloat(valueString.replace(/,/g, ''));
            return isNaN(num) ? 0 : num;
        };
        // --- Display Logic (Main) ---
        function displayContentBasedOnSelection(targetId, wrapperEl, title) {
            console.log(`Attempting to display: ${targetId}`);
            let rType, period, year, pText;
            const isReturns = wrapperEl === returnDisplayContentWrapper;
            const typeSel = isReturns ? returnsReportingType : reportsReportingType;
            const pSel = isReturns ? returnsPeriodSelect : reportsPeriodSelect;
            const yInput = isReturns ? returnsYearInput : reportsYearInput;

            rType = typeSel.value;
            period = pSel.value;
            pText = pSel.options[pSel.selectedIndex]?.text || period;
            year = yInput.value;

            wrapperEl.innerHTML = '';
            if (!isReturns && datFileGenerationArea) datFileGenerationArea.classList.add('hidden');
            wrapperEl.classList.add('printable-area');

            if (!year || isNaN(parseInt(year)) || year < 2000 || year > 2099 ) {
                wrapperEl.innerHTML = '<p class="text-red-500 font-semibold">Invalid or missing Year. Please enter a valid year (e.g., 2024).</p>';
                return;
            }
             if (!period && rType !== 'annual') {
                 wrapperEl.innerHTML = '<p class="text-red-500 font-semibold">Invalid or missing Period. Please select a period.</p>';
                 return;
             }

            console.log(`Displaying: ${title} (${targetId}) for Filters - Type: ${rType}, Period: ${period} (${pText}), Year: ${year}`);

            let headHtml = `<div class="report-header-info"><p><strong>Name:</strong> ${appSettings.name || 'N/A'}</p><p><strong>TIN:</strong> ${appSettings.tin || 'N/A'}</p><p><strong>Address:</strong> ${appSettings.address || 'N/A'}</p><p><strong>Industry:</strong> ${appSettings.industry || 'N/A'}</p><p><strong>Report:</strong> ${title || targetId}</p><p><strong>Period:</strong> ${pText} ${year}</p></div>`;
            let actBtnHtml = `<div class="report-actions"><button id="${isReturns ? 'print-return-button' : 'print-report-button'}" class="print-button">Print</button><button id="${isReturns ? 'copy-return-button' : 'copy-report-button'}" class="copy-button">Copy Data</button></div>`;

            let mainContentHtml = '';
            let calculatedReturnData = {};
            try {
                 if (targetId === 'report-qap') mainContentHtml = generateQapReport(rType, period, year);
                 else if (targetId === 'report-slp') mainContentHtml = generateSlpReport(rType, period, year);
                 else if (targetId === 'report-sls') mainContentHtml = generateSlsReport(rType, period, year);
                 else if (targetId === 'report-vat-summary') mainContentHtml = generateSawtVatReport(rType, period, year);
                 else if (targetId === 'report-income-tax-summary') mainContentHtml = generateSawtItReport(rType, period, year);
                 else if (targetId === 'report-payroll-summary') mainContentHtml = generatePayrollSummaryReport(rType, period, year);
                 else if (targetId === 'report-sss-phic-hdmf') mainContentHtml = generateSssPhicHdmfReport(rType, period, year); // NEW
                 else if (targetId === 'report-general-ledger') mainContentHtml = generateGeneralLedgerReport(rType, period, year);
                 else if (targetId === 'report-input-tax-sources') mainContentHtml = generateSourcesOfInputTaxesReport(rType, period, year);
     		     else if (targetId === 'report-recon-wht') mainContentHtml = generateReconWHTReport(rType, period, year);

                 else if (targetId === 'return-1601eq') mainContentHtml = generate1601EQReturn(rType, period, year);
                 else if (targetId === 'return-2551q') mainContentHtml = generate2551QReturn(rType, period, year);
                 else if (targetId === 'return-itr') {
                     const isInd = appSettings.classification === 'individual';
                     const is8 = isInd && appSettings.taxTypes.includes('it-8');
                     if (isInd) {
                        mainContentHtml = is8 ? generateITR8PercentReturn(rType, period, year, calculatedReturnData) : generate1701QReturn(rType, period, year, calculatedReturnData);
                     } else {
                         mainContentHtml = generate1702QReturn(rType, period, year, calculatedReturnData);
                     }
                 }
                 else if (targetId === 'return-2550q') mainContentHtml = generate2550QReturn(rType, period, year, calculatedReturnData);
                 else if (targetId === 'return-1601c') mainContentHtml = generate1601CReturn(rType, period, year);
                 else if (targetId === 'return-1604c') mainContentHtml = `<p class="text-orange-500 font-medium">1604C (Annual Compensation Alphalist Generation) not yet implemented.</p>`;
                 else if (targetId === 'return-1604e') mainContentHtml = `<p class="text-orange-500 font-medium">1604E (Annual EWT Alphalist Generation) not yet implemented.</p>`;
                 else {
                     mainContentHtml = `<p class="text-orange-500">Placeholder: Report/Return generation for <strong>${targetId}</strong> is not implemented yet.</p>`;
                 }

                if (!mainContentHtml) {
                    mainContentHtml = `<p class="text-gray-500">No data generated or report not applicable for the selected filters.</p>`;
                }
            }
            catch (err) {
                 console.error(`Error generating MAIN content for ${targetId}:`, err);
                 mainContentHtml = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert"><strong class="font-bold">Error Generating Report!</strong><span class="block sm:inline">An error occurred while generating '${title}'. Check console for details.</span><pre class="mt-2 text-xs whitespace-pre-wrap">${err.message}\n${err.stack}</pre></div>`;
            }
            const combinedHtml = headHtml + actBtnHtml + `<div id="report-content-body">${mainContentHtml}</div>`;
            wrapperEl.innerHTML = combinedHtml;

            if (isReturns && (targetId === 'return-itr' || targetId === 'return-2550q')) {
                 const returnCompDiv = wrapperEl.querySelector('.return-computation');
                 if (returnCompDiv) {
                     const recalcBtn = wrapperEl.querySelector('.recalculate-button');
                     if (recalcBtn) {
                         console.log(`Triggering initial calculation/benchmark for ${targetId}`);
                         setTimeout(() => handleRecalculate({ target: recalcBtn }), 0);
                     } else {
                        console.warn("No recalc button found for initial benchmark calculation.");
                     }
                 }
            }

            if (!isReturns && datFileGenerationArea) {
                datFileGenerationArea.classList.toggle('hidden', rType !== 'monthly');
            }
            attachActionListeners(isReturns);
            const recalcBtns = wrapperEl.querySelectorAll('.recalculate-button');
            recalcBtns.forEach(b => {
                b.removeEventListener('click', handleRecalculate);
                b.addEventListener('click', handleRecalculate);
            });
        }

        // --- Helper Functions ---
        function getQuarterEndDate(y, q) { let m, d; if (q === 1) { m = 3; d = 31; } else if (q === 2) { m = 6; d = 30; } else if (q === 3) { m = 9; d = 30; } else if (q === 4) { m = 12; d = 31; } else { return "Invalid"; } const mm = String(m).padStart(2, '0'); const dd = String(d).padStart(2, '0'); return `${mm}/${dd}/${y}` }
        function getMonthEndDate(y, m) { if (m < 1 || m > 12) return "Invalid"; const ld = new Date(y, m, 0).getDate(); const mm = String(m).padStart(2, '0'); const dd = String(ld).padStart(2, '0'); return `${mm}/${dd}/${y}` }
        function nf(v, d = 2, returnZeroIfNaN = false) {
            const num = parseFloat(String(v).replace(/,/g, ''));
            if (v === undefined || v === null || isNaN(num)) {
                return returnZeroIfNaN ? (0).toFixed(d) : '0.00';
            }
            return num.toLocaleString(undefined, { minimumFractionDigits: d, maximumFractionDigits: d });
        }
        function calculateTaxDue(ti) { const num = parseFloat(String(ti).replace(/,/g, '')); if (isNaN(num) || num <= 0) return 0; const taxableIncome = Math.max(0, num); if (taxableIncome <= 250000) return 0; else if (taxableIncome <= 400000) return (taxableIncome - 250000) * 0.15; else if (taxableIncome <= 800000) return 22500 + (taxableIncome - 400000) * 0.20; else if (taxableIncome <= 2000000) return 102500 + (taxableIncome - 800000) * 0.25; else if (taxableIncome <= 8000000) return 402500 + (taxableIncome - 2000000) * 0.30; else return 2202500 + (taxableIncome - 8000000) * 0.35; }
        function getPeriodMonths(reportingType, period) { const months = []; if (reportingType === 'monthly') { months.push(parseInt(period.substring(1))); } else if (reportingType === 'quarterly') { const q = parseInt(period.substring(1)); if (q === 1) months.push(1, 2, 3); else if (q === 2) months.push(4, 5, 6); else if (q === 3) months.push(7, 8, 9); else if (q === 4) months.push(10, 11, 12); } else if (reportingType === 'annual') { months.push(1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12); } return months; }
        function getPeriodEndDateString(year, reportingType, period) { if (reportingType === 'monthly') { return getMonthEndDate(year, parseInt(period.substring(1))); } else if (reportingType === 'quarterly') { return getQuarterEndDate(year, parseInt(period.substring(1))); } else if (reportingType === 'annual') { return `12/31/${year}`; } return "Invalid Period"; }

        // --- Report Generation Functions ---
        function generateQapReport(reportingType, period, year) {
            console.log(`Entering generateQapReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`); if (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0) { return '<p class="text-gray-600">No Purchases/Expenses data available.</p>'; } const yearNum = parseInt(year); const periodMonths = getPeriodMonths(reportingType, period); const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period); const atcTaxRateMap = { "WI100": 0.05, "WC100": 0.05, "WI158": 0.01, "WC158": 0.01, "WI160": 0.02, "WC160": 0.02, "WI010": 0.01, "WI011": 0.01 };
            const periodFilteredData = processedData.purchasesExpenses.filter(row => { try { if (!row.DATE) return false; const date = new Date(row.DATE); if (isNaN(date.getTime())) return false; const rowYear = date.getFullYear(); const rowMonth = date.getMonth() + 1; const atc = row.ATC?.trim(); const hasValidAtc = atc && atc !== '0' && atcTaxRateMap.hasOwnProperty(atc); return rowYear === yearNum && periodMonths.includes(rowMonth) && hasValidAtc; } catch (e) { console.error("Error filtering QAP row:", row, e); return false; } }); console.log(`QAP - Period ${period}: Filtered ${periodFilteredData.length} rows with valid ATC.`); if (periodFilteredData.length === 0) { return `<p class="text-gray-600">No QAP data found with valid ATC for the selected period.</p>`; }
            const periodGroupedData = {}; periodFilteredData.forEach(row => { const atc = row.ATC.trim(); const tin = row.TIN?.trim() || 'NO_TIN'; const groupKey = `${atc}|${tin}`; if (!periodGroupedData[groupKey]) { periodGroupedData[groupKey] = { atc: atc, tin: row.TIN?.trim(), supplierName: row.SUPPLIER_NAME || 'N/A', address: row.ADDRESS || 'N/A', periodTaxBase: 0, periodWithheld: 0 }; } const v = safeParseFloat(row.VATABLE); const nv = safeParseFloat(row.NON_VATABLE); const wt = safeParseFloat(row.WITHHOLDING_TAX); if (!isNaN(v)) periodGroupedData[groupKey].periodTaxBase += (v / 1.12); if (!isNaN(nv)) periodGroupedData[groupKey].periodTaxBase += nv; if (!isNaN(wt)) periodGroupedData[groupKey].periodWithheld += wt; });
            const outputRows = Object.values(periodGroupedData).filter(g => g.periodTaxBase > 0 || g.periodWithheld > 0); let grandTotalTaxBase = 0; let grandTotalWithheld = 0; outputRows.forEach(g => { grandTotalTaxBase += g.periodTaxBase; grandTotalWithheld += g.periodWithheld; }); if (outputRows.length === 0) { return `<p class="text-gray-600">No QAP data found with values for the selected period.</p>`; } outputRows.sort((a, b) => { if (a.atc < b.atc) return -1; if (a.atc > b.atc) return 1; if (a.supplierName < b.supplierName) return -1; if (a.supplierName > b.supplierName) return 1; return 0; });
            let summaryHtml = `<div class="summary-box qap-summary-box"><div class="summary-item qap-summary-item"><span>Total Tax Base</span><strong>${nf(grandTotalTaxBase)}</strong></div><div class="summary-item qap-summary-item"><span>Total Amount Withheld</span><strong>${nf(grandTotalWithheld)}</strong></div></div>`; let tableHtml = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Period End</th><th>TIN</th><th>Supplier Name</th><th>Address</th><th>ATC</th><th>Tax Rate</th><th>Tax Base</th><th>Amount Withheld</th></tr></thead><tbody>`; outputRows.forEach(row => { const taxRate = atcTaxRateMap[row.atc] || 0; tableHtml += `<tr><td>${periodEndDateStr}</td><td>${row.tin || ''}</td><td>${row.supplierName || ''}</td><td>${row.address || ''}</td><td>${row.atc}</td><td class="number">${(taxRate * 100).toFixed(2)}%</td><td class="number">${nf(row.periodTaxBase)}</td><td class="number">${nf(row.periodWithheld)}</td></tr>`; }); tableHtml += `</tbody><tfoot><tr><td colspan="6" class="text-right font-semibold">Grand Totals (${reportingType}):</td><td class="number font-semibold">${nf(grandTotalTaxBase)}</td><td class="number font-semibold">${nf(grandTotalWithheld)}</td></tr></tfoot></table></div><p class="text-xs text-gray-500 mt-4">* Tax Base = (Vatable/1.12) + Non-Vatable. Filters by ATC with known rates.</p>`; return summaryHtml + tableHtml;
        }
        function generateSlpReport(reportingType, period, year) {
            console.log(`Entering generateSlpReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`); if (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0) { return '<p class="text-gray-600">No Purchases/Expenses data available.</p>'; } const yearNum = parseInt(year); const periodMonths = getPeriodMonths(reportingType, period); const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period); let grandTotalGrossVatable = 0; let grandTotalVatableNet = 0; let grandTotalExempt = 0; let grandTotalVat = 0;
            const periodFilteredData = processedData.purchasesExpenses.filter(row => { try { if (!row.DATE) return false; const d = new Date(row.DATE); if (isNaN(d.getTime())) return false; const y = d.getFullYear(); const m = d.getMonth() + 1; const v = safeParseFloat(row.VATABLE); const nv = safeParseFloat(row.NON_VATABLE); return y === yearNum && periodMonths.includes(m) && (v > 0 || nv > 0); } catch (e) { console.error("Error filtering SLP row:", row, e); return false; } }); console.log(`SLP - Period ${period}: Filtered ${periodFilteredData.length} rows with purchases.`); if (periodFilteredData.length === 0) { return `<p class="text-gray-600">No SLP data found for the selected period.</p>`; }
            const periodGroupedData = {}; periodFilteredData.forEach(row => { const tin = row.TIN?.trim(); const key = tin || `NO_TIN_${row.SUPPLIER_NAME?.trim() || 'Unknown'}`; if (!periodGroupedData[key]) { periodGroupedData[key] = { tin: tin, supplierName: row.SUPPLIER_NAME || 'N/A', address: row.ADDRESS || 'N/A', periodVatableSum: 0, periodNonVatableSum: 0, periodInputVatSum: 0 }; } const v = safeParseFloat(row.VATABLE); const nv = safeParseFloat(row.NON_VATABLE); const inputVat = safeParseFloat(row.VAT_PURCH); if (!isNaN(v)) periodGroupedData[key].periodVatableSum += v; if (!isNaN(nv)) periodGroupedData[key].periodNonVatableSum += nv; if (!isNaN(inputVat) && inputVat > 0) { periodGroupedData[key].periodInputVatSum += inputVat; } });
            const outputRows = []; for (const key in periodGroupedData) { const group = periodGroupedData[key]; const grossVatable = group.periodVatableSum; const vatableNet = grossVatable / 1.12; const exempt = group.periodNonVatableSum; const finalVat = (group.periodInputVatSum > 0) ? group.periodInputVatSum : (vatableNet * 0.12); if (grossVatable > 0 || exempt > 0) { outputRows.push({ period: periodEndDateStr, tin: group.tin, supplierName: group.supplierName, address: group.address, grossVatable: grossVatable, vatablePurchaseNet: vatableNet, exemptPurchase: exempt, vat: finalVat }); grandTotalGrossVatable += grossVatable; grandTotalVatableNet += vatableNet; grandTotalExempt += exempt; grandTotalVat += finalVat; } }
            if (outputRows.length === 0) { return `<p class="text-gray-600">No SLP data found with values for the selected period.</p>`; } outputRows.sort((a, b) => { if (a.supplierName < b.supplierName) return -1; if (a.supplierName > b.supplierName) return 1; return 0; });
            let summaryHtml = `<div class="summary-box slp-summary-box"><div class="summary-item slp-summary-item"><span>Total Vatable Purchase (Net)</span><strong>${nf(grandTotalVatableNet)}</strong></div><div class="summary-item slp-summary-item"><span>Total Exempt Purchase</span><strong>${nf(grandTotalExempt)}</strong></div><div class="summary-item slp-summary-item"><span>Total Input VAT</span><strong>${nf(grandTotalVat)}</strong></div></div>`; let tableHtml = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Period End</th><th>TIN</th><th>Name</th><th>Address</th><th>Gross Vatable</th><th>Vatable Purchase (net)</th><th>Exempt Purchase</th><th>Input VAT</th></tr></thead><tbody>`; outputRows.forEach(row => { tableHtml += `<tr><td>${row.period}</td><td>${row.tin || ''}</td><td>${row.supplierName || ''}</td><td>${row.address || ''}</td><td class="number">${nf(row.grossVatable)}</td><td class="number">${nf(row.vatablePurchaseNet)}</td><td class="number">${nf(row.exemptPurchase)}</td><td class="number">${nf(row.vat)}</td></tr>`; }); tableHtml += `</tbody><tfoot><tr><td colspan="4" class="text-right font-semibold">Totals (${reportingType}):</td><td class="number font-semibold">${nf(grandTotalGrossVatable)}</td><td class="number font-semibold">${nf(grandTotalVatableNet)}</td><td class="number font-semibold">${nf(grandTotalExempt)}</td><td class="number font-semibold">${nf(grandTotalVat)}</td></tr></tfoot></table></div><p class="text-xs text-gray-500 mt-4">* Vatable Purchase (net) = Vatable / 1.12. Exempt = Non-Vatable. VAT uses input 'VAT' column if present, else calculated.</p>`; return summaryHtml + tableHtml;
        }
        function generateSlsReport(reportingType, period, year) {
            console.log(`Entering generateSlsReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`); if (!processedData.sales || processedData.sales.length === 0) { return '<p class="text-gray-600">No Sales data available.</p>'; } const yearNum = parseInt(year); const periodMonths = getPeriodMonths(reportingType, period); const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period); let grandTotalGrossVatable = 0; let grandTotalVatableNet = 0; let grandTotalExempt = 0; let grandTotalVat = 0;
            const periodFilteredData = processedData.sales.filter(row => { try { if (!row.DATE) return false; const d = new Date(row.DATE); if (isNaN(d.getTime())) return false; const y = d.getFullYear(); const m = d.getMonth() + 1; const vr = safeParseFloat(row.VATABLE_RECEIPT); const er = safeParseFloat(row.EXEMPT_RECEIPT); return y === yearNum && periodMonths.includes(m) && (vr > 0 || er > 0); } catch (e) { console.error("Error filtering SLS row:", row, e); return false; } }); console.log(`SLS - Period ${period}: Filtered ${periodFilteredData.length} rows with sales.`); if (periodFilteredData.length === 0) { return `<p class="text-gray-600">No SLS data found for the selected period.</p>`; }
            const periodGroupedData = {}; periodFilteredData.forEach(row => { const tin = row.TIN?.trim(); const key = tin || `NO_TIN_${row.CUSTOMER_NAME?.trim() || 'Unknown'}`; if (!periodGroupedData[key]) { periodGroupedData[key] = { tin: tin, customerName: row.CUSTOMER_NAME || 'N/A', address: row.ADDRESS || 'N/A', periodVatableSum: 0, periodExemptSum: 0, periodOutputVatSum: 0 }; } const vr = safeParseFloat(row.VATABLE_RECEIPT); const er = safeParseFloat(row.EXEMPT_RECEIPT); const v = safeParseFloat(row.VAT_SALES); if (!isNaN(vr)) periodGroupedData[key].periodVatableSum += vr; if (!isNaN(er)) periodGroupedData[key].periodExemptSum += er; if (!isNaN(v) && v > 0) periodGroupedData[key].periodOutputVatSum += v; });
            const outputRows = []; for (const key in periodGroupedData) { const group = periodGroupedData[key]; const grossVatable = group.periodVatableSum; const vatableNet = grossVatable / 1.12; const exempt = group.periodExemptSum; const outputVat = (group.periodOutputVatSum > 0) ? group.periodOutputVatSum : (vatableNet * 0.12); if(grossVatable > 0 || exempt > 0) { outputRows.push({ period: periodEndDateStr, tin: group.tin, customerName: group.customerName, address: group.address, grossVatable: grossVatable, vatableSalesNet: vatableNet, exemptSales: exempt, vat: outputVat }); grandTotalGrossVatable += grossVatable; grandTotalVatableNet += vatableNet; grandTotalExempt += exempt; grandTotalVat += outputVat; } }
            if (outputRows.length === 0) { return `<p class="text-gray-600">No SLS data found with values for the selected period.</p>`; } outputRows.sort((a, b) => { if (a.customerName < b.customerName) return -1; if (a.customerName > b.customerName) return 1; return 0; });
            let summaryHtml = `<div class="summary-box sls-summary-box"><div class="summary-item sls-summary-item"><span>Total Vatable Sales (Net)</span><strong>${nf(grandTotalVatableNet)}</strong></div><div class="summary-item sls-summary-item"><span>Total Exempt Sales</span><strong>${nf(grandTotalExempt)}</strong></div><div class="summary-item sls-summary-item"><span>Total Output Tax</span><strong>${nf(grandTotalVat)}</strong></div></div>`; let tableHtml = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Period End</th><th>TIN</th><th>Name</th><th>Address</th><th>Gross Vatable</th><th>Vatable Sales (net)</th><th>Exempt Sales</th><th>Output VAT</th></tr></thead><tbody>`; outputRows.forEach(row => { tableHtml += `<tr><td>${row.period}</td><td>${row.tin || ''}</td><td>${row.customerName || ''}</td><td>${row.address || ''}</td><td class="number">${nf(row.grossVatable)}</td><td class="number">${nf(row.vatableSalesNet)}</td><td class="number">${nf(row.exemptSales)}</td><td class="number">${nf(row.vat)}</td></tr>`; }); tableHtml += `</tbody><tfoot><tr><td colspan="4" class="text-right font-semibold">Totals (${reportingType}):</td><td class="number font-semibold">${nf(grandTotalGrossVatable)}</td><td class="number font-semibold">${nf(grandTotalVatableNet)}</td><td class="number font-semibold">${nf(grandTotalExempt)}</td><td class="number font-semibold">${nf(grandTotalVat)}</td></tr></tfoot></table></div><p class="text-xs text-gray-500 mt-4">* Vatable Sales (net) = Vatable Receipt / 1.12. Exempt = Exempt Receipt. Output VAT uses 'VAT' column if present, else calculated.</p>`; return summaryHtml + tableHtml;
        }
        function generateSawtVatReport(reportingType, period, year) {
            console.log(`Entering generateSawtVatReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`); if (!processedData.sales || processedData.sales.length === 0) { return '<p class="text-gray-600">No Sales data available.</p>'; } const yearNum = parseInt(year); const periodMonths = getPeriodMonths(reportingType, period); const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period); let grandTotalGrossSales = 0; let grandTotalWithheld = 0;
            const periodFilteredData = processedData.sales.filter(row => { try { if (!row.DATE) return false; const date = new Date(row.DATE); if (isNaN(date.getTime())) return false; const rowYear = date.getFullYear(); const rowMonth = date.getMonth() + 1; const withheldValue = safeParseFloat(row._2307_WV); const rateStr = row._2307_WB_VALIDATE?.replace(/%|,/g, '').trim(); const taxRateVal = parseFloat(rateStr); return rowYear === yearNum && periodMonths.includes(rowMonth) && !isNaN(taxRateVal) && taxRateVal > 0 && !isNaN(withheldValue) && withheldValue > 0; } catch (e) { console.error("Error filtering SAWT VAT row:", row, e); return false; } }); console.log(`SAWT VAT - Period ${period}: Filtered ${periodFilteredData.length} rows with validated WB rate and WV amount.`); if (periodFilteredData.length === 0) { return `<p class="text-gray-600">No SAWT (VAT/PT) data found. Check '2307 WV' has values and '2307 WB Validate' has rates > 0%.</p>`; }
            const periodGroupedData = {}; periodFilteredData.forEach(row => { const rateStr = row._2307_WB_VALIDATE?.replace(/%|,/g, '').trim(); const taxRateDecimal = parseFloat(rateStr) / 100; const taxRateGroupKey = taxRateDecimal.toFixed(4); const tin = row.TIN?.trim(); const groupKey = `${taxRateGroupKey}|${tin || `NO_TIN_${row.CUSTOMER_NAME?.trim() || 'Unknown'}`}`; if (!periodGroupedData[groupKey]) { periodGroupedData[groupKey] = { taxRate: taxRateDecimal, tin: tin, customerName: row.CUSTOMER_NAME || 'N/A', address: row.ADDRESS || 'N/A', periodGrossSales: 0, periodWithheld: 0 }; } const vr = safeParseFloat(row.VATABLE_RECEIPT); const er = safeParseFloat(row.EXEMPT_RECEIPT); const wv = safeParseFloat(row._2307_WV); const grossSalesBase = (vr / 1.12) + er; if (!isNaN(grossSalesBase)) periodGroupedData[groupKey].periodGrossSales += grossSalesBase; if (!isNaN(wv)) periodGroupedData[groupKey].periodWithheld += wv; });
            const outputRows = Object.values(periodGroupedData).filter(g => g.periodGrossSales > 0 || g.periodWithheld > 0); outputRows.forEach(g => { grandTotalGrossSales += g.periodGrossSales; grandTotalWithheld += g.periodWithheld; }); if (outputRows.length === 0) { return `<p class="text-gray-600">No SAWT (VAT/PT) data found with values for the selected period.</p>`; } outputRows.sort((a, b) => { if (a.taxRate < b.taxRate) return -1; if (a.taxRate > b.taxRate) return 1; if (a.customerName < b.customerName) return -1; if (a.customerName > b.customerName) return 1; return 0; });
            let summaryHtml = `<div class="summary-box sawt-summary-box"><div class="summary-item sawt-summary-item"><span>Total Gross Sales (Tax Base)</span><strong>${nf(grandTotalGrossSales)}</strong></div><div class="summary-item sawt-summary-item"><span>Total Tax Withheld (VAT/PT)</span><strong>${nf(grandTotalWithheld)}</strong></div></div>`; let tableHtml = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Period End</th><th>TIN</th><th>Name</th><th>Address</th><th>Gross Sales (Base)</th><th>Tax Rate</th><th>Tax Withheld</th></tr></thead><tbody>`; outputRows.forEach(row => { tableHtml += `<tr><td>${periodEndDateStr}</td><td>${row.tin || ''}</td><td>${row.customerName || ''}</td><td>${row.address || ''}</td><td class="number">${nf(row.periodGrossSales)}</td><td class="number">${(row.taxRate * 100).toFixed(2)}%</td><td class="number">${nf(row.periodWithheld)}</td></tr>`; }); tableHtml += `</tbody><tfoot><tr><td colspan="4" class="text-right font-semibold">Totals (${reportingType}):</td><td class="number font-semibold">${nf(grandTotalGrossSales)}</td><td></td><td class="number font-semibold">${nf(grandTotalWithheld)}</td></tr></tfoot></table></div><p class="text-xs text-gray-500 mt-4">* Gross Sales (Base) = (Vatable Receipt / 1.12) + Exempt Receipt. Tax Rate from '2307 WB Validate'. Tax W/h from '2307 WV'.</p>`; return summaryHtml + tableHtml;
        }
        function generateSawtItReport(reportingType, period, year) {
            console.log(`Entering generateSawtItReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`); if (!processedData.sales || processedData.sales.length === 0) { return '<p class="text-gray-600">No Sales data available.</p>'; } const yearNum = parseInt(year); const periodMonths = getPeriodMonths(reportingType, period); const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period); let grandTotalGrossSales = 0; let grandTotalWithheld = 0;
            const periodFilteredData = processedData.sales.filter(row => { try { if (!row.DATE) return false; const date = new Date(row.DATE); if (isNaN(date.getTime())) return false; const rowYear = date.getFullYear(); const rowMonth = date.getMonth() + 1; const withheldValue = safeParseFloat(row._2307_IT); const rateStr = row._2307_IT_VALIDATE?.replace(/%|,/g, '').trim(); const taxRateVal = parseFloat(rateStr); return rowYear === yearNum && periodMonths.includes(rowMonth) && !isNaN(taxRateVal) && taxRateVal > 0 && !isNaN(withheldValue) && withheldValue > 0; } catch (e) { console.error("Error filtering SAWT IT row:", row, e); return false; } }); console.log(`SAWT IT - Period ${period}: Filtered ${periodFilteredData.length} rows with validated IT rate and IT amount.`); if (periodFilteredData.length === 0) { return `<p class="text-gray-600">No SAWT (IT) data found. Check '2307 IT' has values and '2307 IT Validate' has rates > 0%.</p>`; }
            const periodGroupedData = {}; periodFilteredData.forEach(row => { const rateStr = row._2307_IT_VALIDATE?.replace(/%|,/g, '').trim(); const taxRateDecimal = parseFloat(rateStr) / 100; const taxRateGroupKey = taxRateDecimal.toFixed(4); const tin = row.TIN?.trim(); const groupKey = `${taxRateGroupKey}|${tin || `NO_TIN_${row.CUSTOMER_NAME?.trim() || 'Unknown'}`}`; if (!periodGroupedData[groupKey]) { periodGroupedData[groupKey] = { taxRate: taxRateDecimal, tin: tin, customerName: row.CUSTOMER_NAME || 'N/A', address: row.ADDRESS || 'N/A', periodGrossSales: 0, periodWithheld: 0 }; } const vr = safeParseFloat(row.VATABLE_RECEIPT); const er = safeParseFloat(row.EXEMPT_RECEIPT); const it2307 = safeParseFloat(row._2307_IT); const grossSalesBase = (vr / 1.12) + er; if (!isNaN(grossSalesBase)) periodGroupedData[groupKey].periodGrossSales += grossSalesBase; if (!isNaN(it2307)) periodGroupedData[groupKey].periodWithheld += it2307; });
            const outputRows = Object.values(periodGroupedData).filter(g => g.periodGrossSales > 0 || g.periodWithheld > 0); outputRows.forEach(g => { grandTotalGrossSales += g.periodGrossSales; grandTotalWithheld += g.periodWithheld; }); if (outputRows.length === 0) { return `<p class="text-gray-600">No SAWT (IT) data found with values for the selected period.</p>`; } outputRows.sort((a, b) => { if (a.taxRate < b.taxRate) return -1; if (a.taxRate > b.taxRate) return 1; if (a.customerName < b.customerName) return -1; if (a.customerName > b.customerName) return 1; return 0; });
            let summaryHtml = `<div class="summary-box sawt-summary-box"><div class="summary-item sawt-summary-item"><span>Total Gross Sales (Tax Base)</span><strong>${nf(grandTotalGrossSales)}</strong></div><div class="summary-item sawt-summary-item"><span>Total Tax Withheld (IT)</span><strong>${nf(grandTotalWithheld)}</strong></div></div>`; let tableHtml = `<div class="results-table-wrapper"><table class="results-table"><thead><tr><th>Period End</th><th>TIN</th><th>Name</th><th>Address</th><th>Gross Sales (Base)</th><th>Tax Rate</th><th>Tax Withheld</th></tr></thead><tbody>`; outputRows.forEach(row => { tableHtml += `<tr><td>${periodEndDateStr}</td><td>${row.tin || ''}</td><td>${row.customerName || ''}</td><td>${row.address || ''}</td><td class="number">${nf(row.periodGrossSales)}</td><td class="number">${(row.taxRate * 100).toFixed(2)}%</td><td class="number">${nf(row.periodWithheld)}</td></tr>`; }); tableHtml += `</tbody><tfoot><tr><td colspan="4" class="text-right font-semibold">Totals (${reportingType}):</td><td class="number font-semibold">${nf(grandTotalGrossSales)}</td><td></td><td class="number font-semibold">${nf(grandTotalWithheld)}</td></tr></tfoot></table></div><p class="text-xs text-gray-500 mt-4">* Gross Sales (Base) = (Vatable Receipt / 1.12) + Exempt Receipt. Tax Rate from '2307 IT Validate'. Tax W/h from '2307 IT'.</p>`; return summaryHtml + tableHtml;
        }
        function generatePayrollSummaryReport(reportingType, period, year) {
             if (!processedData.payroll || processedData.payroll.length === 0) { return '<p class="text-gray-600">No Payroll data available.</p>'; }
             console.log(`Generating Payroll Summary... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
             const yNum = parseInt(year);
             const periodMonths = getPeriodMonths(reportingType, period);
             const reportingPeriodEndMonth = Math.max(...periodMonths);
             const periodEndDateStr = getPeriodEndDateString(yNum, reportingType, period);

             const empSummaries = {};
             const BEN_LIMIT = 90000;

             processedData.payroll.forEach(r => {
                 try {
                     const name = r.EMPLOYEE_NAME?.trim();
                     if (!name) return;
                     const pdStr = r.PAY_DAY;
                     if (!pdStr) return;
                     const payDate = new Date(pdStr);
                     if (isNaN(payDate.getTime()) || payDate.getFullYear() !== yNum) return;

                     const monthNum = payDate.getMonth() + 1;

                     if (!empSummaries[name]) {
                         empSummaries[name] = {
                             name: name, cat: r.CATEGORY?.trim().toUpperCase() || 'NMWE', tin: r.TIN?.trim() || 'N/A',
                             ytd_bp: 0, ytd_hp: 0, ytd_ot: 0, ytd_nsd: 0,
                             ytd_dm: 0, ytd_13m: 0, ytd_gp: 0,
                             ytd_sss_ee: 0, ytd_phic_ee: 0, ytd_hdmf_ee: 0, ytd_tot_contrib_ee: 0,
                             ytd_wh: 0, ytd_np: 0, ytd_contrib_exp: 0,
                             ytd_sss_loan: 0, ytd_hdmf_loan: 0, // New YTD Loans
                             p_bp: 0, p_hp: 0, p_ot: 0, p_nsd: 0,
                             p_dm: 0, p_13m: 0, p_gp: 0,
                             p_sss_ee: 0, p_phic_ee: 0, p_hdmf_ee: 0, p_tot_contrib_ee: 0,
                             p_wh: 0, p_np: 0, p_contrib_exp: 0,
                             p_sss_loan: 0, p_hdmf_loan: 0, // New Period Loans
                             monthly_dm: Array(12).fill(0), monthly_13m: Array(12).fill(0)
                         };
                     }
                     const sum = empSummaries[name];

                     const bp = safeParseFloat(r.BASIC_PAY);
                     const hp = safeParseFloat(r.HOLIDAY_PAY);
                     const ot = safeParseFloat(r.OVERTIME_PAY);
                     const nsd = safeParseFloat(r.NIGH_SHIFT_DIFFERENTIAL);
                     const dm = safeParseFloat(r.DE_MINIMIS);
                     const ttm = safeParseFloat(r.THIRTEENTH_MONTH);
                     const gp = safeParseFloat(r.GROSS_PAY);
                     const sss = safeParseFloat(r.SSS_EE);
                     const phic = safeParseFloat(r.PHIC_EE);
                     const hdmf = safeParseFloat(r.HDMF_EE);
                     const totComb = safeParseFloat(r.SSS_PHIC_HDMF_EE);
                     const wh = safeParseFloat(r.TAX_WITHHELD);
                     const np = safeParseFloat(r.NET_PAY);
                     const contribExp = safeParseFloat(r.CONTRIBUTION_EXPENSE);
                     const sssLoan = safeParseFloat(r.SSS_LOAN);   // New
                     const hdmfLoan = safeParseFloat(r.HDMF_LOAN); // New
                     let currentPayrollRowContrib = totComb > 0 ? totComb : (sss + phic + hdmf);

                     if (monthNum <= reportingPeriodEndMonth) {
                         sum.ytd_bp += bp; sum.ytd_hp += hp; sum.ytd_ot += ot; sum.ytd_nsd += nsd;
                         sum.ytd_dm += dm; sum.ytd_13m += ttm; sum.ytd_gp += gp;
                         sum.ytd_sss_ee += sss; sum.ytd_phic_ee += phic; sum.ytd_hdmf_ee += hdmf;
                         sum.ytd_tot_contrib_ee += currentPayrollRowContrib;
                         sum.ytd_wh += wh; sum.ytd_np += np; sum.ytd_contrib_exp += contribExp;
                         sum.ytd_sss_loan += sssLoan;   // New
                         sum.ytd_hdmf_loan += hdmfLoan; // New
                         sum.monthly_dm[monthNum - 1] += dm;
                         sum.monthly_13m[monthNum - 1] += ttm;
                     }

                     if (periodMonths.includes(monthNum)) {
                         sum.p_bp += bp; sum.p_hp += hp; sum.p_ot += ot; sum.p_nsd += nsd;
                         sum.p_dm += dm; sum.p_13m += ttm; sum.p_gp += gp;
                         sum.p_sss_ee += sss; sum.p_phic_ee += phic; sum.p_hdmf_ee += hdmf;
                         sum.p_tot_contrib_ee += currentPayrollRowContrib;
                         sum.p_wh += wh; sum.p_np += np; sum.p_contrib_exp += contribExp;
                         sum.p_sss_loan += sssLoan;   // New
                         sum.p_hdmf_loan += hdmfLoan; // New
                     }
                 } catch (e) { console.error("Error processing payroll row for summary:", r, e); }
             });

             const periodRows = [];
             let grandGross = 0, grandNTDisplay = 0, grandTDisplay = 0, grandWH = 0, grandSssLoan = 0, grandHdmfLoan = 0, grandNP = 0, grandContribExp = 0;
             let grandYtdAnnTI = 0, grandYtdAnnTD = 0, grandYtdTaxRefPay = 0;
             let g_ntb_total = 0, g_nth_total = 0, g_nto_total = 0, g_ntn_total = 0;
             let g_ntdm_display_total = 0, g_nt13_display_total = 0, g_ntc_total = 0;
             let g_tb_total = 0, g_tth_total = 0, g_tto_total = 0, g_ttn_total = 0;
             let g_tt13_combined_display_total = 0;

             for (const name in empSummaries) {
                 const empData = empSummaries[name];
                 const cat = empData.cat;

                 if (empData.p_gp === 0 && empData.p_wh === 0 && empData.p_np === 0 && empData.p_contrib_exp === 0 && empData.p_dm === 0 && empData.p_13m === 0 && empData.p_bp === 0 && empData.p_sss_loan === 0 && empData.p_hdmf_loan === 0) continue;

                 const ytd_total_benefits_at_period_end = empData.ytd_dm + empData.ytd_13m;
                 const taxableBenefitPortion_ytd = Math.max(0, ytd_total_benefits_at_period_end - BEN_LIMIT);

                 let dm_before_current_reporting_period_months = 0;
                 let m13_before_current_reporting_period_months = 0;
                 const firstMonthOfCurrentReport = Math.min(...periodMonths);
                 for (let m_idx = 0; m_idx < firstMonthOfCurrentReport - 1; m_idx++) {
                     dm_before_current_reporting_period_months += empData.monthly_dm[m_idx];
                     m13_before_current_reporting_period_months += empData.monthly_13m[m_idx];
                 }
                 const benefits_utilized_before_current_report = dm_before_current_reporting_period_months + m13_before_current_reporting_period_months;
                 let remaining_nontaxable_allowance_at_start_of_report = Math.max(0, BEN_LIMIT - benefits_utilized_before_current_report);

                 const current_period_dm_value = empData.p_dm;
                 const current_period_nontaxable_dm_for_display = Math.min(current_period_dm_value, remaining_nontaxable_allowance_at_start_of_report);
                 const current_period_taxable_dm_for_sum = current_period_dm_value - current_period_nontaxable_dm_for_display;
                 remaining_nontaxable_allowance_at_start_of_report = Math.max(0, remaining_nontaxable_allowance_at_start_of_report - current_period_nontaxable_dm_for_display);

                 const current_period_13m_value = empData.p_13m;
                 const current_period_nontaxable_13m_for_display = Math.min(current_period_13m_value, remaining_nontaxable_allowance_at_start_of_report);
                 const current_period_taxable_13m_for_sum = current_period_13m_value - current_period_nontaxable_13m_for_display;

                 const nt_display_b_val = (cat === 'MWE' || cat === 'NT') ? Math.max(0, empData.p_bp - empData.p_tot_contrib_ee) : 0;
                 const nt_display_h_val = (cat === 'MWE' || cat === 'NT') ? empData.p_hp : 0;
                 const nt_display_o_val = (cat === 'MWE' || cat === 'NT') ? empData.p_ot : 0;
                 const nt_display_n_val = (cat === 'MWE' || cat === 'NT') ? empData.p_nsd : 0;
                 const nt_display_dm_val = current_period_nontaxable_dm_for_display;
                 const nt_display_b13_val = current_period_nontaxable_13m_for_display;
                 const nt_display_c_val = empData.p_tot_contrib_ee;

                 const t_display_b_val = (cat !== 'MWE' && cat !== 'NT') ? Math.max(0, empData.p_bp - empData.p_tot_contrib_ee) : 0;
                 const t_display_h_val = (cat !== 'MWE' && cat !== 'NT') ? empData.p_hp : 0;
                 const t_display_o_val = (cat !== 'MWE' && cat !== 'NT') ? empData.p_ot : 0;
                 const t_display_n_val = (cat !== 'MWE' && cat !== 'NT') ? empData.p_nsd : 0;
                 const t_display_dm_combined_13th_val = current_period_taxable_dm_for_sum + current_period_taxable_13m_for_sum;

                 const totalNT_overall_for_period_display = nt_display_b_val + nt_display_h_val + nt_display_o_val + nt_display_n_val + nt_display_dm_val + nt_display_b13_val + nt_display_c_val;
                 const totalTaxableComp_for_period_display = t_display_b_val + t_display_h_val + t_display_o_val + t_display_n_val + t_display_dm_combined_13th_val;

                 let ytd_ann_tax_inc_calc = 0;
                 if (cat === 'MWE' || cat === 'NT') {
                     ytd_ann_tax_inc_calc = taxableBenefitPortion_ytd;
                 } else {
                     ytd_ann_tax_inc_calc = (empData.ytd_bp - empData.ytd_tot_contrib_ee) + empData.ytd_hp + empData.ytd_ot + empData.ytd_nsd + taxableBenefitPortion_ytd;
                 }
                 ytd_ann_tax_inc_calc = Math.max(0, ytd_ann_tax_inc_calc);
                 const ytd_ann_tax_due_calc = calculateTaxDue(ytd_ann_tax_inc_calc);
                 const ytd_ann_tax_ref_pay_calc = empData.ytd_wh - ytd_ann_tax_due_calc;

                 periodRows.push({
                     p_end_date: periodEndDateStr, name: name, cat: cat, gp: empData.p_gp,
                     ntb: nt_display_b_val, nth: nt_display_h_val, nto: nt_display_o_val, ntn: nt_display_n_val,
                     ntdm: nt_display_dm_val, nt13: nt_display_b13_val, ntc: nt_display_c_val,
                     totNT: totalNT_overall_for_period_display,
                     tb: t_display_b_val, tth: t_display_h_val, tto: t_display_o_val, ttn: t_display_n_val,
                     tt13_combined: t_display_dm_combined_13th_val,
                     totT: totalTaxableComp_for_period_display,
                     p_wh: empData.p_wh,
                     p_sss_loan: empData.p_sss_loan,    // New
                     p_hdmf_loan: empData.p_hdmf_loan,  // New
                     p_np: empData.p_np, p_contrib_exp: empData.p_contrib_exp,
                     ytd_ann_tax_inc: ytd_ann_tax_inc_calc,
                     ytd_ann_tax_due: ytd_ann_tax_due_calc,
                     ytd_ann_tax_ref_pay: ytd_ann_tax_ref_pay_calc
                 });

                 grandGross += empData.p_gp;
                 grandNTDisplay += totalNT_overall_for_period_display;
                 grandTDisplay += totalTaxableComp_for_period_display;
                 grandWH += empData.p_wh;
                 grandSssLoan += empData.p_sss_loan;   // New
                 grandHdmfLoan += empData.p_hdmf_loan; // New
                 grandNP += empData.p_np;
                 grandContribExp += empData.p_contrib_exp;
                 grandYtdAnnTI += ytd_ann_tax_inc_calc;
                 grandYtdAnnTD += ytd_ann_tax_due_calc;
                 grandYtdTaxRefPay += ytd_ann_tax_ref_pay_calc;

                g_ntb_total += nt_display_b_val; g_nth_total += nt_display_h_val; g_nto_total += nt_display_o_val; g_ntn_total += nt_display_n_val;
                g_ntdm_display_total += nt_display_dm_val; g_nt13_display_total += nt_display_b13_val; g_ntc_total += nt_display_c_val;
                g_tb_total += t_display_b_val; g_tth_total += t_display_h_val; g_tto_total += t_display_o_val; g_ttn_total += t_display_n_val;
                g_tt13_combined_display_total += t_display_dm_combined_13th_val;
             }

             if (periodRows.length === 0) { return `<p class="text-gray-600">No Payroll Summary data found for the selected period/year.</p>`; }

             let sumHtml = `<div class="summary-box payroll-summary-box">
                 <div class="summary-item payroll-summary-item"><span>Total Gross Pay (Period)</span><strong>${nf(grandGross)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total Non-Tax Inc (Period)</span><strong>${nf(grandNTDisplay)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total Taxable Comp (Period)</span><strong>${nf(grandTDisplay)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total Tax Withheld (Period)</span><strong>${nf(grandWH)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total SSS Loan (Period)</span><strong>${nf(grandSssLoan)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total HDMF Loan (Period)</span><strong>${nf(grandHdmfLoan)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total Net Pay (Period)</span><strong>${nf(grandNP)}</strong></div>
                 <div class="summary-item payroll-summary-item"><span>Total Contrib Exp (Period)</span><strong>${nf(grandContribExp)}</strong></div>
             </div>`;

             let tblHtml = `<div class="results-table-wrapper"><table class="results-table"><thead>
                 <tr>
                     <th rowspan="2">Period End</th><th rowspan="2">Name</th><th rowspan="2">Cat</th><th rowspan="2">Gross Pay (Period)</th>
                     <th colspan="7">Non-Taxable Income Breakdown (Period)</th> <th rowspan="2">TOTAL NT (Period)</th>
                     <th colspan="5">Taxable Comp Breakdown (Period)</th> <th rowspan="2">TOTAL Taxable (Period)</th>
                     <th rowspan="2">Tax W/h (Period)</th>
                     <th rowspan="2">SSS Loan (Period)</th>  <!-- New -->
                     <th rowspan="2">HDMF Loan (Period)</th> <!-- New -->
                     <th rowspan="2">Net Pay (Period)</th><th rowspan="2">Contrib Exp (Period)</th>
                     <th rowspan="2">YTD Tax Inc (Calc)</th><th rowspan="2">YTD Tax Due (Calc)</th><th rowspan="2">YTD Refund/(Pay)</th>
                 </tr>
                 <tr class="payroll-sub-header">
                     <th>Basic(Net)</th><th>Hol</th><th>OT</th><th>NSD</th><th>DeMin</th><th>13th+</th><th>Contrib</th>
                     <th>Basic(Net)</th><th>Hol</th><th>OT</th><th>NSD</th><th>13th/DM (Taxable)</th>
                 </tr>
             </thead><tbody>`;

             periodRows.forEach(r => {
                 tblHtml += `<tr>
                     <td>${r.p_end_date}</td><td>${r.name}</td><td>${r.cat}</td><td class="number">${nf(r.gp)}</td>
                     <td class="number">${nf(r.ntb)}</td><td class="number">${nf(r.nth)}</td><td class="number">${nf(r.nto)}</td><td class="number">${nf(r.ntn)}</td><td class="number">${nf(r.ntdm)}</td><td class="number">${nf(r.nt13)}</td><td class="number">${nf(r.ntc)}</td>
                     <td class="number font-semibold">${nf(r.totNT)}</td>
                     <td class="number">${nf(r.tb)}</td><td class="number">${nf(r.tth)}</td><td class="number">${nf(r.tto)}</td><td class="number">${nf(r.ttn)}</td><td class="number">${nf(r.tt13_combined)}</td>
                     <td class="number font-semibold">${nf(r.totT)}</td>
                     <td class="number">${nf(r.p_wh)}</td>
                     <td class="number">${nf(r.p_sss_loan)}</td>  <!-- New -->
                     <td class="number">${nf(r.p_hdmf_loan)}</td> <!-- New -->
                     <td class="number">${nf(r.p_np)}</td><td class="number">${nf(r.p_contrib_exp)}</td>
                     <td class="number">${nf(r.ytd_ann_tax_inc)}</td><td class="number">${nf(r.ytd_ann_tax_due)}</td><td class="number">${nf(r.ytd_ann_tax_ref_pay)}</td>
                 </tr>`;
             });

             tblHtml += `</tbody><tfoot><tr>
                 <td colspan="3" class="text-right font-semibold">Totals (Current Period):</td>
                 <td class="number font-semibold">${nf(grandGross)}</td>
                 <td class="number font-semibold">${nf(g_ntb_total)}</td><td class="number font-semibold">${nf(g_nth_total)}</td><td class="number font-semibold">${nf(g_nto_total)}</td><td class="number font-semibold">${nf(g_ntn_total)}</td><td class="number font-semibold">${nf(g_ntdm_display_total)}</td><td class="number font-semibold">${nf(g_nt13_display_total)}</td><td class="number font-semibold">${nf(g_ntc_total)}</td>
                 <td class="number font-semibold">${nf(grandNTDisplay)}</td>
                 <td class="number font-semibold">${nf(g_tb_total)}</td><td class="number font-semibold">${nf(g_tth_total)}</td><td class="number font-semibold">${nf(g_tto_total)}</td><td class="number font-semibold">${nf(g_ttn_total)}</td><td class="number font-semibold">${nf(g_tt13_combined_display_total)}</td>
                 <td class="number font-semibold">${nf(grandTDisplay)}</td>
                 <td class="number font-semibold">${nf(grandWH)}</td>
                 <td class="number font-semibold">${nf(grandSssLoan)}</td>  <!-- New -->
                 <td class="number font-semibold">${nf(grandHdmfLoan)}</td> <!-- New -->
                 <td class="number font-semibold">${nf(grandNP)}</td><td class="number font-semibold">${nf(grandContribExp)}</td>
                 <td class="number font-semibold">${nf(grandYtdAnnTI)}</td><td class="number font-semibold">${nf(grandYtdAnnTD)}</td><td class="number font-semibold">${nf(grandYtdTaxRefPay)}</td>
             </tr></tfoot></table></div>
             <p class="text-xs text-gray-500 mt-4">
                * De Minimis & 13th Month+ are non-taxable up to PHP 90,000 YTD limit (De Minimis prioritized). Excess is under '13th/DM (Taxable)'.<br/>
                * 'YTD Tax Inc', 'YTD Tax Due', 'YTD Refund/(Pay)' show cumulative year-to-date figures based on all payroll data up to the end of the reporting period.
             </p>`;

             return sumHtml + tblHtml;
         }

        function generateSssPhicHdmfReport(reportingType, period, year) {
            console.log(`Entering generateSssPhicHdmfReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
            if (!processedData.payroll || processedData.payroll.length === 0) {
                return '<p class="text-gray-600">No Payroll data available for SSS/PHIC/HDMF Report.</p>';
            }

            const yearNum = parseInt(year);
            const periodMonths = getPeriodMonths(reportingType, period);

            // Filter payroll data for the selected period and year
            const periodPayrollData = processedData.payroll.filter(row => {
                try {
                    if (!row.PAY_DAY) return false;
                    const payDate = new Date(row.PAY_DAY);
                    if (isNaN(payDate.getTime())) return false;
                    return payDate.getFullYear() === yearNum && periodMonths.includes(payDate.getMonth() + 1);
                } catch (e) {
                    console.error("Error filtering payroll for SSS/PHIC/HDMF report:", row, e);
                    return false;
                }
            });

            if (periodPayrollData.length === 0) {
                return `<p class="text-gray-600">No payroll data found for the selected period (${period} ${year}).</p>`;
            }

            let html = '';

            // --- SSS Contribution ---
            const sssContribData = {};
            periodPayrollData.forEach(row => {
                const empName = row.EMPLOYEE_NAME || 'Unknown Employee';
                if (!sssContribData[empName]) {
                    sssContribData[empName] = { erEc: 0, ee: 0 };
                }
                sssContribData[empName].erEc += safeParseFloat(row.SSS_ER_EC);
                sssContribData[empName].ee += safeParseFloat(row.SSS_EE);
            });

            html += `<h4 class="sub-section-title mt-4">SSS Contribution</h4>`;
            if (Object.keys(sssContribData).length > 0) {
                html += `<div class="results-table-wrapper"><table class="results-table">
                            <thead><tr><th>Employee Name</th><th class="number">ER + EC Contrib</th><th class="number">EE Contrib</th><th class="number">Total Remittance</th></tr></thead>
                            <tbody>`;
                let totalSssErEc = 0;
                let totalSssEe = 0;
                let grandTotalSssRemittance = 0;
                Object.keys(sssContribData).sort().forEach(name => {
                    const data = sssContribData[name];
                    const totalRemit = data.erEc + data.ee;
                    html += `<tr><td>${name}</td><td class="number">${nf(data.erEc)}</td><td class="number">${nf(data.ee)}</td><td class="number">${nf(totalRemit)}</td></tr>`;
                    totalSssErEc += data.erEc;
                    totalSssEe += data.ee;
                    grandTotalSssRemittance += totalRemit;
                });
                html += `</tbody><tfoot><tr><td class="font-semibold text-right">Total:</td>
                                <td class="number font-semibold">${nf(totalSssErEc)}</td>
                                <td class="number font-semibold">${nf(totalSssEe)}</td>
                                <td class="number font-semibold">${nf(grandTotalSssRemittance)}</td></tr></tfoot></table></div>`;
            } else {
                html += `<p class="text-gray-500">No SSS contribution data for this period.</p>`;
            }

            // --- SSS Loans ---
            const sssLoanData = {};
            periodPayrollData.forEach(row => {
                const empName = row.EMPLOYEE_NAME || 'Unknown Employee';
                const loanAmount = safeParseFloat(row.SSS_LOAN);
                if (loanAmount > 0) { // Only include if there's a loan amount
                    if (!sssLoanData[empName]) {
                        sssLoanData[empName] = 0;
                    }
                    sssLoanData[empName] += loanAmount;
                }
            });

            html += `<h4 class="sub-section-title mt-6">SSS Loans</h4>`;
            if (Object.keys(sssLoanData).length > 0) {
                html += `<div class="results-table-wrapper"><table class="results-table">
                            <thead><tr><th>Employee Name</th><th class="number">Amount Withheld</th></tr></thead>
                            <tbody>`;
                let totalSssLoan = 0;
                Object.keys(sssLoanData).sort().forEach(name => {
                    const amount = sssLoanData[name];
                    html += `<tr><td>${name}</td><td class="number">${nf(amount)}</td></tr>`;
                    totalSssLoan += amount;
                });
                html += `</tbody><tfoot><tr><td class="font-semibold text-right">Total:</td>
                                <td class="number font-semibold">${nf(totalSssLoan)}</td></tr></tfoot></table></div>`;
            } else {
                html += `<p class="text-gray-500">No SSS loan data for this period.</p>`;
            }

            // --- HDMF Contribution ---
            const hdmfContribData = {};
            periodPayrollData.forEach(row => {
                const empName = row.EMPLOYEE_NAME || 'Unknown Employee';
                if (!hdmfContribData[empName]) {
                    hdmfContribData[empName] = { er: 0, ee: 0 };
                }
                hdmfContribData[empName].er += safeParseFloat(row.HDMF_ER);
                hdmfContribData[empName].ee += safeParseFloat(row.HDMF_EE);
            });

            html += `<h4 class="sub-section-title mt-6">HDMF Contribution</h4>`;
            if (Object.keys(hdmfContribData).length > 0) {
                html += `<div class="results-table-wrapper"><table class="results-table">
                            <thead><tr><th>Employee Name</th><th class="number">ER</th><th class="number">EE</th><th class="number">Total</th></tr></thead>
                            <tbody>`;
                let totalHdmfEr = 0;
                let totalHdmfEe = 0;
                let grandTotalHdmf = 0;
                Object.keys(hdmfContribData).sort().forEach(name => {
                    const data = hdmfContribData[name];
                    const total = data.er + data.ee;
                    html += `<tr><td>${name}</td><td class="number">${nf(data.er)}</td><td class="number">${nf(data.ee)}</td><td class="number">${nf(total)}</td></tr>`;
                    totalHdmfEr += data.er;
                    totalHdmfEe += data.ee;
                    grandTotalHdmf += total;
                });
                html += `</tbody><tfoot><tr><td class="font-semibold text-right">Total:</td>
                                <td class="number font-semibold">${nf(totalHdmfEr)}</td>
                                <td class="number font-semibold">${nf(totalHdmfEe)}</td>
                                <td class="number font-semibold">${nf(grandTotalHdmf)}</td></tr></tfoot></table></div>`;
            } else {
                html += `<p class="text-gray-500">No HDMF contribution data for this period.</p>`;
            }

            // --- HDMF Loans ---
            const hdmfLoanData = {};
            periodPayrollData.forEach(row => {
                const empName = row.EMPLOYEE_NAME || 'Unknown Employee';
                const loanAmount = safeParseFloat(row.HDMF_LOAN);
                 if (loanAmount > 0) { // Only include if there's a loan amount
                    if (!hdmfLoanData[empName]) {
                        hdmfLoanData[empName] = 0;
                    }
                    hdmfLoanData[empName] += loanAmount;
                }
            });

            html += `<h4 class="sub-section-title mt-6">HDMF Loans</h4>`;
            if (Object.keys(hdmfLoanData).length > 0) {
                html += `<div class="results-table-wrapper"><table class="results-table">
                            <thead><tr><th>Employee Name</th><th class="number">Amount Withheld</th></tr></thead>
                            <tbody>`;
                let totalHdmfLoan = 0;
                Object.keys(hdmfLoanData).sort().forEach(name => {
                    const amount = hdmfLoanData[name];
                    html += `<tr><td>${name}</td><td class="number">${nf(amount)}</td></tr>`;
                    totalHdmfLoan += amount;
                });
                html += `</tbody><tfoot><tr><td class="font-semibold text-right">Total:</td>
                                <td class="number font-semibold">${nf(totalHdmfLoan)}</td></tr></tfoot></table></div>`;
            } else {
                html += `<p class="text-gray-500">No HDMF loan data for this period.</p>`;
            }

            // --- PHIC Contribution ---
            const phicContribData = {};
            periodPayrollData.forEach(row => {
                const empName = row.EMPLOYEE_NAME || 'Unknown Employee';
                if (!phicContribData[empName]) {
                    phicContribData[empName] = { er: 0, ee: 0 };
                }
                phicContribData[empName].er += safeParseFloat(row.PHIC_ER);
                phicContribData[empName].ee += safeParseFloat(row.PHIC_EE);
            });

            html += `<h4 class="sub-section-title mt-6">PHIC Contribution</h4>`;
            if (Object.keys(phicContribData).length > 0) {
                html += `<div class="results-table-wrapper"><table class="results-table">
                            <thead><tr><th>Employee Name</th><th class="number">ER</th><th class="number">EE</th><th class="number">Total</th></tr></thead>
                            <tbody>`;
                let totalPhicEr = 0;
                let totalPhicEe = 0;
                let grandTotalPhic = 0;
                Object.keys(phicContribData).sort().forEach(name => {
                    const data = phicContribData[name];
                    const total = data.er + data.ee;
                    html += `<tr><td>${name}</td><td class="number">${nf(data.er)}</td><td class="number">${nf(data.ee)}</td><td class="number">${nf(total)}</td></tr>`;
                    totalPhicEr += data.er;
                    totalPhicEe += data.ee;
                    grandTotalPhic += total;
                });
                html += `</tbody><tfoot><tr><td class="font-semibold text-right">Total:</td>
                                <td class="number font-semibold">${nf(totalPhicEr)}</td>
                                <td class="number font-semibold">${nf(totalPhicEe)}</td>
                                <td class="number font-semibold">${nf(grandTotalPhic)}</td></tr></tfoot></table></div>`;
            } else {
                html += `<p class="text-gray-500">No PHIC contribution data for this period.</p>`;
            }

            return html;
        }
        // --- Return Generation Functions ---
        function generate1601EQReturn(reportingType, period, year) {
             console.log("Entering generate1601EQReturn..."); if (reportingType !== 'quarterly' && reportingType !== 'monthly') { return '<p class="text-orange-600">1601EQ/0619E is filed Monthly/Quarterly.</p>'; } if (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0) { return '<p class="text-gray-600">No Purchases/Expenses data available.</p>'; } const yearNum = parseInt(year); const atcDescriptionMap = { WI100: "Professional fees (Individual)", WC100: "Professional fees (Corp)", WI158: "Contractors/Subcontractors (Ind)", WC158: "Contractors/Subcontractors (Corp)", WI160: "Income distrib to partners (GPP)", WC160: "Income payments made by GPP", WI010: "Purchase of Goods (Ind)", WI011: "Purchase of Goods (Corp)" }; const atcTaxRateMap = { WI100: 0.05, WC100: 0.05, WI158: 0.01, WC158: 0.01, WI160: 0.02, WC160: 0.02, WI010: 0.01, WI011: 0.01 }; let totalWithheld = 0; let withheldM1 = 0; let withheldM2 = 0; let monthsInPeriod = []; let pLabel = ""; let qNum = null; if (reportingType === 'monthly') { const mNum = parseInt(period.substring(1)); monthsInPeriod.push(mNum); pLabel = periodOptions.monthly.find(m => m.value === period)?.text || period; } else { qNum = parseInt(period.substring(1)); if (qNum === 1) monthsInPeriod = [1, 2, 3]; else if (qNum === 2) monthsInPeriod = [4, 5, 6]; else if (qNum === 3) monthsInPeriod = [7, 8, 9]; else if (qNum === 4) monthsInPeriod = [10, 11, 12]; pLabel = periodOptions.quarterly.find(q => q.value === period)?.text || period; } const periodDataByATC = {};
             processedData.purchasesExpenses.forEach(r => { try { if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return; const y = d.getFullYear(); const m = d.getMonth() + 1; if (y === yearNum && monthsInPeriod.includes(m)) { const atc = r.ATC?.trim(); if (atc && atc !== '0' && atcTaxRateMap.hasOwnProperty(atc)) { const vatable = safeParseFloat(r.VATABLE); const nonVatable = safeParseFloat(r.NON_VATABLE); const withheld = safeParseFloat(r.WITHHOLDING_TAX); const taxBase = (vatable / 1.12) + nonVatable; if (!isNaN(taxBase) && taxBase > 0 && !isNaN(withheld) && withheld > 0) { if (!periodDataByATC[atc]) { periodDataByATC[atc] = { tb: 0, tw: 0, m1tw: 0, m2tw: 0 }; } periodDataByATC[atc].tb += taxBase; periodDataByATC[atc].tw += withheld; totalWithheld += withheld; if (reportingType === 'quarterly') { if (m === monthsInPeriod[0]) periodDataByATC[atc].m1tw += withheld; if (m === monthsInPeriod[1]) periodDataByATC[atc].m2tw += withheld; } } } } } catch (e) { console.error("Error processing 1601EQ row:", r, e); } });
             console.log(`1601EQ - Processed data for ${pLabel} ${year}. Found ATCs:`, Object.keys(periodDataByATC)); if (Object.keys(periodDataByATC).length === 0) { return `<p class="text-gray-600">No EWT data found for ${pLabel} ${year}. Check 'ATC' column has valid codes and 'Withholding Tax' column has amounts > 0.</p>`; } let html = `<div class="return-computation" id="1601eq-computation-area" data-total-withheld="${totalWithheld}">`; const formName = reportingType === 'monthly' ? '0619-E' : '1601-EQ'; html += `<h4 class="section-title mb-4">BIR Form ${formName} (${pLabel} ${year}) - EWT Remittance/Return</h4>`; html += `<div class="results-table-wrapper mb-4"><table class="return-atc-table"><thead><tr><th>ATC</th><th>Nature of Income Payment</th><th class="number">Tax Base</th><th class="number">Rate</th><th class="number">Tax Withheld</th></tr></thead><tbody>`; let totalDueTable = 0; Object.keys(periodDataByATC).sort().forEach(atc => { const data = periodDataByATC[atc]; const desc = atcDescriptionMap[atc] || 'Unknown ATC'; const rate = atcTaxRateMap[atc] || 0; html += `<tr><td>${atc}</td><td>${desc}</td><td class="number">${nf(data.tb)}</td><td class="number">${(rate * 100).toFixed(2)}%</td><td class="number">${nf(data.tw)}</td></tr>`; totalDueTable += data.tw; }); html += `</tbody><tfoot><tr><td colspan="4" class="text-right font-semibold">Total Tax Withheld:</td><td class="number font-semibold">${nf(totalDueTable)}</td></tr></tfoot></table></div>`; html += `<dl>`;
             html += `<div class="computation-row"><dt class="label">1. Total Tax Withheld</dt><dd class="value" id="total-withheld-1601eq">${nf(totalDueTable)}</dd></div>`;
             if (reportingType === 'quarterly') { withheldM1 = Object.values(periodDataByATC).reduce((s, d) => s + d.m1tw, 0); withheldM2 = Object.values(periodDataByATC).reduce((s, d) => s + d.m2tw, 0); const initialPayable = totalDueTable - withheldM1 - withheldM2;
                html += `<div class="computation-row input-row"><label for="remitted-month1" class="label">2. Less: Tax Remitted - 1st Month (0619E)</label><input type="number" id="remitted-month1" value="${nf(withheldM1)}" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="remitted-month2" class="label">3. Less: Tax Remitted - 2nd Month (0619E)</label><input type="number" id="remitted-month2" value="${nf(withheldM2)}" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="penalty-surcharge" class="label">4. Add: Penalties (Surcharge)</label><input type="number" id="penalty-surcharge" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="penalty-interest" class="label">5. Add: Penalties (Interest)</label><input type="number" id="penalty-interest" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="penalty-compromise" class="label">6. Add: Penalties (Compromise)</label><input type="number" id="penalty-compromise" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row total-row"><dt class="label">7. Tax Due / (Overremittance) for 3rd Month</dt><dd class="value total" id="net-tax-due-1601eq">${nf(initialPayable)}</dd></div>`;
                html += `<div class="recalculate-button-wrapper"><button type="button" class="recalculate-button text-xs py-1 px-3" data-return-type="1601eq">Recalculate Total Due</button></div>`; html += `<p class="text-xs text-gray-500 mt-1">* Remitted amounts for Month 1 & 2 are auto-filled but can be manually adjusted. Penalties are manual inputs.</p>`;
            } else { // Monthly 0619E
                html += `<div class="computation-row input-row"><label for="penalty-surcharge" class="label">2. Add: Penalties (Surcharge)</label><input type="number" id="penalty-surcharge" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="penalty-interest" class="label">3. Add: Penalties (Interest)</label><input type="number" id="penalty-interest" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="penalty-compromise" class="label">4. Add: Penalties (Compromise)</label><input type="number" id="penalty-compromise" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row total-row"><dt class="label">5. Total Amount Due for Month</dt><dd class="value total" id="net-tax-due-1601eq">${nf(totalDueTable)}</dd></div>`;
                html += `<div class="recalculate-button-wrapper"><button type="button" class="recalculate-button text-xs py-1 px-3" data-return-type="1601eq">Recalculate Total Due</button></div>`; html += `<p class="text-xs text-gray-500 mt-1">* Penalties are manual inputs.</p>`;
            }
            html += `</dl></div>`;
            html += `<div class="supporting-details"><h4 class="sub-section-title">Supporting Details: QAP</h4>${generateQapReport(reportingType, period, year)}</div>`; return html;
        }
        function generate1601CReturn(reportingType, period, year) {
            console.log("Entering generate1601CReturn...");
            if (reportingType !== 'monthly') { return '<p class="text-orange-600">1601C is filed Monthly.</p>'; }
            if (!processedData.payroll || processedData.payroll.length === 0) { return '<p class="text-gray-600">No Payroll data available.</p>'; }

            const y = parseInt(year);
            const mNum = parseInt(period.substring(1));
            const pLabel = periodOptions.monthly.find(m => m.value === period)?.text || period;

            let line14_totalCompensation = 0;
            let line15A_ntMWEStat = 0;
            let line15B_ntMWEOTH = 0;
            let line15C_ntBen = 0;
            let line15D_ntContrib = 0;
            let line16_taxableL250 = 0;
            let line19_totalWH_from_input = 0;

            // Filter payroll data:
            // 1. For the correct year and month.
            // 2. Exclude records where CATEGORY is 'NT'.
            const filteredPayroll = processedData.payroll.filter(r => {
                try {
                    // --- Date Filtering ---
                    if (!r.PAY_DAY) return false;
                    const d = new Date(r.PAY_DAY);
                    if (isNaN(d.getTime())) return false; // Invalid date
                    const ry = d.getFullYear();
                    const rm = d.getMonth() + 1;
                    const isCorrectPeriod = (ry === y && rm === mNum);

                    if (!isCorrectPeriod) {
                        return false; // Exclude if not in the correct pay period
                    }

                    // --- Category Filtering: Exclude 'NT' ---
                    const recordCategory = r.CATEGORY?.trim().toUpperCase();
                    if (recordCategory === 'NT') {
                        return false; // Exclude if category is 'NT'
                    }

                    return true; // Include if it's the correct period AND not 'NT'
                } catch (e) {
                    console.error("Error during payroll filtering for 1601C:", r, e);
                    return false; // Exclude if any error occurs during filtering this record
                }
            });

            if (filteredPayroll.length === 0) {
                return `<p class="text-gray-600">No qualifying payroll data (after filtering for period and excluding 'NT' category) found for ${pLabel} ${y}.</p>`;
            }

            filteredPayroll.forEach(r => {
                // Since 'NT' records are already filtered out,
                // 'cat' here will be 'MWE', 'L250', or default to 'NMWE'.
                const cat = r.CATEGORY?.trim().toUpperCase() || 'NMWE';
                const bp = safeParseFloat(r.BASIC_PAY);
                const hp = safeParseFloat(r.HOLIDAY_PAY);
                const ot = safeParseFloat(r.OVERTIME_PAY);
                const nsd = safeParseFloat(r.NIGH_SHIFT_DIFFERENTIAL);
                const dm = safeParseFloat(r.DE_MINIMIS);
                const ttm = safeParseFloat(r.THIRTEENTH_MONTH);
                const sss = safeParseFloat(r.SSS_EE);
                const phic = safeParseFloat(r.PHIC_EE);
                const hdmf = safeParseFloat(r.HDMF_EE);
                const totalContribCombined = safeParseFloat(r.SSS_PHIC_HDMF_EE);
                const wh = safeParseFloat(r.TAX_WITHHELD);
                let currentEEContrib = totalContribCombined > 0 ? totalContribCombined : (sss + phic + hdmf);

                // Line 14: Accumulates total compensation for all included employees
                line14_totalCompensation += bp + hp + ot + nsd + dm + ttm;

                // Non-Taxable Compensation Components
                if (cat === 'MWE') {
                    line15A_ntMWEStat += Math.max(0, bp - currentEEContrib); // MWE Basic Pay (net of contributions)
                    line15B_ntMWEOTH += hp + ot + nsd; // MWE Other (Holiday, OT, NSD, Hazard)
                }
                // These are added for ALL non-'NT' employees
                line15C_ntBen += dm + ttm; // 13th Month & Other Benefits (incl. De Minimis)
                line15D_ntContrib += currentEEContrib; // SSS, PHIC, HDMF Contributions (EE Share)

                // Line 16: Taxable Compensation Not Subject to Withholding
                if (cat === 'L250') {
                     // For L250, their entire compensation (net of EE contrib for BP) is considered here as per your logic
                     line16_taxableL250 += (bp - currentEEContrib) + hp + ot + nsd + dm + ttm;
                }
                // Line 19: Total Tax Withheld from included employees
                line19_totalWH_from_input += wh;
            });

            const line15_totalNonTaxable = line15A_ntMWEStat + line15B_ntMWEOTH + line15C_ntBen + line15D_ntContrib;
            // Ensure line16_taxableL250 is not double-deducted if also part of line14
            // The formula 14 - 15 - 16 implies that amounts in 16 are separate from 15 and are subsections of 14.
            const line17_netTaxableSubjectToWH = Math.max(0, line14_totalCompensation - line15_totalNonTaxable - line16_taxableL250);

            let html = `<div class="return-computation" data-return-type="1601c">`; // Added data-return-type for consistency
            html += `<h4 class="section-title mb-4">BIR Form 1601-C (${pLabel} ${y}) - Monthly Remittance Return of Income Taxes Withheld on Compensation</h4>`;
            html += `<dl>`;
            html += `<div class="computation-row"><dt class="label">14. Total Compensation (Current Month)</dt><dd class="value">${nf(line14_totalCompensation)}</dd></div>`;
            html += `<div class="computation-row"><dt class="label">15. Less: Non-Taxable Compensation (Current Month)</dt><dd class="value"></dd></div>`;
            html += `<div class="computation-row sub-item"><dt class="label"> A. Statutory Minimum Wage (MWE Basic Pay, Net of EE Contrib)</dt><dd class="value">${nf(line15A_ntMWEStat)}</dd></div>`;
            html += `<div class="computation-row sub-item"><dt class="label"> B. Holiday, OT, NSD, Hazard Pay (MWE)</dt><dd class="value">${nf(line15B_ntMWEOTH)}</dd></div>`;
            html += `<div class="computation-row sub-item"><dt class="label"> C. 13th Month Pay & Other Benefits (incl De Min.)</dt><dd class="value">${nf(line15C_ntBen)}</dd></div>`;
            html += `<div class="computation-row sub-item"><dt class="label"> D. SSS, PHIC, HDMF Contributions (EE Share)</dt><dd class="value">${nf(line15D_ntContrib)}</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">    Total Non-Taxable (15A+B+C+D)</dt><dd class="value">${nf(line15_totalNonTaxable)}</dd></div>`;
            html += `<div class="computation-row mt-2"><dt class="label">16. Less: Taxable Comp. Not Subject to WH (L250 - Simplified Calc)</dt><dd class="value">${nf(line16_taxableL250)}</dd></div>`;
            html += `<div class="computation-row total-row mt-2"><dt class="label">17. Net Taxable Compensation Subject to WH (14-15-16)</dt><dd class="value">${nf(line17_netTaxableSubjectToWH)}</dd></div>`;
            html += `<div class="computation-row mt-4"><dt class="label">19. Tax Withheld (From Payroll Data for the Month)</dt><dd class="value" id="input-tax-withheld-1601c">${nf(line19_totalWH_from_input)}</dd></div>`;

            html += `<div class="computation-row input-row"><label for="adj-prev-month-1601c" class="label">20A. Add: Tax Withheld - Adjustments (Prev Month)</label><input type="number" id="adj-prev-month-1601c" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="adj-curr-month-1601c" class="label">20B. Less: Tax Withheld - Adjustments (Curr Month)</label><input type="number" id="adj-curr-month-1601c" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row"><dt class="label">20C. Total Tax Withheld As Adjusted</dt><dd class="value total" id="total-wh-adjusted-1601c">${nf(line19_totalWH_from_input)}</dd></div>`; // Initial value before recalc

            html += `<div class="computation-row input-row"><label for="penalty-surcharge-1601c" class="label">21. Add: Penalties (Surcharge)</label><input type="number" id="penalty-surcharge-1601c" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="penalty-interest-1601c" class="label">22. Add: Penalties (Interest)</label><input type="number" id="penalty-interest-1601c" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="penalty-compromise-1601c" class="label">23. Add: Penalties (Compromise)</label><input type="number" id="penalty-compromise-1601c" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row mt-4"><dt class="label">24. Total Amount Required to be Remitted</dt><dd class="value total" id="total-remittance-1601c">${nf(line19_totalWH_from_input)}</dd></div>`; // Initial value before recalc
            html += `<div class="recalculate-button-wrapper"><button type="button" class="recalculate-button text-xs py-1 px-3" data-return-type="1601c" data-reporting-type="${reportingType}">Recalculate Total Remittance</button></div>`; // Added data-reporting-type
            html += `</dl>`;
            html += `<p class="text-xs text-gray-500 mt-4">* Line 14 sums all compensation components for the month (excluding 'NT' category). Line 15C sums current month's De Minimis & 13th Month Pay (total amount paid). Line 17 is calculated. Line 19 is from payroll input. Adjustments/Penalties are manual.</p>`;
            html += `</div>`;
            return html;
        }
        function generate2551QReturn(reportingType, period, year) {
            console.log(`Entering generate2551QReturn... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
            const y = parseInt(year);
            let pLabel = "";
            let formName = "2551Q/M";
            if (reportingType === 'quarterly') {
                pLabel = periodOptions.quarterly.find(opt => opt.value === period)?.text || period;
                formName = "2551Q";
            } else if (reportingType === 'monthly') {
                pLabel = periodOptions.monthly.find(opt => opt.value === period)?.text || period;
                formName = "2551M";
            } else if (reportingType === 'annual') {
                pLabel = "Annual";
                formName = "2551Q (Annual Summary)";
            }

            // Placeholder until full implementation
            // Sum relevant sales data for percentage tax (e.g., exempt sales if PT applies to them, or specific non-VAT sales)
            let totalTaxableSalesForPT = 0;
            const currentPeriodMonths = getPeriodMonths(reportingType, period);
            processedData.sales?.forEach(r => {
                try {
                    if (!r.DATE) return;
                    const d = new Date(r.DATE);
                    if (isNaN(d.getTime()) || d.getFullYear() !== y) return;
                    if (currentPeriodMonths.includes(d.getMonth() + 1)) {
                        // Example: if PT applies to Exempt Receipts, sum them.
                        // This logic needs to be specific to WHAT is subject to PT.
                        // For now, let's assume Exempt Receipts are the base.
                        totalTaxableSalesForPT += safeParseFloat(r.EXEMPT_RECEIPT);
                        // Add other conditions if NonReportable or other fields are subject to PT.
                    }
                } catch (e) { console.error("Error processing sales for 2551Q:", e); }
            });

            const taxRatePT = 0.03; // Standard PT rate, can be made configurable
            const taxDuePT = totalTaxableSalesForPT * taxRatePT;

            let html = `<div class="return-computation">`;
            html += `<h4 class="section-title mb-4">BIR Form ${formName} (${pLabel} ${y}) - Percentage Tax Return</h4>`;
            html += `<dl>`;
            html += `<div class="computation-row"><dt class="label">Total Taxable Sales/Receipts for PT (Current Period)</dt><dd class="value">${nf(totalTaxableSalesForPT)}</dd></div>`;
            html += `<div class="computation-row"><dt class="label">Percentage Tax Rate</dt><dd class="value">${(taxRatePT * 100).toFixed(2)}%</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Tax Due for the Period</dt><dd class="value total">${nf(taxDuePT)}</dd></div>`;
            // Add lines for previous payments (if quarterly), penalties, etc.
            html += `</dl>`;
            html += `<p class="text-xs text-gray-500 mt-2">* This is a simplified calculation. Ensure the correct sales base for Percentage Tax is used.</p>`;
            html += `</div>`;
            html += `<div class="supporting-details"><h4 class="sub-section-title">Supporting Details</h4><h5>Summary List of Sales (SLS)</h5>${generateSlsReport(reportingType, period, year)}<h5 class="mt-4">SAWT (VAT/PT)</h5>${generateSawtVatReport(reportingType, period, year)}</div>`;
            return html;
         }
         function generateITR8PercentReturn(reportingType, period, year, calculatedReturnData = {}) {
            console.log(`Entering generateITR8PercentReturn... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
            const isAnnual = reportingType === 'annual';
            const isQuarterly = reportingType === 'quarterly';

            if (!isQuarterly && !isAnnual) { return '<p class="text-orange-600">8% ITR is filed Quarterly or Annually.</p>'; }
            if (!processedData.sales || processedData.sales.length === 0) { return '<p class="text-gray-600">No Sales data available for 8% ITR calculation.</p>'; }

            const y = parseInt(year);
            const pLabel = isAnnual ? "Annual" : (periodOptions.quarterly.find(opt => opt.value === period)?.text || period);
            const currentPeriodMonths = getPeriodMonths(reportingType, period);

            let currentPeriodSales = 0; let currentPeriodWithheldIT = 0;
            processedData.sales?.forEach(r => {
                try {
                    if (!r.DATE) return;
                    const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && currentPeriodMonths.includes(rm)) {
                        const vr = safeParseFloat(r.VATABLE_RECEIPT);
                        const er = safeParseFloat(r.EXEMPT_RECEIPT);
                        // For 8%, all receipts (net of VAT if applicable) are generally considered. NonReportable might be excluded.
                        currentPeriodSales += (vr / 1.12) + er + safeParseFloat(r.NONREPORTABLE_RECEIPT);
                        currentPeriodWithheldIT += safeParseFloat(r._2307_IT);
                    }
                } catch (e) { console.error("Error processing sales for 8% ITR:", r, e); }
            });

            calculatedReturnData.totalSales = currentPeriodSales; // For benchmark if needed

            console.log(`ITR 8% ${pLabel} ${y}: CurrentPeriodSales=${nf(currentPeriodSales)}, CurrentPeriodWH_IT=${nf(currentPeriodWithheldIT)}`);

            let html = `<div class="return-computation" id="itr8-computation-area" data-current-period-sales="${currentPeriodSales}" data-current-period-withheld="${currentPeriodWithheldIT}">`;
            const formName = isAnnual ? '1701A (8% Income Tax)' : '1701Q (8% Income Tax)';
            html += `<h4 class="section-title mb-4">BIR Form ${formName} (${pLabel} ${y})</h4>`;
            html += `<dl>`;
            html += `<div class="computation-group-title mt-4">Tax Computation</div>`;
            html += `<div class="computation-row"><dt class="label">Sales/Receipts (Net of VAT, Current ${isAnnual ? 'Year' : 'Quarter'})</dt><dd class="value">${nf(currentPeriodSales)}</dd></div>`;

            if (isQuarterly) {
                html += `<div class="computation-row input-row"><label for="prev-sales" class="label carry-over-label">Add: Sales/Receipts - Previous Quarter(s)</label><input type="number" id="prev-sales" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row total-row"><dt class="label">Total Sales/Receipts (Year-to-Date)</dt><dd class="value total" id="disp-total-sales-ytd">0.00</dd></div>`;
            } else {
                html += `<div class="computation-row total-row"><dt class="label">Total Sales/Receipts (Annual)</dt><dd class="value total" id="disp-total-sales-ytd">${nf(currentPeriodSales)}</dd></div>`;
            }

            html += `<div class="computation-row"><dt class="label">Less: Allowable Deduction (Sec 24(A)(2)(b))</dt><dd class="value">${nf(250000)}</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Taxable Income (${isAnnual ? 'Annual' : 'Year-to-Date'})</dt><dd class="value total" id="disp-taxable-income-ytd">0.00</dd></div>`;
            html += `<div class="computation-row"><dt class="label">Tax Rate</dt><dd class="value">8.00%</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Income Tax Due (${isAnnual ? 'Annual' : 'Year-to-Date'})</dt><dd class="value total" id="disp-tax-due-ytd">0.00</dd></div>`;

            html += `<div class="computation-group-title mt-4">Less: Tax Credits/Payments</div>`;
            html += `<div class="manual-input-section mb-4">`;
            html += `<div class="computation-row input-row"><label for="prev-tax-paid" class="label carry-over-label">Tax Payments - Previous Quarter(s) (1701Q)</label><input type="number" id="prev-tax-paid" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            if (isQuarterly) {
                 html += `<div class="computation-row input-row"><label for="prev-tax-withheld" class="label carry-over-label">Creditable Tax Withheld - Previous Quarter(s) (2307)</label><input type="number" id="prev-tax-withheld" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            }
            html += `</div>`;
            html += `<div class="computation-row"><dt class="label">Creditable Tax Withheld - Current ${isAnnual ? 'Year' : 'Quarter'} (2307)</dt><dd class="value" id="disp-current-withheld">${nf(currentPeriodWithheldIT)}</dd></div>`;
            html += `<div class="computation-row sub-item"><dt class="label">Tax Payments - Previous Qtr(s) (Manual)</dt><dd class="value" id="disp-prev-paid">0.00</dd></div>`;
            if (isQuarterly) {
                html += `<div class="computation-row sub-item"><dt class="label">Creditable Tax Withheld - Previous Qtr(s) (Manual)</dt><dd class="value" id="disp-prev-withheld">0.00</dd></div>`;
            }
            html += `<div class="computation-row total-row"><dt class="label">Total Tax Credits/Payments</dt><dd class="value total" id="disp-total-credits">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-4"><dt class="label">Net Tax Payable / (Overpayment) for the ${isAnnual ? 'Year' : 'Period'}</dt><dd class="value total" id="disp-net-payable">0.00</dd></div>`;
            html += `</dl>`;
            html += `<div class="recalculate-button-wrapper mt-4"><button type="button" class="recalculate-button" data-return-type="itr8" data-reporting-type="${reportingType}">Recalculate Payable</button></div>`;
            html += `<p class="text-xs text-gray-500 mt-2">* Assumes taxpayer qualifies for 8% rate. Previous Qtr Sales (for quarterly), Payments & Credits are manual inputs. Current Period Withheld is auto-calculated.</p>`;
            html += `</div>`;
            html += `<div class="supporting-details"><h4 class="sub-section-title">Supporting Details (${pLabel} ${y})</h4><h5>SAWT (IT)</h5>${generateSawtItReport(reportingType, period, year)}<h5 class="mt-4">Summary List of Sales (SLS)</h5>${generateSlsReport(reportingType, period, year)}</div>`;
            return html;
         }
        function generate1701QReturn(reportingType, period, year, calculatedReturnData = {}) {
            const isAnnual = reportingType === 'annual';
            const isQuarterly = reportingType === 'quarterly';
            console.log(`Entering generate1701QReturn (Ind Grad)... Type: ${reportingType}`);

            if (!isQuarterly && !isAnnual) { return '<p class="text-orange-600">1701Q/1701 is filed Quarterly or Annually.</p>'; }
            if (!processedData.sales) { return '<p class="text-gray-600">No Sales data available.</p>'; }

            const y = parseInt(year);
            const pLabel = isAnnual ? "Annual" : (periodOptions.quarterly.find(opt => opt.value === period)?.text || period);
            const formName = isAnnual ? '1701 (Annual Income Tax Return - Individual)' : '1701Q (Quarterly Income Tax Return - Individual)';

            const currentPeriodMonths = getPeriodMonths(reportingType, period);
            let prevQMonths = [];
            if (isQuarterly) {
                const q = parseInt(period.substring(1));
                if (q === 2) prevQMonths = [1, 2, 3];
                else if (q === 3) prevQMonths = [1, 2, 3, 4, 5, 6];
                else if (q === 4) prevQMonths = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            }

            let currentRevenue = 0; let currentWithheldIT = 0; let prevWithheldIT_auto = 0;
            let totalPurchExpPool = 0; let totalPayrollPool = 0; let totalNonBirPool = 0; let totalContribExpPool = 0;

            processedData.sales?.forEach(r => {
                try {
                    if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && currentPeriodMonths.includes(rm)) {
                        const vr = safeParseFloat(r.VATABLE_RECEIPT);
                        const er = safeParseFloat(r.EXEMPT_RECEIPT);
                        currentRevenue += (vr / 1.12) + er + safeParseFloat(r.NONREPORTABLE_RECEIPT); // Include NonReportable for gross generally
                        currentWithheldIT += safeParseFloat(r._2307_IT);
                    }
                    if (isQuarterly && prevQMonths.length > 0 && ry === y && prevQMonths.includes(rm)) {
                        prevWithheldIT_auto += safeParseFloat(r._2307_IT);
                    }
                } catch (e) { console.error("Error processing sales for 1701Q/1701:", r, e); }
            });

            processedData.purchasesExpenses?.forEach(r => {
                try {
                    if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && currentPeriodMonths.includes(rm)) { // Only sum for current period expenses for ITR
                        totalPurchExpPool += (safeParseFloat(r.VATABLE) / 1.12) + safeParseFloat(r.NON_VATABLE);
                        totalNonBirPool += safeParseFloat(r.NON_BIR);
                    }
                } catch (e) { console.error("Error processing purchases for 1701Q/1701 Pool:", r, e); }
            });
            processedData.payroll?.forEach(r => {
                try {
                    if (!r.PAY_DAY) return; const d = new Date(r.PAY_DAY); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && currentPeriodMonths.includes(rm)) { // Only sum for current period expenses for ITR
                        totalPayrollPool += safeParseFloat(r.GROSS_PAY);
                        totalContribExpPool += safeParseFloat(r.CONTRIBUTION_EXPENSE);
                    }
                } catch (e) { console.error("Error processing payroll for 1701Q/1701 Pool:", r, e); }
            });

            calculatedReturnData.totalSales = currentRevenue;

            console.log(`${formName} ${pLabel} ${y}: CurrentRev=${nf(currentRevenue)}, CurrentWH_IT=${nf(currentWithheldIT)}, AutoPrevWH_IT (Qtrly only)=${nf(prevWithheldIT_auto)}`);
            console.log(`Pools - Purch/Exp(Gen): ${nf(totalPurchExpPool)}, Payroll(Gen): ${nf(totalPayrollPool)}, NonBIR: ${nf(totalNonBirPool)}, ContribExp: ${nf(totalContribExpPool)}`);

            let html = `<div class="return-computation" data-return-type="1701q" data-reporting-type="${reportingType}"
                         data-current-revenue="${currentRevenue}" data-current-withheld="${currentWithheldIT}"
                         data-pool-purch-exp="${totalPurchExpPool}" data-pool-payroll="${totalPayrollPool}"
                         data-pool-nonbir="${totalNonBirPool}" data-pool-contrib-exp="${totalContribExpPool}">`;
            html += `<h4 class="section-title mb-4">${formName} (${pLabel} ${y})</h4>`;
            html += `<dl>`;
            html += `<div class="computation-row"><dt class="label">Total Sales/Revenues (Current ${isAnnual ? 'Year' : 'Qtr'})</dt><dd class="value">${nf(currentRevenue)}</dd></div>`;
            html += `<div class="computation-group-title mt-4">Less: Cost of Sales / Service (Current ${isAnnual ? 'Year' : 'Qtr'})</div>`;
            html += `<div class="computation-row input-row"><label for="cos-beginv" class="label">Beginning Inventory</label><input type="number" id="cos-beginv" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-purchases" class="label">Purchases / Direct Costs (Gen)</label><input type="number" id="cos-purchases" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-directlabor" class="label">Direct Labor / Payroll Cost (Gen)</label><input type="number" id="cos-directlabor" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-nonbir-exp-cos" class="label">Non-BIR Expenses (Allocated to COS)</label><input type="number" id="ded-nonbir-exp-cos" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-contrib-exp-cos" class="label">Contribution Expense (Allocated to COS)</label><input type="number" id="ded-contrib-exp-cos" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-depcost" class="label">Depreciation - Cost Related</label><input type="number" id="cos-depcost" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-others" class="label">Other Costs</label><input type="number" id="cos-others" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-endinv" class="label">Ending Inventory</label><input type="number" id="cos-endinv" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Cost of Sales/Service</dt><dd class="value total" id="disp-cos">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-2"><dt class="label">Gross Income from Operations</dt><dd class="value total" id="disp-gross-income">0.00</dd></div>`;
            html += `<div class="computation-group-title mt-4">Less: Allowable Deductions (Current ${isAnnual ? 'Year' : 'Qtr'})</div>`;
            html += `<div class="computation-row input-row"><label for="ded-expenses" class="label">Operating Expenses (Gen, Excl. below)</label><input type="number" id="ded-expenses" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-salaries" class="label">Salaries & Wages (Gen, Non-COS)</label><input type="number" id="ded-salaries" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-nonbir-exp-opex" class="label">Non-BIR Expenses (Allocated to Opex)</label><input type="number" id="ded-nonbir-exp-opex" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-contrib-exp-opex" class="label">Contribution Expense (Allocated to Opex)</label><input type="number" id="ded-contrib-exp-opex" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-depded" class="label">Depreciation - Deduction</label><input type="number" id="ded-depded" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-intded" class="label">Other Expense</label><input type="number" id="ded-intded" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Allowable Deductions</dt><dd class="value total" id="disp-deductions">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-2"><dt class="label">Net Taxable Income/(Loss) - Current ${isAnnual ? 'Year' : 'Quarter'}</dt><dd class="value total" id="disp-taxable-income-period">0.00</dd></div>`;

            html += `<div class="computation-group-title mt-4">Tax Computation (${isAnnual ? 'Annual' : 'Year-to-Date'})</div>`;
            if (isQuarterly) {
                html += `<div class="computation-row input-row"><label for="prev-taxable" class="label carry-over-label">Add: Taxable Income/(Loss) - Previous Qtr(s)</label><input type="number" id="prev-taxable" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            }
            html += `<div class="computation-row total-row"><dt class="label">Total Taxable Income/(Loss) ${isAnnual ? 'Annual' : 'YTD'}</dt><dd class="value total" id="disp-total-taxable-ytd">0.00</dd></div>`;
            html += `<div class="computation-row"><dt class="label">Tax Due (${isAnnual ? 'Annual' : 'YTD'} - Graduated Rates)</dt><dd class="value" id="disp-tax-due-ytd">0.00</dd></div>`;

            html += `<div class="computation-group-title mt-4">Less: Tax Credits/Payments</div>`;
            html += `<div class="computation-row input-row"><label for="prev-payments" class="label carry-over-label">Prior Quarter(s) Tax Payments</label><input type="number" id="prev-payments" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            if (isQuarterly) {
                html += `<div class="computation-row input-row"><label for="prev-withheld" class="label carry-over-label">Creditable Tax Withheld - Previous Qtr(s)</label><input type="number" id="prev-withheld" value="${nf(prevWithheldIT_auto)}" step="0.01" class="value-input manual-input"></div>`;
            }
            html += `<div class="computation-row"><dt class="label">Creditable Tax Withheld - Current ${isAnnual ? 'Year' : 'Quarter'}</dt><dd class="value">${nf(currentWithheldIT)}</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Tax Credits/Payments</dt><dd class="value total" id="disp-total-credits">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-4"><dt class="label">Net Tax Payable / (Overpayment)</dt><dd class="value total" id="net-tax-payable">0.00</dd></div>`;
            html += `</dl>`;

            html += `<div class="exception-items-section">
                        <h5 class="computation-group-title">Exception Items (Not Claimed on ITR)</h5>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-purch-desc" class="label">Purchases:</label>
                            <input type="text" id="excp-purch-desc" placeholder="Description (e.g., Non-deductible input VAT)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-purch-amount" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-payroll-desc" class="label">Payroll:</label>
                            <input type="text" id="excp-payroll-desc" placeholder="Description (e.g., Non-deductible SSS/PHIC/HDMF - ER)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-payroll-amount" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-nonbir-desc" class="label">Non-BIR Exp:</label>
                            <input type="text" id="excp-nonbir-desc" placeholder="Description (e.g., Personal Expenses)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-nonbir-amount" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                     </div>`;

            html += `<div class="validation-info mt-4"><h5 class="computation-group-title">Expense Allocation Validation (Current ${isAnnual ? 'Year' : 'Qtr'})</h5>
                        <p class="pool-title">General Purch/Exp Pool (Vatable Net + Non-Vatable):</p>
                        <div class="computation-row"><dt class="label">Total Pool Amount:</dt><dd class="value" id="disp-pool-purch-exp-gen">${nf(totalPurchExpPool)}</dd></div>
                        <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-purch-exp-gen">0.00</dd></div>
                        <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-purch-exp-gen">0.00</dd></div>
                        <p class="pool-title">General Payroll Pool (Gross Pay):</p>
                        <div class="computation-row"><dt class="label">Total Pool Amount:</dt><dd class="value" id="disp-pool-payroll-gen">${nf(totalPayrollPool)}</dd></div>
                        <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-payroll-gen">0.00</dd></div>
                        <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-payroll-gen">0.00</dd></div>
                        <p class="pool-title">Non-BIR Expense Pool:</p>
                        <div class="computation-row"><dt class="label">Total Pool Amount (from Input):</dt><dd class="value" id="disp-pool-nonbir">${nf(totalNonBirPool)}</dd></div>
                        <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-nonbir">0.00</dd></div>
                        <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-nonbir">0.00</dd></div>
                        <p class="pool-title">Contribution Expense Pool:</p>
                        <div class="computation-row"><dt class="label">Total Pool Amount (from Input):</dt><dd class="value" id="disp-pool-contrib-exp">${nf(totalContribExpPool)}</dd></div>
                        <div class="computation-row"><dt class="label">Allocated (COS+Opex):</dt><dd class="value" id="disp-alloc-contrib-exp">0.00</dd></div>
                        <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-contrib-exp">0.00</dd></div>
                        <p class="text-xs text-gray-500 mt-2">* Balances should be zero if allocations match source data pools.</p>
                     </div>`;

            html += `<div class="recalculate-button-wrapper mt-4"><button type="button" class="recalculate-button" data-return-type="1701q" data-reporting-type="${reportingType}">Recalculate Return</button></div>`;
            html += `</div>`;

            const supportingDetailsHTML = `
                <div class="supporting-details">
                    <h4 class="sub-section-title">Supporting Details (${pLabel} ${y})</h4>
                    <h5>Summary List of Sales (SLS)</h5>${generateSlsReport(reportingType, period, year)}
                    <h5 class="mt-4">Summary List of Purchases (SLP)</h5>${generateSlpReport(reportingType, period, year)}
                    <h5 class="mt-4">SAWT (IT)</h5>${generateSawtItReport(reportingType, period, year)}
                </div>`;
            html += supportingDetailsHTML;
            return html;
        }
        function generate1702QReturn(reportingType, period, year, calculatedReturnData = {}) {
             const isAnnual = reportingType === 'annual';
             const isQuarterly = reportingType === 'quarterly';
             console.log(`Entering generate1702QReturn (Corp Grad)... Type: ${reportingType}`);

             if (!isQuarterly && !isAnnual) { return '<p class="text-orange-600">1702Q/1702-RT is filed Quarterly or Annually.</p>'; }
             if (!processedData.sales) { return '<p class="text-gray-600">No Sales data available.</p>'; }

             const y = parseInt(year);
             const pLabel = isAnnual ? "Annual" : (periodOptions.quarterly.find(opt => opt.value === period)?.text || period);
             const formName = isAnnual ? '1702-RT (Annual Income Tax Return - Corporation)' : '1702Q (Quarterly Income Tax Return - Corporation)';
             const sfx = '-corp';

             const currentPeriodMonths = getPeriodMonths(reportingType, period);
             let prevQMonths = [];
             if (isQuarterly) {
                 const q = parseInt(period.substring(1));
                 if (q === 2) prevQMonths = [1,2,3];
                 else if (q === 3) prevQMonths = [1,2,3,4,5,6];
                 else if (q === 4) prevQMonths = [1,2,3,4,5,6,7,8,9];
             }

             let currentRevenue = 0; let currentWithheldIT = 0; let prevWithheldIT_auto = 0;
             let totalPurchExpPool = 0; let totalPayrollPool = 0; let totalNonBirPool = 0; let totalContribExpPool = 0;

             processedData.sales?.forEach(r => {
                 try { if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                     const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                     if (ry === y && currentPeriodMonths.includes(rm)) {
                         const vr = safeParseFloat(r.VATABLE_RECEIPT); const er = safeParseFloat(r.EXEMPT_RECEIPT);
                         currentRevenue += (vr / 1.12) + er + safeParseFloat(r.NONREPORTABLE_RECEIPT);
                         currentWithheldIT += safeParseFloat(r._2307_IT);
                     }
                     if (isQuarterly && prevQMonths.length > 0 && ry === y && prevQMonths.includes(rm)) {
                         prevWithheldIT_auto += safeParseFloat(r._2307_IT);
                     }
                 } catch (e) { console.error(`Error processing sales for ${formName}:`, r, e); }
             });
             processedData.purchasesExpenses?.forEach(r => {
                 try { if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                     const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                     if (ry === y && currentPeriodMonths.includes(rm)) {
                         totalPurchExpPool += (safeParseFloat(r.VATABLE) / 1.12) + safeParseFloat(r.NON_VATABLE);
                         totalNonBirPool += safeParseFloat(r.NON_BIR);
                     }
                 } catch (e) { console.error(`Error processing purchases for ${formName} Pool:`, r, e); }
             });
             processedData.payroll?.forEach(r => {
                try {
                    if (!r.PAY_DAY) return; const d = new Date(r.PAY_DAY); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && currentPeriodMonths.includes(rm)) {
                        totalPayrollPool += safeParseFloat(r.GROSS_PAY);
                        totalContribExpPool += safeParseFloat(r.CONTRIBUTION_EXPENSE);
                    }
                } catch (e) { console.error(`Error processing payroll for ${formName} Pool:`, r, e); }
             });

            calculatedReturnData.totalSales = currentRevenue;

            console.log(`${formName} ${pLabel} ${y}: CurrentRev=${nf(currentRevenue)}, CurrentWH_IT=${nf(currentWithheldIT)}, AutoPrevWH_IT (Qtrly only)=${nf(prevWithheldIT_auto)}`);
            console.log(`Pools - Purch/Exp(Gen): ${nf(totalPurchExpPool)}, Payroll(Gen): ${nf(totalPayrollPool)}, NonBIR: ${nf(totalNonBirPool)}, ContribExp: ${nf(totalContribExpPool)}`);

            let html = `<div class="return-computation" data-return-type="1702q" data-reporting-type="${reportingType}"
                          data-current-revenue="${currentRevenue}" data-current-withheld="${currentWithheldIT}"
                          data-pool-purch-exp="${totalPurchExpPool}" data-pool-payroll="${totalPayrollPool}"
                          data-pool-nonbir="${totalNonBirPool}" data-pool-contrib-exp="${totalContribExpPool}">`;
            html += `<h4 class="section-title mb-4">${formName} (${pLabel} ${y})</h4>`;
            html += `<dl>`;
            html += `<div class="computation-row"><dt class="label">Total Sales/Revenues (Current ${isAnnual ? 'Year' : 'Qtr'})</dt><dd class="value">${nf(currentRevenue)}</dd></div>`;
            html += `<div class="computation-group-title mt-4">Less: Cost of Sales / Service (Current ${isAnnual ? 'Year' : 'Qtr'})</div>`;
            html += `<div class="computation-row input-row"><label for="cos-beginv${sfx}" class="label">Beginning Inventory</label><input type="number" id="cos-beginv${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-purchases${sfx}" class="label">Purchases / Direct Costs (Gen)</label><input type="number" id="cos-purchases${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-directlabor${sfx}" class="label">Direct Labor / Payroll Cost (Gen)</label><input type="number" id="cos-directlabor${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-nonbir-exp-cos${sfx}" class="label">Non-BIR Expenses (Allocated to COS)</label><input type="number" id="ded-nonbir-exp-cos${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-contrib-exp-cos${sfx}" class="label">Contribution Expense (Allocated to COS)</label><input type="number" id="ded-contrib-exp-cos${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-depcost${sfx}" class="label">Depreciation - Cost Related</label><input type="number" id="cos-depcost${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-others${sfx}" class="label">Other Costs</label><input type="number" id="cos-others${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="cos-endinv${sfx}" class="label">Ending Inventory</label><input type="number" id="cos-endinv${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Cost of Sales/Service</dt><dd class="value total" id="disp-cos${sfx}">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-2"><dt class="label">Gross Income from Operations (Current ${isAnnual ? 'Year' : 'Qtr'})</dt><dd class="value total" id="disp-gross-income${sfx}">0.00</dd></div>`;

            html += `<div class="computation-group-title mt-4">Less: Allowable Deductions (Current ${isAnnual ? 'Year' : 'Qtr'})</div>`;
            html += `<div class="computation-row input-row"><label for="ded-expenses${sfx}" class="label">Operating Expenses (Gen, Excl. below)</label><input type="number" id="ded-expenses${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-salaries${sfx}" class="label">Salaries & Wages (Gen, Non-COS)</label><input type="number" id="ded-salaries${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-nonbir-exp-opex${sfx}" class="label">Non-BIR Expenses (Allocated to Opex)</label><input type="number" id="ded-nonbir-exp-opex${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-contrib-exp-opex${sfx}" class="label">Contribution Expense (Allocated to Opex)</label><input type="number" id="ded-contrib-exp-opex${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-depded${sfx}" class="label">Depreciation - Deduction</label><input type="number" id="ded-depded${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row input-row"><label for="ded-intded${sfx}" class="label">Other Expense</label><input type="number" id="ded-intded${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Allowable Deductions (Current ${isAnnual ? 'Year' : 'Qtr'})</dt><dd class="value total" id="disp-deductions${sfx}">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-2"><dt class="label">Net Taxable Income/(Loss) - Current ${isAnnual ? 'Year' : 'Quarter'}</dt><dd class="value total" id="disp-taxable-income-period${sfx}">0.00</dd></div>`;

            if (isQuarterly) {
                html += `<div class="computation-group-title mt-4">Year-to-Date Income (Informational for Quarterly)</div>`;
                html += `<div class="computation-row input-row"><label for="prev-taxable-income-ytd${sfx}" class="label carry-over-label">Add: Taxable Income/(Loss) - Previous Qtr(s)</label><input type="number" id="prev-taxable-income-ytd${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row total-row"><dt class="label">Total Taxable Income/(Loss) YTD</dt><dd class="value total" id="disp-total-taxable-income-ytd${sfx}">0.00</dd></div>`;
            }

            html += `<div class="computation-group-title mt-4">Tax Computation (Current ${isAnnual ? 'Year' : 'Quarter'})</div>`;
            html += `<div class="computation-row"><dt class="label">RCIT (Regular Corp Income Tax - on Current ${isAnnual ? 'Annual' : 'Quarterly'} Income)</dt><dd class="value" id="disp-rcit${sfx}">0.00</dd></div>`;
            html += `<div class="computation-row input-row items-center"><label for="compute-mcit${sfx}" class="label flex-shrink-0 mr-4">Compute MCIT?</label><input type="checkbox" id="compute-mcit${sfx}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 cursor-pointer"></div>`;
            html += `<div class="computation-row"><dt class="label">MCIT (Minimum Corp Income Tax - 2% of Current ${isAnnual ? 'Annual' : 'Quarterly'} GI)</dt><dd class="value" id="disp-mcit${sfx}">N/A</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Tax Due for ${isAnnual ? 'Year' : 'Quarter'} <span id="tax-basis-note${sfx}">(RCIT)</span></dt><dd class="value total" id="disp-tax-due-period${sfx}">0.00</dd></div>`;

            html += `<div class="computation-group-title mt-4">Less: Tax Credits/Payments</div>`;
            html += `<div class="computation-row input-row"><label for="prev-payments${sfx}" class="label carry-over-label">Prior Quarter(s) Tax Payments (RCIT/MCIT)</label><input type="number" id="prev-payments${sfx}" value="0.00" step="0.01" class="value-input manual-input"></div>`;
             if (isQuarterly) {
                html += `<div class="computation-row input-row"><label for="prev-withheld${sfx}" class="label carry-over-label">Prior Quarter(s) Creditable Tax Withheld</label><input type="number" id="prev-withheld${sfx}" value="${nf(prevWithheldIT_auto)}" step="0.01" class="value-input manual-input"></div>`;
            }
            html += `<div class="computation-row"><dt class="label">Creditable Tax Withheld - Current ${isAnnual ? 'Year' : 'Quarter'}</dt><dd class="value">${nf(currentWithheldIT)}</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">Total Tax Credits/Payments</dt><dd class="value total" id="disp-total-credits${sfx}">0.00</dd></div>`;
            html += `<div class="computation-row total-row mt-4"><dt class="label">Net Tax Payable / (Overpayment) for ${isAnnual ? 'Year' : 'Quarter'}</dt><dd class="value total" id="net-tax-payable${sfx}">0.00</dd></div>`;
            html += `</dl>`;

             html += `<div class="exception-items-section">
                        <h5 class="computation-group-title">Exception Items (Not Claimed on ITR)</h5>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-purch-desc${sfx}" class="label">Purchases:</label>
                            <input type="text" id="excp-purch-desc${sfx}" placeholder="Description (e.g., Non-deductible input VAT)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-purch-amount${sfx}" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-payroll-desc${sfx}" class="label">Payroll:</label>
                            <input type="text" id="excp-payroll-desc${sfx}" placeholder="Description (e.g., Non-deductible SSS/PHIC/HDMF - ER)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-payroll-amount${sfx}" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                        <div class="exception-item-row" data-print-desc="" data-print-amount="">
                            <label for="excp-nonbir-desc${sfx}" class="label">Non-BIR Exp:</label>
                            <input type="text" id="excp-nonbir-desc${sfx}" placeholder="Description (e.g., Personal Expenses)" class="flex-grow border border-gray-300 rounded px-2 py-1 text-sm">
                            <input type="number" id="excp-nonbir-amount${sfx}" value="0.00" step="0.01" class="value-input manual-input">
                        </div>
                     </div>`;

            html += `<div class="validation-info mt-4"><h5 class="computation-group-title">Expense Allocation Validation (Current ${isAnnual ? 'Year' : 'Qtr'})</h5>
                         <p class="pool-title">General Purch/Exp Pool (Vatable Net + Non-Vatable):</p>
                         <div class="computation-row"><dt class="label">Total Pool Amount:</dt><dd class="value" id="disp-pool-purch-exp-gen${sfx}">${nf(totalPurchExpPool)}</dd></div>
                         <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-purch-exp-gen${sfx}">0.00</dd></div>
                         <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-purch-exp-gen${sfx}">0.00</dd></div>
                         <p class="pool-title">General Payroll Pool (Gross Pay):</p>
                         <div class="computation-row"><dt class="label">Total Pool Amount:</dt><dd class="value" id="disp-pool-payroll-gen${sfx}">${nf(totalPayrollPool)}</dd></div>
                         <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-payroll-gen${sfx}">0.00</dd></div>
                         <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-payroll-gen${sfx}">0.00</dd></div>
                         <p class="pool-title">Non-BIR Expense Pool:</p>
                         <div class="computation-row"><dt class="label">Total Pool Amount (from Input):</dt><dd class="value" id="disp-pool-nonbir${sfx}">${nf(totalNonBirPool)}</dd></div>
                         <div class="computation-row"><dt class="label">Allocated (COS+Opex+Exception):</dt><dd class="value" id="disp-alloc-nonbir${sfx}">0.00</dd></div>
                         <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-nonbir${sfx}">0.00</dd></div>
                         <p class="pool-title">Contribution Expense Pool:</p>
                         <div class="computation-row"><dt class="label">Total Pool Amount (from Input):</dt><dd class="value" id="disp-pool-contrib-exp${sfx}">${nf(totalContribExpPool)}</dd></div>
                         <div class="computation-row"><dt class="label">Allocated (COS+Opex):</dt><dd class="value" id="disp-alloc-contrib-exp${sfx}">0.00</dd></div>
                         <div class="computation-row"><dt class="label">Unallocated Balance:</dt><dd class="value validation-balance" id="disp-bal-contrib-exp${sfx}">0.00</dd></div>
                         <p class="text-xs text-gray-500 mt-2">* Balances should be zero if allocations match source data pools. RCIT/MCIT is on current ${isAnnual ? 'annual' : 'quarterly'} income/GI.</p>
                      </div>`;

            html += `<div class="recalculate-button-wrapper mt-4"><button type="button" class="recalculate-button" data-return-type="1702q" data-reporting-type="${reportingType}">Recalculate Return</button></div>`;
            html += `</div>`;

             const supportingDetailsHTML = `
                 <div class="supporting-details">
                     <h4 class="sub-section-title">Supporting Details (${pLabel} ${y})</h4>
                     <h5>Summary List of Sales (SLS)</h5>${generateSlsReport(reportingType, period, year)}
                     <h5 class="mt-4">Summary List of Purchases (SLP)</h5>${generateSlpReport(reportingType, period, year)}
                     <h5 class="mt-4">SAWT (IT)</h5>${generateSawtItReport(reportingType, period, year)}
                 </div>`;
             html += supportingDetailsHTML;
            return html;
        }
        function generate2550QReturn(reportingType, period, year, calculatedReturnData = {}) {
            console.log(`Entering generate2550QReturn... Type: ${reportingType}`);
            if (reportingType !== 'quarterly' && reportingType !== 'monthly' && reportingType !== 'annual') { return '<p class="text-orange-600">2550Q/M is filed Monthly, Quarterly, or Annually (summary).</p>'; }
            if ((!processedData.sales || processedData.sales.length === 0) && (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0)) { return '<p class="text-gray-600">No Sales or Purchases/Expenses data available for VAT calculation.</p>'; }

            const y = parseInt(year);
            const isQuarterly = reportingType === 'quarterly';
            const isMonthly = reportingType === 'monthly';
            const isAnnual = reportingType === 'annual';

            let months = getPeriodMonths(reportingType, period);
            let pLabel = "";
            let formName = "2550";

            if (isMonthly) {
                pLabel = periodOptions.monthly.find(opt => opt.value === period)?.text || period;
                formName = "2550M";
            } else if (isQuarterly) {
                pLabel = periodOptions.quarterly.find(opt => opt.value === period)?.text || period;
                formName = "2550Q";
            } else {
                pLabel = "Annual";
                formName = "2550Q (Annual Summary)";
            }

            let sourceTotalVatableSalesNet = 0; let sourceTotalExemptSales = 0; let sourceTotalOutputVatCalc = 0;
            let sourceTotalVatablePurchNet = 0; let sourceTotalInputVatCalc = 0; let sourceTotalNonVatPurch = 0;
            let sourceSawtVatWithheld = 0;

            processedData.sales?.forEach(r => {
                try { if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && months.includes(rm)) {
                        const vr = safeParseFloat(r.VATABLE_RECEIPT);
                        const er = safeParseFloat(r.EXEMPT_RECEIPT);
                        const wv = safeParseFloat(r._2307_WV);
                        if (!isNaN(vr)) sourceTotalVatableSalesNet += (vr / 1.12);
                        if (!isNaN(er)) sourceTotalExemptSales += er;
                        if (!isNaN(wv)) sourceSawtVatWithheld += wv;
                    }
                } catch (e) { console.error("Error processing sales for 2550:", r, e); }
            });
            sourceTotalOutputVatCalc = sourceTotalVatableSalesNet * 0.12;
            calculatedReturnData.totalVatableSalesNet = sourceTotalVatableSalesNet;
            calculatedReturnData.totalExemptSales = sourceTotalExemptSales;
            calculatedReturnData.totalOutputVat = sourceTotalOutputVatCalc;

            processedData.purchasesExpenses?.forEach(r => {
                try { if (!r.DATE) return; const d = new Date(r.DATE); if (isNaN(d.getTime())) return;
                    const ry = d.getFullYear(); const rm = d.getMonth() + 1;
                    if (ry === y && months.includes(rm)) {
                        const v = safeParseFloat(r.VATABLE);
                        const nv = safeParseFloat(r.NON_VATABLE);
                        if (!isNaN(v)) sourceTotalVatablePurchNet += (v / 1.12);
                        if (!isNaN(nv)) sourceTotalNonVatPurch += nv;
                    }
                } catch (e) { console.error("Error processing purchases for 2550:", r, e); }
            });
            sourceTotalInputVatCalc = sourceTotalVatablePurchNet * 0.12;
            calculatedReturnData.totalVatablePurchNet = sourceTotalVatablePurchNet;
            calculatedReturnData.totalNonVatPurch = sourceTotalNonVatPurch;
            calculatedReturnData.totalInputVat = sourceTotalInputVatCalc;

            console.log(`${formName} ${pLabel} ${y}: SourceNetSales=${nf(sourceTotalVatableSalesNet)}, SourceExempt=${nf(sourceTotalExemptSales)}, SourceOutputVAT=${nf(sourceTotalOutputVatCalc)}, SourceNetPurch=${nf(sourceTotalVatablePurchNet)}, SourceNonVatPurch=${nf(sourceTotalNonVatPurch)}, SourceInputVAT=${nf(sourceTotalInputVatCalc)}, SourceSAWT=${nf(sourceSawtVatWithheld)}`);

            let html = `<div class="return-computation" id="2550q-computation-area"
                         data-source-total-net-sales="${sourceTotalVatableSalesNet}"
                         data-source-total-net-purch="${sourceTotalVatablePurchNet}"
                         data-source-exempt-sales="${sourceTotalExemptSales}"
                         data-source-nonvat-purch="${sourceTotalNonVatPurch}"
                         data-sawt-vat-withheld="${sourceSawtVatWithheld}"
                         data-reporting-type="${reportingType}">`;
            html += `<h4 class="section-title mb-4">BIR Form ${formName} (${pLabel} ${y}) - VAT Return</h4>`;
            html += `<div class="computation-group-title">Schedule 1: Sales / Receipts and Output Tax Due</div>`;
            html += `<div class="results-table-wrapper mb-2"><table class="return-atc-table vat-input-table"><thead><tr><th>Description</th><th class="number">Taxable Amount (Net)</th><th class="number">Output VAT</th></tr></thead><tbody>`;
            html += `<tr><td>Sales to Private Sector</td><td><input type="number" id="sales-private-net" value="${nf(sourceTotalVatableSalesNet)}" step="0.01" class="value-input manual-input vat-net-input" data-target-vat="sales-private-vat"></td><td class="number"><span id="sales-private-vat">${nf(sourceTotalOutputVatCalc)}</span></td></tr>`;
            html += `<tr><td>Sales to Government</td><td><input type="number" id="sales-govt-net" value="0.00" step="0.01" class="value-input manual-input vat-net-input" data-target-vat="sales-govt-vat"></td><td class="number"><span id="sales-govt-vat">0.00</span></td></tr>`;
            html += `<tr><td>Exempt Sales</td><td class="number" id="display-exempt-sales">${nf(sourceTotalExemptSales)}</td><td class="number">N/A</td></tr>`;
            html += `<tr><td><strong>Total Sales / Receipts</strong></td><td class="number"><strong><span id="total-sales-net-display">${nf(sourceTotalVatableSalesNet + sourceTotalExemptSales)}</span></strong></td><td></td></tr>`;
            html += `</tbody><tfoot><tr><td colspan="2" class="text-right font-semibold">Total Output Tax Due:</td><td class="number font-semibold"><span id="total-output-vat-display">${nf(sourceTotalOutputVatCalc)}</span></td></tr></tfoot></table></div>`;
            html += `<div class="validation-info mb-4"><div class="computation-row"><dt class="label">Source Vatable Sales (Net) Total:</dt><dd class="value">${nf(sourceTotalVatableSalesNet)}</dd></div><div class="computation-row"><dt class="label">Manually Allocated Sales (Net) Total:</dt><dd class="value" id="sales-allocated-total">0.00</dd></div><div class="computation-row"><dt class="label">Difference:</dt><dd class="value validation-balance" id="sales-validation-balance">0.00</dd></div></div>`;

            html += `<div class="computation-group-title mt-4">Schedule 2: Input Tax</div>`;
            html += `<div class="computation-row input-row"><label for="input-tax-carry-over" class="label carry-over-label">Input Tax Carried Over from Previous Period</label><input type="number" id="input-tax-carry-over" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            html += `<div class="results-table-wrapper mb-2"><table class="return-atc-table vat-input-table"><thead><tr><th>Description</th><th class="number">Amount (Net of VAT/Non-VAT)</th><th class="number">Input VAT</th></tr></thead><tbody>`;
            html += `<tr><td>Domestic Purchases of Goods</td><td><input type="number" id="purch-goods-net" value="${nf(sourceTotalVatablePurchNet)}" step="0.01" class="value-input manual-input vat-net-input" data-target-vat="purch-goods-vat"></td><td class="number"><span id="purch-goods-vat">${nf(sourceTotalInputVatCalc)}</span></td></tr>`;
            html += `<tr><td>Domestic Purchases of Services</td><td><input type="number" id="purch-services-net" value="0.00" step="0.01" class="value-input manual-input vat-net-input" data-target-vat="purch-services-vat"></td><td class="number"><span id="purch-services-vat">0.00</span></td></tr>`;
            html += `<tr><td>Purchases Not Qualified for Input Tax (Non-VAT Only)</td><td class="number" id="display-nonvat-purch">${nf(sourceTotalNonVatPurch)}</td><td class="number">N/A</td></tr>`;
            html += `<tr><td><strong>Total Purchases / Expenses</strong></td><td class="number"><strong><span id="total-purchases-display">${nf(sourceTotalVatablePurchNet + sourceTotalNonVatPurch)}</span></strong></td><td></td></tr>`;
            html += `</tbody><tfoot><tr><td colspan="2" class="text-right font-semibold">Total Current Input Tax:</td><td class="number font-semibold"><span id="total-input-vat-display">${nf(sourceTotalInputVatCalc)}</span></td></tr></tfoot></table></div>`;
            html += `<div class="validation-info mb-4"><div class="computation-row"><dt class="label">Source Vatable Purchases (Net) Total:</dt><dd class="value">${nf(sourceTotalVatablePurchNet)}</dd></div><div class="computation-row"><dt class="label">Manually Allocated Purchases (Net) Total:</dt><dd class="value" id="purch-allocated-total">0.00</dd></div><div class="computation-row"><dt class="label">Difference:</dt><dd class="value validation-balance" id="purch-validation-balance">0.00</dd></div></div>`;

            html += `<div class="computation-group-title mt-4">Schedule 3: Computation of VAT Payable</div>`;
            html += `<dl id="final-vat-computation">`;
            html += `<div class="computation-row"><dt class="label">Total Output Tax Due</dt><dd class="value" id="disp-output-tax-final">${nf(sourceTotalOutputVatCalc)}</dd></div>`;
            html += `<div class="computation-row"><dt class="label">Total Available Input Tax (Current + Carry-over)</dt><dd class="value" id="total-available-input-tax-final">${nf(sourceTotalInputVatCalc)}</dd></div>`;
            html += `<div class="computation-row total-row"><dt class="label">VAT Due / (Overpayment)</dt><dd class="value total" id="vat-due-overpayment-final">0.00</dd></div>`;
            html += `<div class="computation-group-title mt-4">Less: Tax Credits/Payments</div>`;
            html += `<div class="computation-row"><dt class="label">Creditable VAT Withheld (SAWT - Form 2307)</dt><dd class="value">${nf(sourceSawtVatWithheld)}</dd></div>`;

            if (isQuarterly) {
                html += `<div class="computation-row input-row"><label for="vat-paid-month1" class="label carry-over-label">VAT Paid - 1st Month of Quarter</label><input type="number" id="vat-paid-month1" value="0.00" step="0.01" class="value-input manual-input"></div>`;
                html += `<div class="computation-row input-row"><label for="vat-paid-month2" class="label carry-over-label">VAT Paid - 2nd Month of Quarter</label><input type="number" id="vat-paid-month2" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            } else if (isAnnual) {
                html += `<div class="computation-row input-row"><label for="vat-paid-previous-months" class="label carry-over-label">VAT Paid - Previous Months (e.g., Jan-Nov)</label><input type="number" id="vat-paid-previous-months" value="0.00" step="0.01" class="value-input manual-input"></div>`;
            }
            html += `<div class="computation-row"><dt class="label">Advance Payments / Other Credits</dt><dd class="value">N/A</dd></div>`; // Placeholder for other credits
            html += `<div class="computation-row total-row mt-4"><dt class="label">Net VAT Payable / (Overpayment)</dt><dd class="value total" id="net-vat-payable-final">0.00</dd></div>`;
            html += `</dl>`;
            html += `<div class="recalculate-button-wrapper mt-4"><button type="button" class="recalculate-button" data-return-type="2550q" data-reporting-type="${reportingType}">Recalculate VAT Payable</button></div>`;
            html += `<p class="text-xs text-gray-500 mt-2">* Sales and Purchase amounts (Net) are preset based on total source data but can be manually allocated. Validation checks against source totals.</p>`;
            html += `</div>`;
            html += `<div class="supporting-details"><h4 class="sub-section-title">Supporting Details</h4><h5>Summary List of Sales (SLS)</h5>${generateSlsReport(reportingType, period, year)}<h5 class="mt-4">Summary List of Purchases (SLP)</h5>${generateSlpReport(reportingType, period, year)}<h5 class="mt-4">SAWT (VAT/PT)</h5>${generateSawtVatReport(reportingType, period, year)}</div>`;

            setTimeout(() => {
                const wrapper = document.getElementById('2550q-computation-area'); if (!wrapper) return;
                const vatInputs = wrapper.querySelectorAll('.vat-net-input');
                vatInputs.forEach(input => {
                    input.removeEventListener('input', handleVatInputChange);
                    input.addEventListener('input', handleVatInputChange);
                });
                const recalcBtn = wrapper.querySelector('.recalculate-button[data-return-type="2550q"]');
                if(recalcBtn) handleRecalculate({ target: recalcBtn });
            }, 0);
            return html;
         }

        // --- Benchmark Analysis Helper Functions ---
        function generateBenchmarkDisplayHTML(actualRate, benchmarkRate, rateType, lowerIsWorse = true, notApplicableMessage = "N/A") {
            if (benchmarkRate === undefined || benchmarkRate === null || isNaN(benchmarkRate)) {
                return `<div class="computation-row benchmark-item"><dt class="label">${rateType}</dt><dd class="value">${notApplicableMessage} (Benchmark not available for industry)</dd></div>`;
            }
             if (isNaN(actualRate) || !isFinite(actualRate)) {
                  return `<div class="computation-row benchmark-item"><dt class="label">${rateType}</dt><dd class="value">${notApplicableMessage} (Actual N/A)</dd></div>`;
             }

            const isOk = lowerIsWorse ? (actualRate >= benchmarkRate) : (actualRate <= benchmarkRate);
            const diff = actualRate - benchmarkRate;
            let comparisonText = "";
            let comparisonClass = isOk ? 'benchmark-ok' : 'benchmark-low';

            if (Math.abs(diff) < 0.0001) { // Using a small epsilon for float comparison
                comparisonText = " (Matches Benchmark)";
                comparisonClass = 'benchmark-ok';
            } else if (benchmarkRate === 0 && actualRate !== 0) {
                comparisonText = actualRate > 0 ? " (Above Benchmark of 0%)" : " (Below Benchmark of 0%)";
                comparisonClass = (lowerIsWorse && actualRate > 0) || (!lowerIsWorse && actualRate < 0) ? 'benchmark-ok' : 'benchmark-low';
            } else if (benchmarkRate === 0 && actualRate === 0) {
                 comparisonText = " (Matches Benchmark at 0%)";
                 comparisonClass = 'benchmark-ok';
            } else if (benchmarkRate !== 0) { // Avoid division by zero if benchmarkRate is 0
                const diffPercent = (diff / Math.abs(benchmarkRate)) * 100;
                comparisonText = ` (${nf(Math.abs(diffPercent), 1)}% ${diff > 0 ? (lowerIsWorse ? 'above' : 'below') : (lowerIsWorse ? 'below' : 'above')} Benchmark)`;
            }


            return `
                <div class="computation-row benchmark-item">
                    <dt class="label">Benchmark ${rateType} (Industry):</dt>
                    <dd class="value">${nf(benchmarkRate * 100, 2)}%</dd>
                </div>
                <div class="computation-row benchmark-item">
                    <dt class="label">Actual ${rateType}:</dt>
                    <dd class="value ${comparisonClass}">${nf(actualRate * 100, 2)}% ${comparisonText}</dd>
                </div>`;
        }

        function addBenchmarkAnalysisSection(returnComputationDiv, currentAppSettings, calculatedData, reportingType, returnTargetId) {
            if (!returnComputationDiv || !currentAppSettings.industry) return;

            const existingBenchmarkSection = returnComputationDiv.querySelector('.benchmark-analysis');
            if (existingBenchmarkSection) existingBenchmarkSection.remove();

            const benchmark = benchmarkTableData.find(b => b.industry.toLowerCase() === currentAppSettings.industry.toLowerCase());
            if (!benchmark) {
                console.warn("Benchmark data not found for industry:", currentAppSettings.industry);
                return;
            }

            let benchmarkHtml = '<div class="benchmark-analysis">';
            benchmarkHtml += '<h5 class="computation-group-title">Benchmark Analysis</h5>';
            benchmarkHtml += '<dl>';

             if (returnTargetId === 'return-2550q' && calculatedData.hasOwnProperty('totalVatableSalesNetForRate') && calculatedData.hasOwnProperty('vatDue')) {
                 const actualVatDueRate = (calculatedData.totalVatableSalesNetForRate > 0) ? (calculatedData.vatDue / calculatedData.totalVatableSalesNetForRate) : 0;
                 benchmarkHtml += generateBenchmarkDisplayHTML(actualVatDueRate, benchmark.vatRate, "VAT Due Rate");
             }

            const isGraduatedITR = returnTargetId === 'return-itr' &&
                                   !currentAppSettings.taxTypes.includes('it-8') &&
                                   (currentAppSettings.classification === 'individual' || currentAppSettings.classification === 'corporation');

            if (isGraduatedITR) {
                if (calculatedData.hasOwnProperty('totalSalesForRate') && calculatedData.hasOwnProperty('grossIncomeForRate')) {
                    const actualGpRate = (calculatedData.totalSalesForRate > 0) ? (calculatedData.grossIncomeForRate / calculatedData.totalSalesForRate) : 0;
                    benchmarkHtml += generateBenchmarkDisplayHTML(actualGpRate, benchmark.gpr, "Gross Profit (GP) Rate");
                }
                if (calculatedData.hasOwnProperty('totalSalesForRate') && calculatedData.hasOwnProperty('taxDueBeforeCredits')) {
                    const actualItRate = (calculatedData.totalSalesForRate > 0) ? (calculatedData.taxDueBeforeCredits / calculatedData.totalSalesForRate) : 0;
                    benchmarkHtml += generateBenchmarkDisplayHTML(actualItRate, benchmark.itr, "Income Tax (IT) Rate");
                }
            }

            benchmarkHtml += '</dl></div>';
            if (benchmarkHtml.includes('<div class="computation-row benchmark-item">')) { // Only add if content exists
                returnComputationDiv.insertAdjacentHTML('beforeend', benchmarkHtml);
            }
        }


        // --- Recalculate Function ---
        function handleRecalculate(event) {
             const button = event.target;
             const returnType = button.dataset.returnType;
             const currentReportingType = button.dataset.reportingType;
             const wrapper = button.closest('.return-computation');
             if (!wrapper) { console.error("Recalculate Error: Could not find parent wrapper."); return; }
             console.log(`Recalculating for ${returnType}, Reporting Type: ${currentReportingType}`);

             const getNum = (selector, isInput = true) => {
                 const el = wrapper.querySelector(selector);
                 if (!el) { console.warn(`Recalc: Element ${selector} not found.`); return 0; }
                 const val = isInput ? el.value : el.textContent;
                 return safeParseFloat(val); // Use safeParseFloat here as well
             };
             const getText = (elementId) => {
                 const el = wrapper.querySelector(`#${elementId}`);
                 return el ? el.value : '';
             };
             const getVal = (elementId, isInput = true) => {
                 const el = wrapper.querySelector(`#${elementId}`);
                 if (!el) { console.warn(`Recalc: Element #${elementId} not found.`); return 0; }
                 const valStr = isInput ? el.value : el.textContent;
                 return safeParseFloat(valStr); // Use safeParseFloat
             };
             const setDisp = (selector, value, format = true, suffixText = "") => {
                 const el = wrapper.querySelector(selector);
                 if (el) el.textContent = (format ? nf(value) : value) + suffixText;
                 else console.warn(`Recalc: Display element ${selector} not found.`);
             };
             const setValidation = (balanceSelector, balanceValue, isOkClass = true) => {
                 const el = wrapper.querySelector(balanceSelector);
                 if (el) {
                     el.textContent = nf(balanceValue);
                     if (isOkClass) {
                         el.classList.remove('ok', 'mismatch');
                         if (Math.abs(balanceValue) < 0.01) { el.classList.add('ok'); }
                         else { el.classList.add('mismatch'); }
                     }
                 } else { console.warn(`Recalc: Validation balance element ${balanceSelector} not found.`); }
             };
              const setPrintAttributes = (rowSelector, descId, amountId) => {
                 const rowEl = wrapper.querySelector(rowSelector);
                 if (rowEl) {
                     rowEl.dataset.printDesc = getText(descId) || "N/A";
                     rowEl.dataset.printAmount = nf(getVal(amountId));
                 } else {
                      console.warn(`Recalc: Exception row element ${rowSelector} not found for print attributes.`);
                 }
              };

            let calculatedReturnDataForBenchmark = {};

             try {
                 if (returnType === '1601eq') {
                    const r1 = wrapper.querySelector('#remitted-month1'); const r2 = wrapper.querySelector('#remitted-month2');
                    const tws = wrapper.querySelector('#total-withheld-1601eq'); const ntds = wrapper.querySelector('#net-tax-due-1601eq');
                    const penS = wrapper.querySelector('#penalty-surcharge'); const penI = wrapper.querySelector('#penalty-interest'); const penC = wrapper.querySelector('#penalty-compromise');
                    if (!tws || !ntds || !penS || !penI || !penC) { console.error("Missing 1601EQ/0619E recalc elements."); return; }
                    const tw = getNum('#total-withheld-1601eq', false); const rem1 = r1 ? getVal('remitted-month1') : 0; const rem2 = r2 ? getVal('remitted-month2') : 0;
                    const pS_val = getVal('penalty-surcharge'); const pI_val = getVal('penalty-interest'); const pC_val = getVal('penalty-compromise');
                    const netPayableBeforePenalties = tw - rem1 - rem2; const totalDue = netPayableBeforePenalties + pS_val + pI_val + pC_val;
                    setDisp('#net-tax-due-1601eq', totalDue);
                    console.log(`Recalced ${returnType}. Base TW: ${tw}, R1: ${rem1}, R2: ${rem2}, Pen: ${pS_val + pI_val + pC_val}, Total Due: ${totalDue}`);
                 }
                 else if (returnType === '1601c') {
                    const inputWH = getVal('input-tax-withheld-1601c', false);
                    const adjPrev = getVal('adj-prev-month-1601c');
                    const adjCurr = getVal('adj-curr-month-1601c');
                    const totalWHAdjusted = inputWH + adjPrev - adjCurr;
                    setDisp('#total-wh-adjusted-1601c', totalWHAdjusted);

                    const penS = getVal('penalty-surcharge-1601c');
                    const penI = getVal('penalty-interest-1601c');
                    const pC = getVal('penalty-compromise-1601c');
                    const totalPenalties = penS + penI + pC;
                    const totalRemittance = totalWHAdjusted + totalPenalties;
                    setDisp('#total-remittance-1601c', totalRemittance);
                    console.log(`Recalced 1601C. InputWH: ${inputWH}, AdjP: ${adjPrev}, AdjC: ${adjCurr}, TotalWHAdj: ${totalWHAdjusted}, Pen: ${totalPenalties}, Total Remit: ${totalRemittance}`);
                 }
                 else if (returnType === 'itr8') {
                      const isAnnualRecalc = currentReportingType === 'annual';
                      const currentPeriodSales = safeParseFloat(wrapper.dataset.currentPeriodSales);
                      const currentPeriodWithheldIT = safeParseFloat(wrapper.dataset.currentPeriodWithheld);
                      const prevSales = isAnnualRecalc ? 0 : getVal('prev-sales');
                      const prevPaid = getVal('prev-tax-paid');
                      const prevWH = isAnnualRecalc ? 0 : getVal('prev-tax-withheld');

                      const totalSalesYTD = currentPeriodSales + prevSales;
                      const taxableIncomeYTD = Math.max(0, totalSalesYTD - 250000);
                      const taxDueYTD = taxableIncomeYTD * 0.08;
                      const totalCredits = prevPaid + (isAnnualRecalc ? 0 : prevWH) + currentPeriodWithheldIT;
                      const netPayable = taxDueYTD - totalCredits;

                      setDisp('#disp-total-sales-ytd', totalSalesYTD);
                      setDisp('#disp-taxable-income-ytd', taxableIncomeYTD);
                      setDisp('#disp-tax-due-ytd', taxDueYTD);
                      setDisp('#disp-prev-paid', prevPaid);
                      if (!isAnnualRecalc) setDisp('#disp-prev-withheld', prevWH);
                      setDisp('#disp-current-withheld', currentPeriodWithheldIT);
                      setDisp('#disp-total-credits', totalCredits);
                      setDisp('#disp-net-payable', netPayable);

                      calculatedReturnDataForBenchmark.totalSales = totalSalesYTD;
                      calculatedReturnDataForBenchmark.taxDueBeforeCredits = taxDueYTD;

                      console.log(`Recalced ITR 8%. CurrSales: ${currentPeriodSales}, PrevSales: ${prevSales}, TotSalesYTD: ${totalSalesYTD}, TaxIncYTD: ${taxableIncomeYTD}, TaxDueYTD: ${taxDueYTD}, PrevPaid: ${prevPaid}, PrevWH: ${prevWH}, CurrWH: ${currentPeriodWithheldIT}, TotCredits: ${totalCredits}, NetPayable: ${netPayable}`);
                 }
                 else if (returnType === '2550q') {
                    const isAnnualRecalc = currentReportingType === 'annual';
                    const privateNet = getVal('sales-private-net'); const govtNet = getVal('sales-govt-net');
                    const goodsNet = getVal('purch-goods-net'); const servicesNet = getVal('purch-services-net');
                    const carryOver = getVal('input-tax-carry-over');
                    let paidPrev = 0;
                    if (currentReportingType === 'quarterly') {
                        paidPrev = getVal('vat-paid-month1') + getVal('vat-paid-month2');
                    } else if (isAnnualRecalc) {
                        paidPrev = getVal('vat-paid-previous-months');
                    }

                    const privateVAT = getNum('#sales-private-vat', false); const govtVAT = getNum('#sales-govt-vat', false);
                    const goodsVAT = getNum('#purch-goods-vat', false); const servicesVAT = getNum('#purch-services-vat', false);

                    const totalManualOutputVAT = privateVAT + govtVAT;
                    const totalManualInputVAT = goodsVAT + servicesVAT;
                    setDisp('#total-output-vat-display', totalManualOutputVAT);
                    setDisp('#total-input-vat-display', totalManualInputVAT);

                    const sourceExemptSales = safeParseFloat(wrapper.dataset.sourceExemptSales);
                    const sourceNonVatPurch = safeParseFloat(wrapper.dataset.sourceNonvatPurch);
                    const sourceNetSales = safeParseFloat(wrapper.dataset.sourceTotalNetSales);
                    const sourceNetPurch = safeParseFloat(wrapper.dataset.sourceTotalNetPurch);

                    setDisp('#display-exempt-sales', sourceExemptSales);
                    setDisp('#display-nonvat-purch', sourceNonVatPurch);
                    const allocatedSales = privateNet + govtNet;
                    setDisp('#total-sales-net-display', allocatedSales + sourceExemptSales);
                    const allocatedPurch = goodsNet + servicesNet;
                    setDisp('#total-purchases-display', allocatedPurch + sourceNonVatPurch);

                    const salesDiff = sourceNetSales - allocatedSales;
                    const purchDiff = sourceNetPurch - allocatedPurch;
                    setDisp('#sales-allocated-total', allocatedSales); setValidation('#sales-validation-balance', salesDiff);
                    setDisp('#purch-allocated-total', allocatedPurch); setValidation('#purch-validation-balance', purchDiff);

                    const totalAvailableInputTax = totalManualInputVAT + carryOver;
                    const vatDueOverpayment = totalManualOutputVAT - totalAvailableInputTax;
                    const sawtWH = safeParseFloat(wrapper.dataset.sawtVatWithheld);
                    const netPayable = vatDueOverpayment - sawtWH - paidPrev;

                    setDisp('#disp-output-tax-final', totalManualOutputVAT);
                    setDisp('#total-available-input-tax-final', totalAvailableInputTax);
                    setDisp('#vat-due-overpayment-final', vatDueOverpayment);
                    setDisp('#net-vat-payable-final', netPayable);

                    calculatedReturnDataForBenchmark.totalVatableSalesNetForRate = allocatedSales;
                    calculatedReturnDataForBenchmark.vatDue = vatDueOverpayment;

                    console.log(`Recalced 2550Q. ManualOutputVAT: ${totalManualOutputVAT}, ManualInputVAT: ${totalManualInputVAT}, CarryOver: ${carryOver}, AvailInp: ${totalAvailableInputTax}, VATDue: ${vatDueOverpayment}, SAWT: ${sawtWH}, PaidPrev: ${paidPrev}, NetPayable: ${netPayable}`);
                 }
                 else if (returnType === '1701q' || returnType === '1702q') {
                    const isCorp = returnType === '1702q';
                    const isAnnualRecalc = currentReportingType === 'annual';
                    const sfx = isCorp ? '-corp' : '';
                    const currentYear = parseInt(wrapper.closest('#returns-content').querySelector('#returns-year').value || new Date().getFullYear());


                    const cRev = safeParseFloat(wrapper.dataset.currentRevenue);
                    const cWit = safeParseFloat(wrapper.dataset.currentWithheld);
                    const poolPurchExpGen = safeParseFloat(wrapper.dataset.poolPurchExp);
                    const poolPayrollGen = safeParseFloat(wrapper.dataset.poolPayroll);
                    const poolNonBir = safeParseFloat(wrapper.dataset.poolNonbir);
                    const poolContribExp = safeParseFloat(wrapper.dataset.poolContribExp);

                    const cbInv = getVal(`cos-beginv${sfx}`); const cPurch = getVal(`cos-purchases${sfx}`);
                    const cDL = getVal(`cos-directlabor${sfx}`); const cDepC = getVal(`cos-depcost${sfx}`);
                    const cOth = getVal(`cos-others${sfx}`); const ceInv = getVal(`cos-endinv${sfx}`);
                    const dExp = getVal(`ded-expenses${sfx}`); const dSal = getVal(`ded-salaries${sfx}`);
                    const dDepD = getVal(`ded-depded${sfx}`); const dIntD = getVal(`ded-intded${sfx}`); // Renamed from ded-intded to other expense
                    const nonBirCos = getVal(`ded-nonbir-exp-cos${sfx}`); const nonBirOpex = getVal(`ded-nonbir-exp-opex${sfx}`);
                    const contribCos = getVal(`ded-contrib-exp-cos${sfx}`); const contribOpex = getVal(`ded-contrib-exp-opex${sfx}`);
                    const excpPurchAmt = getVal(`excp-purch-amount${sfx}`);
                    const excpPayrollAmt = getVal(`excp-payroll-amount${sfx}`);
                    const excpNonBirAmt = getVal(`excp-nonbir-amount${sfx}`);
                    setPrintAttributes(`.exception-item-row:has(#excp-purch-amount${sfx})`, `excp-purch-desc${sfx}`, `excp-purch-amount${sfx}`);
                    setPrintAttributes(`.exception-item-row:has(#excp-payroll-amount${sfx})`, `excp-payroll-desc${sfx}`, `excp-payroll-amount${sfx}`);
                    setPrintAttributes(`.exception-item-row:has(#excp-nonbir-amount${sfx})`, `excp-nonbir-desc${sfx}`, `excp-nonbir-amount${sfx}`);

                    const totCOS_currentPeriod = cbInv + cPurch + cDL + nonBirCos + contribCos + cDepC + cOth - ceInv;
                    const grossIncome_currentPeriod = cRev - totCOS_currentPeriod;
                    const totDed_currentPeriod = dExp + dSal + nonBirOpex + contribOpex + dDepD + dIntD;
                    const taxableIncome_currentPeriod = grossIncome_currentPeriod - totDed_currentPeriod;

                    let totalTaxableIncome_Aggregate = taxableIncome_currentPeriod;
                    let prevTaxableForYTD = 0;
                    if (!isAnnualRecalc) {
                        prevTaxableForYTD = getVal(isCorp ? `prev-taxable-income-ytd${sfx}` : `prev-taxable`);
                        totalTaxableIncome_Aggregate += prevTaxableForYTD;
                    }

                    let taxDueAggregate = 0;
                    let taxDueForPeriod = 0;
                    let netPayable = 0;
                    let taxBasis = "";

                    const pPay = getVal(`prev-payments${sfx}`);
                    const pWit = isAnnualRecalc ? 0 : getVal(`prev-withheld${sfx}`);
                    const totalCurrentWithheld = cWit; // Already from data-attribute
                    const totCred_Aggregate = pPay + pWit + totalCurrentWithheld;

                    if (isCorp) {
                        const corpTaxRate = (currentYear >= 2020 && totalTaxableIncome_Aggregate <= 5000000 && cRev <= 100000000) ? 0.20 : 0.25; // Added criteria for 20%
                        const incomeBaseForRCIT = isAnnualRecalc ? totalTaxableIncome_Aggregate : taxableIncome_currentPeriod;
                        let grossIncomeBaseForMCIT = isAnnualRecalc ? grossIncome_currentPeriod : grossIncome_currentPeriod; // MCIT is on current period GI for quarterly


                        const rcit_calc = incomeBaseForRCIT > 0 ? incomeBaseForRCIT * corpTaxRate : 0;
                        const compMCITChk = wrapper.querySelector(`#compute-mcit${sfx}`);
                        const compMCIT = compMCITChk ? compMCITChk.checked : false;
                        const mcit_calc = grossIncomeBaseForMCIT > 0 ? grossIncomeBaseForMCIT * 0.02 : 0;

                        taxBasis = "(RCIT)";
                        taxDueForPeriod = rcit_calc;
                        if (compMCIT && mcit_calc > rcit_calc && mcit_calc > 0) {
                            taxDueForPeriod = mcit_calc;
                            taxBasis = "(MCIT)";
                        }
                        taxDueForPeriod = Math.max(0, taxDueForPeriod);

                        netPayable = taxDueForPeriod - totCred_Aggregate; // For corps, credits apply against period due

                        setDisp(`#disp-rcit${sfx}`, rcit_calc, true, ` (@${(corpTaxRate * 100).toFixed(0)}%)`);
                        let mcitDisp = wrapper.querySelector(`#disp-mcit${sfx}`);
                        if (mcitDisp) mcitDisp.textContent = compMCIT ? nf(mcit_calc) : 'N/A (MCIT not computed)';
                        setDisp(`#disp-tax-due-period${sfx}`, taxDueForPeriod);
                        let basisNote = wrapper.querySelector(`#tax-basis-note${sfx}`);
                        if (basisNote) basisNote.textContent = taxBasis;

                        calculatedReturnDataForBenchmark.taxDueBeforeCredits = taxDueForPeriod;

                    } else { // Individual Graduated
                        taxDueAggregate = calculateTaxDue(totalTaxableIncome_Aggregate);
                        netPayable = taxDueAggregate - totCred_Aggregate; // For individuals, credits apply against YTD due
                        setDisp(`#disp-tax-due-ytd`, taxDueAggregate);

                        calculatedReturnDataForBenchmark.taxDueBeforeCredits = taxDueAggregate;
                    }

                    setDisp(`#disp-cos${sfx}`, totCOS_currentPeriod);
                    setDisp(`#disp-gross-income${sfx}`, grossIncome_currentPeriod);
                    setDisp(`#disp-deductions${sfx}`, totDed_currentPeriod);
                    setDisp(`#disp-taxable-income-period${sfx}`, taxableIncome_currentPeriod);
                    if(!isAnnualRecalc && isCorp) setDisp(`#disp-total-taxable-income-ytd${sfx}`, totalTaxableIncome_Aggregate);
                    else if (!isCorp) setDisp(`#disp-total-taxable-ytd`, totalTaxableIncome_Aggregate); // For individual, this is YTD
                    setDisp(`#disp-total-credits${sfx}`, totCred_Aggregate);
                    setDisp(`#net-tax-payable${sfx}`, netPayable);

                    const allocatedPurchExpGen = cPurch + dExp + excpPurchAmt;
                    const balancePurchExpGen = poolPurchExpGen - allocatedPurchExpGen;
                    setDisp(`#disp-alloc-purch-exp-gen${sfx}`, allocatedPurchExpGen); setValidation(`#disp-bal-purch-exp-gen${sfx}`, balancePurchExpGen);
                    setDisp(`#disp-pool-purch-exp-gen${sfx}`, poolPurchExpGen);

                    const allocatedPayrollGen = cDL + dSal + excpPayrollAmt;
                    const balancePayrollGen = poolPayrollGen - allocatedPayrollGen;
                    setDisp(`#disp-alloc-payroll-gen${sfx}`, allocatedPayrollGen); setValidation(`#disp-bal-payroll-gen${sfx}`, balancePayrollGen);
                    setDisp(`#disp-pool-payroll-gen${sfx}`, poolPayrollGen);

                    const allocatedNonBir = nonBirCos + nonBirOpex + excpNonBirAmt;
                    const balanceNonBir = poolNonBir - allocatedNonBir;
                    setDisp(`#disp-alloc-nonbir${sfx}`, allocatedNonBir); setValidation(`#disp-bal-nonbir${sfx}`, balanceNonBir);
                    setDisp(`#disp-pool-nonbir${sfx}`, poolNonBir);

                    const allocatedContribExp = contribCos + contribOpex;
                    const balanceContribExp = poolContribExp - allocatedContribExp;
                    setDisp(`#disp-alloc-contrib-exp${sfx}`, allocatedContribExp); setValidation(`#disp-bal-contrib-exp${sfx}`, balanceContribExp);
                    setDisp(`#disp-pool-contrib-exp${sfx}`, poolContribExp);

                    calculatedReturnDataForBenchmark.totalSalesForRate = cRev;
                    calculatedReturnDataForBenchmark.grossIncomeForRate = grossIncome_currentPeriod;


                    console.log(`Recalced ${returnType} (${currentReportingType}). CurrentPeriodTaxableInc: ${taxableIncome_currentPeriod}, TaxDueForPeriod/Aggregate: ${isCorp ? taxDueForPeriod : taxDueAggregate}, CreditsTotal: ${totCred_Aggregate}, NetPayable: ${netPayable}`);
                 }

                 if (wrapper && (returnType === 'itr8' || returnType === '1701q' || returnType === '1702q' || returnType === '2550q')) {
                     const returnTargetIdForBenchmark = (returnType === 'itr8' || returnType === '1701q' || returnType === '1702q') ? 'return-itr' : 'return-2550q';
                     addBenchmarkAnalysisSection(wrapper, appSettings, calculatedReturnDataForBenchmark, currentReportingType, returnTargetIdForBenchmark);
                 }

             } catch (error) {
                 console.error(`Error during recalculation for ${returnType}:`, error);
                 alert(`An error occurred during recalculation for ${returnType}. Check console.`);
             }
        }
        function handleVatInputChange(event) { const inputEl = event.target; const netValue = safeParseFloat(inputEl.value); const targetVatId = inputEl.dataset.targetVat; const vatDisplayEl = document.getElementById(targetVatId); if (vatDisplayEl) { const calculatedVat = netValue * 0.12; vatDisplayEl.textContent = nf(calculatedVat); } const recalcButton = inputEl.closest('.return-computation').querySelector('.recalculate-button[data-return-type="2550q"]'); if (recalcButton) { handleRecalculate({ target: recalcButton }); } }

        // --- Report Generation Functions ---
        // ... (existing report functions: generateQapReport, generateSlpReport, etc.) ...

        function generateGeneralLedgerReport(reportingType, period, year) {
            console.log(`Entering generateGeneralLedgerReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
            const yearNum = parseInt(year);
            const periodMonths = getPeriodMonths(reportingType, period);
            let html = '';

            // --- Sales Section ---
            if (processedData.sales && processedData.sales.length > 0) {
                const salesByAccountTitle = {};
                let totalPwdScDiscount = 0; // Accumulator for PWD/SC Discount

                processedData.sales.forEach(row => {
                    try {
                        if (!row.DATE) return;
                        const d = new Date(row.DATE);
                        if (isNaN(d.getTime()) || d.getFullYear() !== yearNum || !periodMonths.includes(d.getMonth() + 1)) {
                            return;
                        }

                        const accountTitle = row.ACCOUNT_TITLE_SALES?.trim() || "Uncategorized Sales";
                        if (!salesByAccountTitle[accountTitle]) {
                            // Retaining the 3-column structure for itemized sales lines if still desired for detail
                            salesByAccountTitle[accountTitle] = { taxableExemptBase: 0, nonReportable: 0, total: 0 };
                        }
                        const vatableNet = safeParseFloat(row.VATABLE_RECEIPT) / 1.12;
                        const exempt = safeParseFloat(row.EXEMPT_RECEIPT);
                        const nonReportableAmt = safeParseFloat(row.NONREPORTABLE_RECEIPT);

                        const currentTaxableExemptBase = vatableNet + exempt;
                        salesByAccountTitle[accountTitle].taxableExemptBase += currentTaxableExemptBase;
                        salesByAccountTitle[accountTitle].nonReportable += nonReportableAmt;
                        salesByAccountTitle[accountTitle].total += currentTaxableExemptBase + nonReportableAmt;

                        // Accumulate PWD/SC Discount
                        totalPwdScDiscount += safeParseFloat(row.PWD_SC_DISCOUNT);

                    } catch (e) { console.error("Error processing sales row for GL:", row, e); }
                });

                if (Object.keys(salesByAccountTitle).length > 0 || totalPwdScDiscount !== 0) {
                    html += `<h4 class="sub-section-title mt-4">General Ledger - Sales</h4>`;
                    html += `<div class="results-table-wrapper"><table class="results-table">`;
                    // Headers for the 3-column breakdown per account title
                    html += `<thead><tr><th>Account Title / Description</th><th class="number">Taxable/Exempt Base</th><th class="number">Non-Reportable</th><th class="number">Total</th></tr></thead><tbody>`;

                    let subTotalTaxableExemptBase = 0;
                    let subTotalNonReportable = 0;
                    let grossSalesFromItems = 0;

                    Object.keys(salesByAccountTitle).sort().forEach(title => {
                        const data = salesByAccountTitle[title];
                        html += `<tr>
                                    <td>${title}</td>
                                    <td class="number">${nf(data.taxableExemptBase)}</td>
                                    <td class="number">${nf(data.nonReportable)}</td>
                                    <td class="number">${nf(data.total)}</td>
                                 </tr>`;
                        subTotalTaxableExemptBase += data.taxableExemptBase;
                        subTotalNonReportable += data.nonReportable;
                        grossSalesFromItems += data.total;
                    });

                    // Subtotal row for "Gross Sales" from account titles
                    html += `<tr class="subtotal-row">
                                <td class="text-right font-semibold">Gross Sales (from accounts):</td>
                                <td class="number font-semibold">${nf(subTotalTaxableExemptBase)}</td>
                                <td class="number font-semibold">${nf(subTotalNonReportable)}</td>
                                <td class="number font-semibold">${nf(grossSalesFromItems)}</td>
                             </tr>`;

                    // PWD/SC Discount row
                    // Displaying PWD/SC discount as a reduction, so show as negative if it's a positive number
                    const displayPwdDiscount = totalPwdScDiscount > 0 ? -totalPwdScDiscount : totalPwdScDiscount;
                    html += `<tr>
                                <td>Less: PWD/SC Discount</td>
                                <td></td> 
                                <td></td>
                                <td class="number">${nf(displayPwdDiscount)}</td>
                             </tr>`;

                    // Net Sales row
                    const netSales = grossSalesFromItems + displayPwdDiscount; // displayPwdDiscount is already negative or zero
                    html += `<tr class="font-semibold" style="border-top: 1px solid #9ca3af;">
                                <td class="text-right">Net Sales:</td>
                                <td></td>
                                <td></td>
                                <td class="number">${nf(netSales)}</td>
                             </tr>`;

                    html += `</tbody></table></div>`;
                    html += `<p class="text-xs text-gray-500 mt-1">* Taxable/Exempt Base = (Vatable Receipt / 1.12) + Exempt Receipt.</p>`;

                } else {
                    html += `<p class="text-gray-600 mt-4">No Sales data (including PWD/SC Discounts) for GL in selected period.</p>`;
                }
            } else {
                html += `<p class="text-gray-600 mt-4">No Sales data available for GL.</p>`;
            }

        // --- MODIFIED Purchases/Expenses Section ---
        // This section goes inside the generateGeneralLedgerReport function
        if (processedData.purchasesExpenses && processedData.purchasesExpenses.length > 0) {
            const capexKeywords = [
                "improvement", "deposit", "equipment", "furniture", 
                "fixtures", "land", 
                "investment", "vehicle", "building" // Added new keywords
            ]; 
            
            const opexByAccountTitle = {};
            const capexByAccountTitle = {};

            processedData.purchasesExpenses.forEach(row => {
                try {
                    if (!row.DATE) return;
                    const d = new Date(row.DATE);
                    if (isNaN(d.getTime()) || d.getFullYear() !== yearNum || !periodMonths.includes(d.getMonth() + 1)) {
                        return;
                    }
                    const accountTitle = row.ACCOUNT_TITLE_PURCH?.trim() || "Uncategorized Expenses";
                    const lowerCaseAccountTitle = accountTitle.toLowerCase();
                    let isCapex = false;

                    for (const keyword of capexKeywords) {
                        if (lowerCaseAccountTitle.includes(keyword)) {
                            isCapex = true;
                            break;
                        }
                    }

                    const vatableNet = safeParseFloat(row.VATABLE) / 1.12;
                    const nonVatableAmt = safeParseFloat(row.NON_VATABLE);
                    const nonBirAmt = safeParseFloat(row.NON_BIR); // Assuming NON_BIR is an expense type
                    const currentBirRelated = vatableNet + nonVatableAmt;
                    const currentTotal = currentBirRelated + nonBirAmt;

                    if (isCapex) {
                        if (!capexByAccountTitle[accountTitle]) {
                            capexByAccountTitle[accountTitle] = { birRelated: 0, nonBir: 0, total: 0 };
                        }
                        capexByAccountTitle[accountTitle].birRelated += currentBirRelated;
                        capexByAccountTitle[accountTitle].nonBir += nonBirAmt;
                        capexByAccountTitle[accountTitle].total += currentTotal;
                    } else { // OPEX
                        if (!opexByAccountTitle[accountTitle]) {
                            opexByAccountTitle[accountTitle] = { birRelated: 0, nonBir: 0, total: 0 };
                        }
                        opexByAccountTitle[accountTitle].birRelated += currentBirRelated;
                        opexByAccountTitle[accountTitle].nonBir += nonBirAmt;
                        opexByAccountTitle[accountTitle].total += currentTotal;
                    }
                } catch (e) { console.error("Error processing purchases/expenses row for GL:", row, e); }
            });
            
            html += `<h4 class="sub-section-title mt-6">General Ledger - Purchases & Expenses</h4>`;
            
            if (Object.keys(opexByAccountTitle).length === 0 && Object.keys(capexByAccountTitle).length === 0) {
                html += `<p class="text-gray-600 mt-4">No Purchases/Expenses data for GL in selected period.</p>`;
            } else {
                html += `<div class="results-table-wrapper"><table class="results-table">`;
                html += `<thead><tr><th>Account Title / Category</th><th class="number">BIR Related (VatNet+NonVat)</th><th class="number">Non-BIR</th><th class="number">Total</th></tr></thead><tbody>`;

                let overallTotalBirRelated = 0;
                let overallTotalNonBir = 0;
                let overallGrandTotalExpenses = 0;

                // OPEX Section
                if (Object.keys(opexByAccountTitle).length > 0) {
                    html += `<tr><td colspan="4" class="font-semibold bg-gray-200">Operating Expenditures (OPEX)</td></tr>`;
                    let totalOpexBirRelated = 0;
                    let totalOpexNonBir = 0;
                    let grandTotalOpex = 0;
                    Object.keys(opexByAccountTitle).sort().forEach(title => {
                        const data = opexByAccountTitle[title];
                        html += `<tr><td>    ${title}</td><td class="number">${nf(data.birRelated)}</td><td class="number">${nf(data.nonBir)}</td><td class="number">${nf(data.total)}</td></tr>`;
                        totalOpexBirRelated += data.birRelated;
                        totalOpexNonBir += data.nonBir;
                        grandTotalOpex += data.total;
                    });
                    html += `<tr class="subtotal-row"><td class="text-right font-semibold">Total OPEX:</td><td class="number font-semibold">${nf(totalOpexBirRelated)}</td><td class="number font-semibold">${nf(totalOpexNonBir)}</td><td class="number font-semibold">${nf(grandTotalOpex)}</td></tr>`;
                    overallTotalBirRelated += totalOpexBirRelated;
                    overallTotalNonBir += totalOpexNonBir;
                    overallGrandTotalExpenses += grandTotalOpex;
                } else {
                    html += `<tr><td colspan="4" class="italic text-gray-500">No Operating Expenditures found for the period.</td></tr>`;
                }

                // CAPEX Section
                if (Object.keys(capexByAccountTitle).length > 0) {
                    html += `<tr><td colspan="4" class="font-semibold bg-gray-200 pt-3">Capital Expenditures (CAPEX)</td></tr>`;
                    let totalCapexBirRelated = 0;
                    let totalCapexNonBir = 0;
                    let grandTotalCapex = 0;
                    Object.keys(capexByAccountTitle).sort().forEach(title => {
                        const data = capexByAccountTitle[title];
                        html += `<tr><td>    ${title}</td><td class="number">${nf(data.birRelated)}</td><td class="number">${nf(data.nonBir)}</td><td class="number">${nf(data.total)}</td></tr>`;
                        totalCapexBirRelated += data.birRelated;
                        totalCapexNonBir += data.nonBir;
                        grandTotalCapex += data.total;
                    });
                    html += `<tr class="subtotal-row"><td class="text-right font-semibold">Total CAPEX:</td><td class="number font-semibold">${nf(totalCapexBirRelated)}</td><td class="number font-semibold">${nf(totalCapexNonBir)}</td><td class="number font-semibold">${nf(grandTotalCapex)}</td></tr>`;
                    overallTotalBirRelated += totalCapexBirRelated;
                    overallTotalNonBir += totalCapexNonBir;
                    overallGrandTotalExpenses += grandTotalCapex;
                } else {
                     html += `<tr><td colspan="4" class="italic text-gray-500 pt-3">No Capital Expenditures found for the period.</td></tr>`;
                }
                
                // Overall Total for Purchases & Expenses
                html += `<tr class="font-bold" style="border-top: 2px solid #9ca3af;">
                            <td class="text-right">Total Overall Purchases & Expenses:</td>
                            <td class="number">${nf(overallTotalBirRelated)}</td>
                            <td class="number">${nf(overallTotalNonBir)}</td>
                            <td class="number">${nf(overallGrandTotalExpenses)}</td>
                         </tr>`;

                html += `</tbody></table></div>`;
                html += `<p class="text-xs text-gray-500 mt-1">* BIR Related = (Vatable Purchase / 1.12) + Non-Vatable Purchase.<br>* CAPEX identified by keywords: ${capexKeywords.join(', ')}.</p>`;
            }
        } else { // This else corresponds to: if (processedData.purchasesExpenses && processedData.purchasesExpenses.length > 0)
            html += `<p class="text-gray-600 mt-4">No Purchases/Expenses data available for GL.</p>`;
        }
        // End of Purchases/Expenses section. Next would be Payroll section or end of function.

            // --- REVISED Payroll Section ---
            if (processedData.payroll && processedData.payroll.length > 0) {
                let salariesTaxableCats = 0;
                let salariesNTCat = 0;
                let thirteenthMonthTaxableCats = 0;
                let thirteenthMonthNTCat = 0;
                let erContribTaxableCats = 0; // ER Contrib is an expense regardless of employee category, but we'll follow the column structure
                let erContribNTCat = 0;

                processedData.payroll.forEach(row => {
                    try {
                        if (!row.PAY_DAY) return;
                        const d = new Date(row.PAY_DAY);
                        if (isNaN(d.getTime()) || d.getFullYear() !== yearNum || !periodMonths.includes(d.getMonth() + 1)) {
                            return;
                        }

                        const cat = row.CATEGORY?.trim().toUpperCase() || 'NMWE';
                        const grossPay = safeParseFloat(row.GROSS_PAY);
                        const thirteenthMonthPaid = safeParseFloat(row.THIRTEENTH_MONTH);
                        const erContrib = safeParseFloat(row.CONTRIBUTION_EXPENSE);

                        // Salaries Expense = Gross Pay - 13th Month (as 13th month will be a separate line)
                        const currentSalariesExpense = grossPay - thirteenthMonthPaid;

                        if (cat === 'NT') {
                            salariesNTCat += currentSalariesExpense;
                            thirteenthMonthNTCat += thirteenthMonthPaid;
                            erContribNTCat += erContrib; // All ER Contrib can be associated with NT if desired, or kept total
                        } else { // MWE, L250, NMWE
                            salariesTaxableCats += currentSalariesExpense;
                            thirteenthMonthTaxableCats += thirteenthMonthPaid;
                            erContribTaxableCats += erContrib; // All ER Contrib can be associated with Taxable Cats if desired
                        }
                    } catch (e) { console.error("Error processing payroll row for revised GL:", row, e); }
                });

                if (salariesTaxableCats > 0 || salariesNTCat > 0 || thirteenthMonthTaxableCats > 0 || thirteenthMonthNTCat > 0 || erContribTaxableCats > 0 || erContribNTCat > 0) {
                    html += `<h4 class="sub-section-title mt-6">General Ledger - Payroll Analysis</h4>`;
                    html += `<div class="results-table-wrapper"><table class="results-table">`;
                    html += `<thead>
                                <tr>
                                    <th>Description</th>
                                    <th class="number">Taxable Categories (MWE/L250/NMWE)</th>
                                    <th class="number">NT Category</th>
                                    <th class="number">Total</th>
                                </tr>
                             </thead><tbody>`;

                    const totalSalariesExpense = salariesTaxableCats + salariesNTCat;
                    html += `<tr>
                                <td>Salaries Expense (Gross Pay - 13th Month)</td>
                                <td class="number">${nf(salariesTaxableCats)}</td>
                                <td class="number">${nf(salariesNTCat)}</td>
                                <td class="number font-semibold">${nf(totalSalariesExpense)}</td>
                             </tr>`;

                    const total13thMonthExpense = thirteenthMonthTaxableCats + thirteenthMonthNTCat;
                    html += `<tr>
                                <td>13th Month Expense</td>
                                <td class="number">${nf(thirteenthMonthTaxableCats)}</td>
                                <td class="number">${nf(thirteenthMonthNTCat)}</td>
                                <td class="number font-semibold">${nf(total13thMonthExpense)}</td>
                             </tr>`;

                    // For ER Contributions, it's typically an expense not split by employee tax category.
                    // So, we'll show the total ER contribution. The split by cat columns might be 0 or put all in taxable.
                    // Let's put it all under "Taxable Categories" column for simplicity, as it's an employer expense.
                    const totalERContribExpense = erContribTaxableCats + erContribNTCat;
                    html += `<tr>
                                <td>Contribution Expense (Employer Share)</td>
                                <td class="number">${nf(totalERContribExpense)}</td> 
                                <td class="number">${nf(0)}</td> <!-- Or distribute if you have a specific rule -->
                                <td class="number font-semibold">${nf(totalERContribExpense)}</td>
                             </tr>`;
                    
                    html += `</tbody><tfoot>
                                <tr class="font-semibold">
                                    <td class="text-right">Total Payroll Related Expenses:</td>
                                    <td class="number">${nf(salariesTaxableCats + thirteenthMonthTaxableCats + totalERContribExpense)}</td>
                                    <td class="number">${nf(salariesNTCat + thirteenthMonthNTCat /* + any ER for NT if split */)}</td>
                                    <td class="number">${nf(totalSalariesExpense + total13thMonthExpense + totalERContribExpense)}</td>
                                </tr>
                             </tfoot>`;
                    html += `</table></div>`;
                     html += `<p class="text-xs text-gray-500 mt-1">* 'Taxable Categories' column sums MWE, L250, NMWE. 'NT Category' is for 'NT' employees.
                                <br>* Salaries Expense = Gross Pay from input minus 13th Month Pay from input.
                                <br>* ER Contributions typically aren't split by employee tax category for GL, shown consolidated here primarily under Taxable Categories column.</p>`;

                } else {
                    html += `<p class="text-gray-600 mt-4">No Payroll data for GL analysis in selected period.</p>`;
                }
            } else {
                html += `<p class="text-gray-600 mt-4">No Payroll data available for GL.</p>`;
            }

            if (!html.includes("results-table")) {
                return '<p class="text-gray-600">No data found for General Ledger in the selected period across Sales, Purchases/Expenses, or Payroll.</p>';
            }
            return html;
        }

        function generateSourcesOfInputTaxesReport(reportingType, period, year) {
            console.log(`Entering generateSourcesOfInputTaxesReport... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
            if (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0) {
                return '<p class="text-gray-600">No Purchases/Expenses data available.</p>';
            }
            const yearNum = parseInt(year);
            const periodMonths = getPeriodMonths(reportingType, period);
            let html = '';

            const capexKeywords = [ // Same keywords as in GL report for consistency
                "improvement", "deposit", "equipment", "furniture", 
                "fixtures", "land", 
                "investment", "vehicle", "building"
            ];

            const opexInputTaxSources = {};
            const capexInputTaxSources = {};

            processedData.purchasesExpenses.forEach(row => {
                try {
                    if (!row.DATE) return;
                    const d = new Date(row.DATE);
                    if (isNaN(d.getTime()) || d.getFullYear() !== yearNum || !periodMonths.includes(d.getMonth() + 1)) {
                        return;
                    }

                    const vatableAmount = safeParseFloat(row.VATABLE);
                    if (vatableAmount > 0) {
                        const accountTitle = row.ACCOUNT_TITLE_PURCH?.trim() || "Uncategorized VATable Purchase";
                        const lowerCaseAccountTitle = accountTitle.toLowerCase();
                        let isCapex = false;

                        for (const keyword of capexKeywords) {
                            if (lowerCaseAccountTitle.includes(keyword)) {
                                isCapex = true;
                                break;
                            }
                        }

                        const currentTaxBase = vatableAmount / 1.12;
                        const currentInputTax = safeParseFloat(row.VAT_PURCH) > 0 ? safeParseFloat(row.VAT_PURCH) : (currentTaxBase * 0.12);

                        if (isCapex) {
                            if (!capexInputTaxSources[accountTitle]) {
                                capexInputTaxSources[accountTitle] = { taxBase: 0, inputTax: 0 };
                            }
                            capexInputTaxSources[accountTitle].taxBase += currentTaxBase;
                            capexInputTaxSources[accountTitle].inputTax += currentInputTax;
                        } else { // OPEX
                            if (!opexInputTaxSources[accountTitle]) {
                                opexInputTaxSources[accountTitle] = { taxBase: 0, inputTax: 0 };
                            }
                            opexInputTaxSources[accountTitle].taxBase += currentTaxBase;
                            opexInputTaxSources[accountTitle].inputTax += currentInputTax;
                        }
                    }
                } catch (e) { console.error("Error processing purchases row for Input Tax Sources:", row, e); }
            });

            html += `<h4 class="sub-section-title mt-4">Sources of Input Taxes by Account Title (OPEX/CAPEX)</h4>`;
            if (Object.keys(opexInputTaxSources).length === 0 && Object.keys(capexInputTaxSources).length === 0) {
                html += '<p class="text-gray-600">No VATable purchases found for the selected period.</p>';
                return html;
            }

            html += `<div class="results-table-wrapper"><table class="results-table">`;
            html += `<thead><tr><th>Account Title / Category</th><th class="number">Tax Base</th><th class="number">Input Tax</th></tr></thead><tbody>`;

            let overallTotalTaxBase = 0;
            let overallTotalInputTax = 0;

            // OPEX Section for Input Taxes
            if (Object.keys(opexInputTaxSources).length > 0) {
                html += `<tr><td colspan="3" class="font-semibold bg-gray-200">Operating Expenditures (OPEX) - Input Tax Sources</td></tr>`;
                let totalOpexTaxBase = 0;
                let totalOpexInputTax = 0;
                Object.keys(opexInputTaxSources).sort().forEach(title => {
                    const data = opexInputTaxSources[title];
                    html += `<tr><td>    ${title}</td><td class="number">${nf(data.taxBase)}</td><td class="number">${nf(data.inputTax)}</td></tr>`;
                    totalOpexTaxBase += data.taxBase;
                    totalOpexInputTax += data.inputTax;
                });
                html += `<tr class="subtotal-row"><td class="text-right font-semibold">Total OPEX Input Tax:</td><td class="number font-semibold">${nf(totalOpexTaxBase)}</td><td class="number font-semibold">${nf(totalOpexInputTax)}</td></tr>`;
                overallTotalTaxBase += totalOpexTaxBase;
                overallTotalInputTax += totalOpexInputTax;
            } else {
                 html += `<tr><td colspan="3" class="italic text-gray-500">No OPEX related input taxes found for the period.</td></tr>`;
            }

            // CAPEX Section for Input Taxes
            if (Object.keys(capexInputTaxSources).length > 0) {
                html += `<tr><td colspan="3" class="font-semibold bg-gray-200 pt-3">Capital Expenditures (CAPEX) - Input Tax Sources</td></tr>`;
                let totalCapexTaxBase = 0;
                let totalCapexInputTax = 0;
                Object.keys(capexInputTaxSources).sort().forEach(title => {
                    const data = capexInputTaxSources[title];
                    html += `<tr><td>    ${title}</td><td class="number">${nf(data.taxBase)}</td><td class="number">${nf(data.inputTax)}</td></tr>`;
                    totalCapexTaxBase += data.taxBase;
                    totalCapexInputTax += data.inputTax;
                });
                html += `<tr class="subtotal-row"><td class="text-right font-semibold">Total CAPEX Input Tax:</td><td class="number font-semibold">${nf(totalCapexTaxBase)}</td><td class="number font-semibold">${nf(totalCapexInputTax)}</td></tr>`;
                overallTotalTaxBase += totalCapexTaxBase;
                overallTotalInputTax += totalCapexInputTax;
            } else {
                html += `<tr><td colspan="3" class="italic text-gray-500 pt-3">No CAPEX related input taxes found for the period.</td></tr>`;
            }

            // Overall Total for Input Taxes
            html += `<tr class="font-bold" style="border-top: 2px solid #9ca3af;">
                        <td class="text-right">Total Overall Input Taxes:</td>
                        <td class="number">${nf(overallTotalTaxBase)}</td>
                        <td class="number">${nf(overallTotalInputTax)}</td>
                     </tr>`;

            html += `</tbody></table></div>`;
            html += `<p class="text-xs text-gray-500 mt-4">* Tax Base = Vatable Purchase / 1.12. Input Tax calculated or from 'VAT' column if present.<br>* CAPEX identified by keywords: ${capexKeywords.join(', ')}.</p>`;
            
            return html;
        }
// --- Corrected Report Generation Function ---
function generateReconWHTReport(reportingType, period, year) {
    console.log(`Entering generateReconWHTReport (Modified "As per FS" logic)... Type: ${reportingType}, Period: ${period}, Year: ${year}`);
    if (!processedData.purchasesExpenses || processedData.purchasesExpenses.length === 0) {
        return '<p class="text-gray-600">No Purchases/Expenses data available.</p>';
    }

    const yearNum = parseInt(year);
    const periodMonths = getPeriodMonths(reportingType, period);

    const periodFilteredData = processedData.purchasesExpenses.filter(row => {
        try {
            if (!row.DATE) return false;
            const date = new Date(row.DATE);
            if (isNaN(date.getTime())) return false;
            return date.getFullYear() === yearNum && periodMonths.includes(date.getMonth() + 1);
        } catch (e) {
            console.error("Error filtering ReconWHT row by date:", row, e);
            return false;
        }
    });

    if (periodFilteredData.length === 0) {
        return `<p class="text-gray-600">No Purchases/Expenses data found for the selected period.</p>`;
    }

    const allAccountsSummary = { opex: {}, capex: {} };
    const itemsWithoutWHT_for_SLP_Supporting = []; // This will store items for the supporting SLP

    periodFilteredData.forEach(row => {
        const accountTitle = row.ACCOUNT_TITLE_PURCH?.trim() || "Uncategorized Expenses";
        const category = getExpenseCategoryForReconWHT(accountTitle); // Helper function (defined elsewhere)
        const vatable = safeParseFloat(row.VATABLE);
        const nonVatable = safeParseFloat(row.NON_VATABLE);

        const potentialWHTBaseForRow = (vatable / 1.12) + nonVatable;

        const targetSummaryGroup = category === 'OPEX' ? allAccountsSummary.opex : allAccountsSummary.capex;

        if (!targetSummaryGroup[accountTitle]) {
            targetSummaryGroup[accountTitle] = {
                sum_totalPotentialBase_AsPerSLP: 0, // This accumulates total expense for the account title
                sum_baseSubjectedToWHT: 0,
                sum_amountWithheld: 0
            };
        }

        targetSummaryGroup[accountTitle].sum_totalPotentialBase_AsPerSLP += potentialWHTBaseForRow;

        const withholdingTax = safeParseFloat(row.WITHHOLDING_TAX);
        if (withholdingTax > 0) {
            targetSummaryGroup[accountTitle].sum_baseSubjectedToWHT += potentialWHTBaseForRow;
            targetSummaryGroup[accountTitle].sum_amountWithheld += withholdingTax;
        } else {
            // Add to supporting SLP list if no WHT
            itemsWithoutWHT_for_SLP_Supporting.push(row);
        }
    });

    // Populate items for the main report (OPEX)
    const opexItemsForMainReport = {};
    for (const accTitle in allAccountsSummary.opex) {
        const data = allAccountsSummary.opex[accTitle];
        // MODIFICATION: Include if there's any potential base (sum_totalPotentialBase_AsPerSLP > 0)
        if (data.sum_totalPotentialBase_AsPerSLP > 0) {
            opexItemsForMainReport[accTitle] = {
                taxBase: data.sum_baseSubjectedToWHT, // This will be 0 if no WHT for this account
                amountWithheld: data.sum_amountWithheld, // This will be 0 if no WHT for this account
                asPerSLP_TotalBase: data.sum_totalPotentialBase_AsPerSLP, // Total expense for this account
                difference: data.sum_totalPotentialBase_AsPerSLP - data.sum_baseSubjectedToWHT
            };
        }
    }

    // Populate items for the main report (CAPEX)
    const capexItemsForMainReport = {};
    for (const accTitle in allAccountsSummary.capex) {
        const data = allAccountsSummary.capex[accTitle];
        // MODIFICATION: Include if there's any potential base (sum_totalPotentialBase_AsPerSLP > 0)
        if (data.sum_totalPotentialBase_AsPerSLP > 0) {
            capexItemsForMainReport[accTitle] = {
                taxBase: data.sum_baseSubjectedToWHT,
                amountWithheld: data.sum_amountWithheld,
                asPerSLP_TotalBase: data.sum_totalPotentialBase_AsPerSLP,
                difference: data.sum_totalPotentialBase_AsPerSLP - data.sum_baseSubjectedToWHT
            };
        }
    }

    let mainReportHtml = '<h3 class="text-lg font-semibold mb-3">Reconciliation of Withholding Taxes - Main Report</h3>';
    mainReportHtml += '<p class="text-sm text-gray-600 mb-3">This report lists all purchase/expense accounts. "Tax Base (Subjected to WHT)" and "Amount Withheld" are shown if withholding occurred. "As per FS" shows the total expense for the account. "Difference" is the portion not subjected to WHT.</p>';

    const generateSummarizedSectionTable = (title, accountGroupItems) => {
        let sectionHtml = `<h4 class="text-md font-medium mt-4 mb-2">${title}</h4>`;
        const accountTitles = Object.keys(accountGroupItems);

        if (accountTitles.length === 0) {
            return { html: sectionHtml + '<p class="text-gray-500">No items for this category.</p>', totals: { totalTaxBase: 0, totalAmountWithheld: 0, totalAsPerSLP: 0, totalDifference: 0 } };
        }

        sectionHtml += `<div class="results-table-wrapper"><table class="results-table">
            <thead>
                <tr>
                    <th>Account Title</th>
                    <th class="number">Tax Base (Subjected to WHT)</th>
                    <th class="number">Amount Withheld</th>
                    <th class="number">As per FS</th>
                    <th class="number">Difference</th>
                </tr>
            </thead>
            <tbody>`;

        let totalTaxBase = 0, totalAmountWithheld = 0, totalAsPerSLP = 0, totalDifference = 0;
        accountTitles.sort().forEach(accTitle => {
            const item = accountGroupItems[accTitle];
            sectionHtml += `<tr>
                <td>${accTitle}</td>
                <td class="number">${nf(item.taxBase)}</td>
                <td class="number">${nf(item.amountWithheld)}</td>
                <td class="number">${nf(item.asPerSLP_TotalBase)}</td>
                <td class="number">${nf(item.difference)}</td>
            </tr>`;
            totalTaxBase += item.taxBase;
            totalAmountWithheld += item.amountWithheld;
            totalAsPerSLP += item.asPerSLP_TotalBase; // This now correctly sums all displayed "As per FS"
            totalDifference += item.difference;
        });

        sectionHtml += `</tbody>
            <tfoot>
                <tr>
                    <td class="font-semibold text-right">Total ${title.split(' ')[0]}</td>
                    <td class="number font-semibold">${nf(totalTaxBase)}</td>
                    <td class="number font-semibold">${nf(totalAmountWithheld)}</td>
                    <td class="number font-semibold">${nf(totalAsPerSLP)}</td>
                    <td class="number font-semibold">${nf(totalDifference)}</td>
                </tr>
            </tfoot>
        </table></div>`;
        return { html: sectionHtml, totals: { totalTaxBase, totalAmountWithheld, totalAsPerSLP, totalDifference } };
    };

    const opexResult = generateSummarizedSectionTable('Operational Expenditures (OPEX)', opexItemsForMainReport);
    const capexResult = generateSummarizedSectionTable('Capital Expenditures (CAPEX)', capexItemsForMainReport);
    mainReportHtml += opexResult.html;
    mainReportHtml += capexResult.html;

    const grandTotalTaxBase = opexResult.totals.totalTaxBase + capexResult.totals.totalTaxBase;
    const grandTotalAmountWithheld = opexResult.totals.totalAmountWithheld + capexResult.totals.totalAmountWithheld;
    const grandTotalAsPerSLP = opexResult.totals.totalAsPerSLP + capexResult.totals.totalAsPerSLP;
    const grandTotalDifference = opexResult.totals.totalDifference + capexResult.totals.totalDifference;

    mainReportHtml += `<h4 class="text-md font-semibold mt-6 mb-2">Grand Totals - Reconciliation</h4>
        <div class="results-table-wrapper">
            <table class="results-table">
                <tfoot>
                    <tr class="font-bold" style="background-color: #e5e7eb;">
                        <td class="text-right">Grand Total</td>
                        <td class="number">${nf(grandTotalTaxBase)}</td>
                        <td class="number">${nf(grandTotalAmountWithheld)}</td>
                        <td class="number">${nf(grandTotalAsPerSLP)}</td>
                        <td class="number">${nf(grandTotalDifference)}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
        <p class="text-xs text-gray-500 mt-2">
            * Tax Base (Subjected to WHT) = Sum of [(Vatable Purchases / 1.12) + Non-Vatable Purchases] for items under the account title that had WHT.<br/>
            * As per FS = Sum of [(Vatable Purchases / 1.12) + Non-Vatable Purchases] for ALL items under the account title within the period.<br/>
            * Difference = As per FS - Tax Base (Subjected to WHT).
        </p>`;

    // --- Supporting Report: SLP for items NOT subjected to WHT ---
    // This part remains the same, as itemsWithoutWHT_for_SLP_Supporting is populated correctly
    let supportingReportHtml = `<div class="supporting-details mt-8 pt-4 border-t border-dashed border-gray-300">
        <h3 class="text-lg font-semibold mb-3">Supporting Report: Purchases NOT Subjected to Withholding Tax</h3>
        <p class="text-sm text-gray-600 mb-3">This report is in Summary List of Purchases (SLP) format, listing individual suppliers for items where no withholding tax was applied.</p>`;

    if (itemsWithoutWHT_for_SLP_Supporting.length === 0) {
        supportingReportHtml += '<p class="text-gray-500">No purchases/expenses found that were not subjected to withholding tax for this period.</p>';
    } else {
        const periodEndDateStr = getPeriodEndDateString(yearNum, reportingType, period);
        let grandTotalPurchaseColumn_supp = 0;
        let grandTotalVatableNet_supp = 0;
        let grandTotalExempt_supp = 0;
        let grandTotalSumOfNetAndExempt_supp = 0;

        const periodGroupedData_supp = {};
        itemsWithoutWHT_for_SLP_Supporting.forEach(row => {
            const tin = row.TIN?.trim();
            // Ensure a unique key for grouping, especially if TIN is missing
            const key = tin || `NO_TIN_${row.SUPPLIER_NAME?.trim() || 'UnknownSupplier'}_${Math.random().toString(36).substring(2, 9)}`;
            if (!periodGroupedData_supp[key]) {
                periodGroupedData_supp[key] = {
                    tin: tin,
                    supplierName: row.SUPPLIER_NAME || 'N/A',
                    address: row.ADDRESS || 'N/A',
                    periodVatableSum: 0,
                    periodNonVatableSum: 0,
                };
            }
            const v = safeParseFloat(row.VATABLE);
            const nv = safeParseFloat(row.NON_VATABLE);

            if (!isNaN(v)) periodGroupedData_supp[key].periodVatableSum += v;
            if (!isNaN(nv)) periodGroupedData_supp[key].periodNonVatableSum += nv;
        });

        const outputRows_supp = [];
        for (const key in periodGroupedData_supp) {
            const group = periodGroupedData_supp[key];
            const grossVatable = group.periodVatableSum;
            const vatableNet = grossVatable / 1.12;
            const exempt = group.periodNonVatableSum;
            const totalNetAndExempt = vatableNet + exempt;

            if (grossVatable > 0 || exempt > 0) {
                outputRows_supp.push({
                    period: periodEndDateStr,
                    tin: group.tin,
                    supplierName: group.supplierName,
                    address: group.address,
                    purchaseColumnValue: grossVatable, // Gross Vatable for "Purchase"
                    vatablePurchaseNet: vatableNet,
                    exemptPurchase: exempt,
                    totalColumnValue: totalNetAndExempt // (Net of VAT) + Exempt
                });
                grandTotalPurchaseColumn_supp += grossVatable;
                grandTotalVatableNet_supp += vatableNet;
                grandTotalExempt_supp += exempt;
                grandTotalSumOfNetAndExempt_supp += totalNetAndExempt;
            }
        }
        outputRows_supp.sort((a, b) => (a.supplierName || '').localeCompare(b.supplierName || ''));

        if (outputRows_supp.length === 0) {
             supportingReportHtml += '<p class="text-gray-500">No SLP data with values found for items not subject to WHT after grouping.</p>';
        } else {
            supportingReportHtml += `<div class="results-table-wrapper"><table class="results-table">
                <thead>
                    <tr>
                        <th>Period End</th><th>TIN</th><th>Supplier Name</th><th>Address</th>
                        <th class="number">Purchase (Gross Vatable)</th>
                        <th class="number">Vatable Purchase (Net)</th>
                        <th class="number">Exempt Purchase</th>
                        <th class="number">Total (Net+Exempt)</th>
                    </tr>
                </thead><tbody>`;
            outputRows_supp.forEach(row => {
                supportingReportHtml += `<tr>
                    <td>${row.period}</td><td>${row.tin || ''}</td><td>${row.supplierName}</td><td>${row.address}</td>
                    <td class="number">${nf(row.purchaseColumnValue)}</td>
                    <td class="number">${nf(row.vatablePurchaseNet)}</td>
                    <td class="number">${nf(row.exemptPurchase)}</td>
                    <td class="number">${nf(row.totalColumnValue)}</td>
                </tr>`;
            });
            supportingReportHtml += `</tbody>
                <tfoot>
                    <tr class="font-semibold" style="background-color: #e5e7eb;">
                        <td colspan="4" class="text-right">Totals (Not Subject to WHT):</td>
                        <td class="number">${nf(grandTotalPurchaseColumn_supp)}</td>
                        <td class="number">${nf(grandTotalVatableNet_supp)}</td>
                        <td class="number">${nf(grandTotalExempt_supp)}</td>
                        <td class="number">${nf(grandTotalSumOfNetAndExempt_supp)}</td>
                    </tr>
                </tfoot>
            </table></div>
            <p class="text-xs text-gray-500 mt-2">* Purchase (Gross Vatable) = Gross Vatable Purchase from source. Vatable Purchase (Net) = Purchase / 1.12. Exempt Purchase = Non-Vatable from source. Total (Net+Exempt) = Vatable Purchase (Net) + Exempt Purchase.</p>`;
        }
    }
    supportingReportHtml += `</div>`;

    return mainReportHtml + supportingReportHtml;
}

// REMINDER: Ensure the helper function getExpenseCategoryForReconWHT is also present in your script:
const RECON_WHT_CAPEX_KEYWORDS = [
    "FIXED ASSET", "EQUIPMENT", "MACHINERY", "BUILDING", "LAND", "PPE",
    "LEASEHOLD IMPROVEMENT", "PROPERTY, PLANT", "INTANGIBLE ASSET",
    "VEHICLE", "FURNITURE", "COMPUTER HARDWARE", "SOFTWARE (CAPITALIZED)",
    "WORK IN PROGRESS - CAPEX", "CONSTRUCTION IN PROGRESS",
    "IMPROVEMENT", "DEPOSIT"
];

function getExpenseCategoryForReconWHT(accountTitle) {
    if (!accountTitle) return 'OPEX';
    const titleUpper = accountTitle.toUpperCase();
    for (const keyword of RECON_WHT_CAPEX_KEYWORDS) {
        if (titleUpper.includes(keyword.toUpperCase())) {
            return 'CAPEX';
        }
    }
    return 'OPEX';
}
       // --- Action Button Event Listeners ---
        function attachActionListeners(isReturnsTab) {
            const printButtonId = isReturnsTab ? 'print-return-button' : 'print-report-button';
            const copyButtonId = isReturnsTab ? 'copy-return-button' : 'copy-report-button';
            const contentWrapperId = isReturnsTab ? 'return-display-content-wrapper' : 'report-display-content-wrapper';
            const printButton = document.getElementById(printButtonId);
            const copyButton = document.getElementById(copyButtonId);
            const contentWrapper = document.getElementById(contentWrapperId);

            if (!contentWrapper) { console.error("Content wrapper not found for attaching actions:", contentWrapperId); return; }

            if (printButton) {
                printButton.onclick = () => {
                    console.log("Print button clicked for wrapper:", contentWrapperId);
                    const exceptionRows = contentWrapper.querySelectorAll('.exception-item-row');
                    exceptionRows.forEach(row => {
                        const descInput = row.querySelector('input[type="text"]');
                        const amountInput = row.querySelector('input[type="number"]');
                        if (descInput && amountInput) {
                            row.dataset.printDesc = descInput.value || "N/A";
                            row.dataset.printAmount = nf(safeParseFloat(amountInput.value));
                        }
                    });

                    const reportBody = contentWrapper.querySelector('#report-content-body');
                    if (reportBody) {
                        window.print();
                    } else {
                        console.warn("No report body found to print in wrapper:", contentWrapperId);
                    }
                };
            } else { console.warn("Print button not found:", printButtonId); }

            if (copyButton) {
                const headerInfo = contentWrapper.querySelector('.report-header-info');
                const tableExists = contentWrapper.querySelector('.results-table, .return-atc-table');
                const computationExists = contentWrapper.querySelector('.return-computation dl');
                const exceptionExists = contentWrapper.querySelector('.exception-items-section');
                const benchmarkExists = contentWrapper.querySelector('.benchmark-analysis');
                const summaryExists = contentWrapper.querySelector('.summary-box');
                const canCopy = headerInfo || tableExists || computationExists || summaryExists || benchmarkExists || exceptionExists;

                copyButton.disabled = !canCopy;
                copyButton.title = canCopy ? "Copy visible report/return data" : "No table, summary, or computation data found to copy";
                copyButton.classList.toggle('opacity-50', !canCopy);
                copyButton.classList.toggle('cursor-not-allowed', !canCopy);

                copyButton.onclick = async (e) => {
                    if (copyButton.disabled) return;
                    const currentHeader = contentWrapper.querySelector('.report-header-info');
                    const currentSummary = contentWrapper.querySelector('.summary-box');
                    const currentComputationDL = contentWrapper.querySelector('.return-computation dl');
                    const currentExceptions = contentWrapper.querySelector('.exception-items-section');
                    const currentBenchmark = contentWrapper.querySelector('.benchmark-analysis');
                    const currentInputTables = contentWrapper.querySelectorAll('.return-atc-table.vat-input-table');
                    const otherTables = contentWrapper.querySelectorAll('.results-table-wrapper, .return-atc-table:not(.vat-input-table)');
                    const supportingDetails = contentWrapper.querySelector('.supporting-details');

                    if (!currentHeader && !currentSummary && !currentComputationDL && !currentExceptions && currentInputTables.length === 0 && otherTables.length === 0 && !supportingDetails && !currentBenchmark) {
                        alert('No specific content (header, summary, computation, exceptions, table, benchmark) found to copy.');
                        return;
                    }

                    try {
                        const tempDiv = document.createElement('div');
                        let copyHTML = currentHeader?.outerHTML || '';
                        copyHTML += currentSummary?.outerHTML || '';
                        if (currentComputationDL) {
                            const computationClone = currentComputationDL.cloneNode(true);
                            computationClone.querySelectorAll('input.manual-input, button.recalculate-button, .recalculate-button-wrapper, div.computation-row.input-row input[type="number"], div.computation-row.input-row input[type="checkbox"], div.computation-row.input-row label[for*="compute-mcit"]').forEach(el => el.closest('.computation-row.input-row') ? el.closest('.computation-row.input-row').remove() : el.remove() );
                            computationClone.querySelectorAll('.validation-info').forEach(el => el.remove());
                            computationClone.querySelectorAll('.exception-items-section').forEach(el => el.remove());
                            const compTitle = contentWrapper.querySelector('.return-computation .section-title');
                            copyHTML += compTitle?.outerHTML || '';
                            copyHTML += computationClone.outerHTML;
                        }
                         if (currentExceptions) {
                            const exceptionClone = currentExceptions.cloneNode(true);
                            exceptionClone.querySelectorAll('input[type="text"], input[type="number"]').forEach(inp => {
                                const span = document.createElement('span');
                                span.textContent = inp.type === 'number' ? nf(safeParseFloat(inp.value)) : inp.value;
                                span.style.marginLeft = '0.5rem';
                                inp.parentNode.insertBefore(span, inp.nextSibling);
                                inp.style.display = 'none';
                            });
                            copyHTML += exceptionClone.outerHTML;
                         }
                        if (currentBenchmark) {
                            copyHTML += currentBenchmark.outerHTML;
                        }
                        currentInputTables.forEach(tbl => {
                            const tableClone = tbl.cloneNode(true);
                            tableClone.querySelectorAll('input.manual-input').forEach(inp => {
                                const span = document.createElement('span');
                                span.textContent = inp.value;
                                inp.parentNode.replaceChild(span, inp);
                            });
                            copyHTML += tableClone.outerHTML;
                        });
                        otherTables.forEach(tblWrapOrTable => {
                            if (!currentComputationDL || !currentComputationDL.contains(tblWrapOrTable)) {
                                copyHTML += tblWrapOrTable.closest('.results-table-wrapper')?.outerHTML || tblWrapOrTable.outerHTML;
                            }
                        });
                        if(supportingDetails){
                            copyHTML += supportingDetails.outerHTML;
                        }

                        tempDiv.innerHTML = copyHTML;

                        try {
                            const blobHtml = new Blob([copyHTML], { type: 'text/html' });
                            const blobText = new Blob([tempDiv.innerText], { type: 'text/plain' });
                            const clipboardItem = new ClipboardItem({ 'text/html': blobHtml, 'text/plain': blobText });
                            await navigator.clipboard.write([clipboardItem]);
                            console.log("Content copied as HTML and Plain Text.");
                        } catch (clipboardErr) {
                            console.warn("HTML/Plain text copy failed, falling back to innerText:", clipboardErr);
                            await navigator.clipboard.writeText(tempDiv.innerText);
                            console.log("Content copied as Plain Text (fallback).");
                        }

                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'Copied!';
                        setTimeout(() => { copyButton.textContent = originalText; }, 2000);

                    } catch (err) {
                        console.error('Failed to copy content: ', err);
                        const originalText = copyButton.textContent;
                        copyButton.textContent = 'Copy Failed';
                        setTimeout(() => { copyButton.textContent = originalText; }, 2000);
                        alert('Failed to copy content. See console for details.');
                    }
                };
            } else { console.warn("Copy button not found:", copyButtonId); }
        }

        // --- Filter Apply Buttons ---
        filterReturnsButton.addEventListener('click', () => { const activeButton = returnsSidebarNav.querySelector('button.sidebar-active:not(.hidden)'); if (activeButton) { displayContentBasedOnSelection(activeButton.dataset.target, returnDisplayContentWrapper, activeButton.textContent); } else { returnDisplayContentWrapper.innerHTML = '<p class="text-orange-500">Please select a return type from the sidebar first.</p>'; } });
        filterReportsButton.addEventListener('click', () => { const activeButton = reportsSidebarNav.querySelector('button.sidebar-active:not(.hidden)'); if (activeButton) { displayContentBasedOnSelection(activeButton.dataset.target, reportDisplayContentWrapper, activeButton.textContent); } else { reportDisplayContentWrapper.innerHTML = '<p class="text-orange-500">Please select a report type from the sidebar first.</p>'; if(datFileGenerationArea) datFileGenerationArea.classList.add('hidden'); } });

        // --- Settings Import/Export/Print ---
        printSettingsButton.addEventListener('click', () => { const settingsContent = document.getElementById('settings-content'); settingsContent.classList.add('printable-area'); window.print(); settingsContent.classList.remove('printable-area'); });
        exportSettingsButton.addEventListener('click', () => {
            const settingsData = {
                name: taxpayerNameInput.value,
                tin: taxpayerTinInput.value,
                address: taxpayerAddressInput.value,
                zip: taxpayerZipInput.value,
                rdo: rdoCodeInput.value,
                classification: taxpayerClassificationSelect.value,
                industry: taxpayerIndustryInput.value,
                incomeTaxType: document.querySelector('input[name="income_tax_type"]:checked')?.value || null,
                salesTaxType: document.querySelector('input[name="sales_tax_type"]:checked')?.value || null,
                wtTypes: Array.from(document.querySelectorAll('input[name="wt_type"]:checked')).map(cb => cb.value)
            };
            const settingsString = JSON.stringify(settingsData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(settingsString);
            let tinPart = (settingsData.tin || 'TIN').trim().replace(/[^a-z0-9_-]/gi, '_');
            let namePart = (settingsData.name || 'NAME').trim().replace(/[^a-z0-9\s_-]/gi, '').replace(/\s+/g, '_');
            const filename = `${tinPart}_${namePart}_TaxApp_Settings_${new Date().toISOString().slice(0,10)}.json`;
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
            linkElement.remove();
        });
        importSettingsInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) { return; }
            if (file.type !== "application/json") { alert("Please select a valid JSON settings file."); return; }
            const reader = new FileReader();
            reader.onload = function(fileEvent) {
                try {
                    const importedSettings = JSON.parse(fileEvent.target.result);
                    taxpayerNameInput.value = importedSettings.name || '';
                    taxpayerTinInput.value = importedSettings.tin || '';
                    taxpayerAddressInput.value = importedSettings.address || '';
                    taxpayerZipInput.value = importedSettings.zip || '';
                    rdoCodeInput.value = importedSettings.rdo || '';
                    taxpayerIndustryInput.value = importedSettings.industry || '';
                    if (importedSettings.classification && ['individual', 'corporation'].includes(importedSettings.classification)) {
                        taxpayerClassificationSelect.value = importedSettings.classification;
                    }
                    incomeTaxRadios.forEach(r => r.checked = false);
                    salesTaxRadios.forEach(r => r.checked = false);
                    wtCheckboxes.forEach(cb => cb.checked = false);
                    if (importedSettings.incomeTaxType) {
                        const incomeRadio = document.querySelector(`input[name="income_tax_type"][value="${importedSettings.incomeTaxType}"]`);
                        if (incomeRadio) incomeRadio.checked = true;
                    } else {
                         if (taxpayerClassificationSelect.value === 'individual') {
                            document.getElementById('it-type-graduated').checked = true;
                         }
                    }
                    if (importedSettings.salesTaxType) {
                        const salesRadio = document.querySelector(`input[name="sales_tax_type"][value="${importedSettings.salesTaxType}"]`);
                        if (salesRadio) salesRadio.checked = true;
                    } else {
                        document.getElementById('sales-tax-none').checked = true;
                    }
                    if (importedSettings.wtTypes && Array.isArray(importedSettings.wtTypes)) {
                        wtCheckboxes.forEach(cb => {
                            if (importedSettings.wtTypes.includes(cb.value)) {
                                cb.checked = true;
                            }
                        });
                    }
                    handleTaxSettingsChange();
                    alert('Settings imported successfully!');
                } catch (err) {
                    console.error("Error parsing imported settings JSON:", err);
                    alert("Error reading or parsing settings file. Please ensure it's a valid JSON.");
                } finally {
                    importSettingsInput.value = '';
                }
            };
            reader.onerror = function() {
                alert("Failed to read the settings file.");
                importSettingsInput.value = '';
            };
            reader.readAsText(file);
        });

        // --- Data Management Logic (Save/Load/Clear) ---
        function handleSaveData() {
            const year = saveDataYearInput.value;
            const selectedSavePeriod = saveDataPeriodSelect.value;
            const tin = (taxpayerTinInput.value || 'TIN').trim().replace(/[^a-z0-9_-]/gi, '_');
            const name = (taxpayerNameInput.value || 'NAME').trim().replace(/[^a-z0-9\s_-]/gi, '').replace(/\s+/g, '_');

            if (!year || isNaN(parseInt(year))) { alert("Please enter a valid Year to save."); return; }
            if (!selectedSavePeriod) { alert("Please select a month to save cumulative data up to."); return; }

            const currentSalesFromTextArea = salesDataText.value;
            const currentPurchasesFromTextArea = purchasesExpensesDataText.value;
            const currentPayrollFromTextArea = payrollDataText.value;

            let salesToSave = "";
            if (internalLoadedSalesRaw.trim()) {
                salesToSave = internalLoadedSalesRaw.trim();
                if (currentSalesFromTextArea.trim()) {
                    const currentLines = currentSalesFromTextArea.trim().split('\n');
                    if(currentLines.length > 0 && Object.values(SALES_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                        salesToSave += (salesToSave.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                        console.log("Detected header in current Sales text area, skipping it when saving.");
                    } else {
                        salesToSave += (salesToSave.endsWith('\n') ? '' : '\n') + currentSalesFromTextArea.trim();
                    }
                }
            } else {
                salesToSave = currentSalesFromTextArea;
            }

            let purchasesToSave = "";
            if (internalLoadedPurchasesRaw.trim()) {
                purchasesToSave = internalLoadedPurchasesRaw.trim();
                if (currentPurchasesFromTextArea.trim()) {
                   const currentLines = currentPurchasesFromTextArea.trim().split('\n');
                    if(currentLines.length > 0 && Object.values(PURCHASES_EXPENSES_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                        purchasesToSave += (purchasesToSave.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                        console.log("Detected header in current Purch/Exp text area, skipping it when saving.");
                    } else {
                        purchasesToSave += (purchasesToSave.endsWith('\n') ? '' : '\n') + currentPurchasesFromTextArea.trim();
                    }
                }
            } else {
                purchasesToSave = currentPurchasesFromTextArea;
            }

            let payrollToSave = "";
            if (internalLoadedPayrollRaw.trim()) {
                payrollToSave = internalLoadedPayrollRaw.trim();
                if (currentPayrollFromTextArea.trim()) {
                   const currentLines = currentPayrollFromTextArea.trim().split('\n');
                    if(currentLines.length > 0 && Object.values(PAYROLL_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                        payrollToSave += (payrollToSave.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                        console.log("Detected header in current Payroll text area, skipping it when saving.");
                    } else {
                         payrollToSave += (payrollToSave.endsWith('\n') ? '' : '\n') + currentPayrollFromTextArea.trim();
                    }
                }
            } else {
                payrollToSave = currentPayrollFromTextArea;
            }


            if (!salesToSave.trim() && !purchasesToSave.trim() && !payrollToSave.trim()) {
                alert("No data to save. Load or input data first.");
                return;
            }

            const filename = `${tin}_${year}${selectedSavePeriod}_${name}_Saved_Input_Data.json`;
            const dataToSaveInFile = {
                dataType: "TalloTaxAppInputData",
                version: "1.1", // Added version for future compatibility
                year: parseInt(year),
                period: selectedSavePeriod,
                savedTimestamp: new Date().toISOString(),
                salesRaw: salesToSave,
                purchasesRaw: purchasesToSave,
                payrollRaw: payrollToSave
            };

            const dataString = JSON.stringify(dataToSaveInFile, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataString);
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', filename);
            linkElement.click();
            linkElement.remove();

            console.log(`Data saved for period ending ${selectedSavePeriod} ${year} as ${filename}`);
            alert(`Data representing cumulative input up to end of ${saveDataPeriodSelect.options[saveDataPeriodSelect.selectedIndex].text} ${year} has been saved as ${filename}.`);
        }
        function handleLoadData(event) {
            const file = event.target.files[0];
            if (!file) { loadStatusDiv.textContent = ''; return; }
            if (file.type !== "application/json") {
                alert("Please select a valid JSON data file (.json).");
                loadStatusDiv.textContent = 'Error: Invalid file type.';
                loadDataInput.value = '';
                return;
            }
            loadStatusDiv.textContent = `Loading ${file.name}...`;
            const reader = new FileReader();
            reader.onload = function(fileEvent) {
                try {
                    const loadedContent = JSON.parse(fileEvent.target.result);
                    if (!loadedContent || loadedContent.dataType !== "TalloTaxAppInputData" || !loadedContent.period || !loadedContent.year) {
                        throw new Error("Invalid or unrecognized data file format.");
                    }
                    internalLoadedSalesRaw = loadedContent.salesRaw || "";
                    internalLoadedPurchasesRaw = loadedContent.purchasesRaw || "";
                    internalLoadedPayrollRaw = loadedContent.payrollRaw || "";

                    salesDataText.value = '';
                    purchasesExpensesDataText.value = '';
                    payrollDataText.value = '';

                    lastLoadedPeriodInfo = `${loadedContent.period} ${loadedContent.year}`;
                    const selectedMonthText = periodOptions.monthly.find(m => m.value === loadedContent.period)?.text || loadedContent.period;
                    loadStatusDiv.textContent = `Loaded data up to ${selectedMonthText} ${loadedContent.year}. Paste current month's data (NO HEADERS) below.`;
                    alert(`Successfully loaded cumulative data up to ${selectedMonthText} ${loadedContent.year}.\n\nPaste data for the *next* month (WITHOUT HEADERS) into the text areas.\n\nThen click 'Generate Reports & Returns'.`);

                    processedData = { sales: [], purchasesExpenses: [], payroll: [], employeeDb: [] };

                } catch (err) {
                    console.error("Error processing loaded data JSON:", err);
                    alert(`Error loading data: ${err.message}. Please ensure it's a valid saved data file.`);
                    loadStatusDiv.textContent = `Error loading ${file.name}.`;
                    internalLoadedSalesRaw = "";
                    internalLoadedPurchasesRaw = "";
                    internalLoadedPayrollRaw = "";
                    lastLoadedPeriodInfo = "";
                } finally {
                    loadDataInput.value = '';
                }
            };
            reader.onerror = function() {
                alert(`Failed to read the file: ${file.name}`);
                loadStatusDiv.textContent = `Error reading ${file.name}.`;
                internalLoadedSalesRaw = "";
                internalLoadedPurchasesRaw = "";
                internalLoadedPayrollRaw = "";
                lastLoadedPeriodInfo = "";
                loadDataInput.value = '';
            };
            reader.readAsText(file);
        }
        function handleClearData() {
             if (window.confirm("Are you sure you want to clear all input text areas, internally loaded data, and processed data? Settings will remain.")) {
                 salesDataText.value = '';
                 purchasesExpensesDataText.value = '';
                 payrollDataText.value = '';
                 internalLoadedSalesRaw = "";
                 internalLoadedPurchasesRaw = "";
                 internalLoadedPayrollRaw = "";
                 lastLoadedPeriodInfo = "";
                 processedData = { sales: [], purchasesExpenses: [], payroll: [], employeeDb: [] };
                 loadDataInput.value = ''; // Reset file input
                 loadStatusDiv.textContent = 'All input data cleared.';
                 console.log("All input and processed data cleared.");
                 alert("All input data areas, loaded data, and processed results have been cleared.");
             }
        }
        saveDataButton.addEventListener('click', handleSaveData);
        loadDataInput.addEventListener('change', handleLoadData);
        clearDataButton.addEventListener('click', handleClearData);

        // --- Generation Logic ---
        generateButton.addEventListener('click', () => {
            console.log('--- Generate Button Clicked ---');
            appSettings = {
                name: taxpayerNameInput.value,
                tin: taxpayerTinInput.value,
                address: taxpayerAddressInput.value,
                zip: taxpayerZipInput.value,
                rdo: rdoCodeInput.value,
                classification: taxpayerClassificationSelect.value,
                industry: taxpayerIndustryInput.value,
                taxTypes: []
            };
            const selectedIncomeTax = document.querySelector('input[name="income_tax_type"]:checked');
            const selectedSalesTax = document.querySelector('input[name="sales_tax_type"]:checked');
            const selectedWtTaxes = document.querySelectorAll('input[name="wt_type"]:checked');

            if (appSettings.classification === 'individual') {
                if (selectedIncomeTax && selectedIncomeTax.value !== 'none') {
                    appSettings.taxTypes.push(selectedIncomeTax.value);
                }
            } else {
                appSettings.taxTypes.push('1702q');
            }
            if (selectedSalesTax && selectedSalesTax.value !== 'none') {
                 if (!(appSettings.classification === 'individual' && appSettings.taxTypes.includes('it-8'))) {
                    appSettings.taxTypes.push(selectedSalesTax.value);
                 }
            }
            selectedWtTaxes.forEach(cb => appSettings.taxTypes.push(cb.value));

            console.log('App Settings:', JSON.stringify(appSettings, null, 2));

            const currentSalesFromTextArea = salesDataText.value;
            const currentPurchasesFromTextArea = purchasesExpensesDataText.value;
            const currentPayrollFromTextArea = payrollDataText.value;

            let finalSalesToParse = "";
            if (internalLoadedSalesRaw.trim()) {
                finalSalesToParse = internalLoadedSalesRaw.trim();
                if (currentSalesFromTextArea.trim()) {
                     const currentLines = currentSalesFromTextArea.trim().split('\n');
                     // Check if the first line of current data looks like a header
                     if(currentLines.length > 0 && Object.values(SALES_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                         finalSalesToParse += (finalSalesToParse.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                     } else {
                          finalSalesToParse += (finalSalesToParse.endsWith('\n') ? '' : '\n') + currentSalesFromTextArea.trim();
                     }
                }
            } else {
                finalSalesToParse = currentSalesFromTextArea;
            }

             let finalPurchasesToParse = "";
             if (internalLoadedPurchasesRaw.trim()) {
                 finalPurchasesToParse = internalLoadedPurchasesRaw.trim();
                 if (currentPurchasesFromTextArea.trim()) {
                     const currentLines = currentPurchasesFromTextArea.trim().split('\n');
                     if(currentLines.length > 0 && Object.values(PURCHASES_EXPENSES_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                         finalPurchasesToParse += (finalPurchasesToParse.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                     } else {
                         finalPurchasesToParse += (finalPurchasesToParse.endsWith('\n') ? '' : '\n') + currentPurchasesFromTextArea.trim();
                     }
                 }
             } else {
                 finalPurchasesToParse = currentPurchasesFromTextArea;
             }

             let finalPayrollToParse = "";
             if (internalLoadedPayrollRaw.trim()) {
                 finalPayrollToParse = internalLoadedPayrollRaw.trim();
                 if (currentPayrollFromTextArea.trim()) {
                    const currentLines = currentPayrollFromTextArea.trim().split('\n');
                     if(currentLines.length > 0 && Object.values(PAYROLL_STD_KEYS).some(stdKey => standardizeHeaderKey(currentLines[0]).includes(stdKey) ) ){
                         finalPayrollToParse += (finalPayrollToParse.endsWith('\n') ? '' : '\n') + currentLines.slice(1).join('\n');
                     } else {
                          finalPayrollToParse += (finalPayrollToParse.endsWith('\n') ? '' : '\n') + currentPayrollFromTextArea.trim();
                     }
                 }
             } else {
                 finalPayrollToParse = currentPayrollFromTextArea;
             }

            console.log("--- Parsing START ---");
            let parseSuccess = true;
            try {
                processedData = { sales: [], purchasesExpenses: [], payroll: [], employeeDb: [] };

                console.log("Parsing Combined Sales Data...");
                processedData.sales = parseTsvData("Sales", finalSalesToParse, salesHeaders); // Pass original salesHeaders for fallback if needed
                console.log(`---> Parsed ${processedData.sales.length} sales rows.`);
                if (processedData.sales.length > 0) console.log("First Sales Row (JS Props):", Object.keys(processedData.sales[0]));

                console.log("Parsing Combined Purchases/Expenses Data...");
                processedData.purchasesExpenses = parseTsvData("Purchases/Expenses", finalPurchasesToParse, purchasesExpensesHeaders);
                console.log(`---> Parsed ${processedData.purchasesExpenses.length} purchases/expenses rows.`);
                 if (processedData.purchasesExpenses.length > 0) console.log("First Purch/Exp Row (JS Props):", Object.keys(processedData.purchasesExpenses[0]));

                console.log("Parsing Combined Payroll Data...");
                processedData.payroll = parseTsvData("Payroll", finalPayrollToParse, payrollHeaders);
                console.log(`---> Parsed ${processedData.payroll.length} payroll rows.`);
                 if (processedData.payroll.length > 0) console.log("First Payroll Row (JS Props):", Object.keys(processedData.payroll[0]));


                if (processedData.sales.length === 0 && processedData.purchasesExpenses.length === 0 && processedData.payroll.length === 0 && (finalSalesToParse.trim() || finalPurchasesToParse.trim() || finalPayrollToParse.trim()) ) {
                     alert(`Data parsing complete, but no valid data rows were found.\nPlease check input data format.\n\n- If loading cumulative data, ensure current month's pasted data has NO headers.\n- If starting fresh, ensure pasted data has headers as the first line.`);
                     parseSuccess = false;
                 }
                else if (processedData.sales.length > 0 || processedData.purchasesExpenses.length > 0 || processedData.payroll.length > 0) {
                    alert(`Data parsing complete. Found: ${processedData.sales.length} Sales, ${processedData.purchasesExpenses.length} Purch/Exp, ${processedData.payroll.length} Payroll rows. Results ready in Returns/Reports tabs.`);
                }
                else {
                     console.log("No data input or loaded for parsing.");
                     alert(`No data was available to parse. Please input or load data.`);
                     parseSuccess = false;
                }

            }
            catch (error) {
                console.error("!!! CRITICAL Parsing error:", error);
                alert(`CRITICAL PARSING ERROR: ${error.message}. Check console and ensure data format/headers match the examples exactly (tab-separated). App may be unstable.`);
                processedData = { sales: [], purchasesExpenses: [], payroll: [], employeeDb: [] };
                parseSuccess = false;
            }
            finally {
                console.log("--- Parsing END ---");
            }	

            if(parseSuccess) {
                showMainTab('returns-content');
                console.log('Switched to Returns tab.');
            } else {
                console.warn('Parsing failed or yielded no data. Staying on Input Data tab.');
            }
        });

        // Initialize
        if(saveDataYearInput) saveDataYearInput.value = new Date().getFullYear();
        populateIndustryDatalist();
        handleTaxSettingsChange();
        showMainTab('settings-content');
        console.log("App Initialized.");

    </script>

</body>
</html>